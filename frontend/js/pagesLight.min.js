/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */


"use strict";

(function(exports){
    
    var root = ".enter-tab ";
    var url = window.location.href.substring(0, window.location.href.lastIndexOf('/')+1);
    
    exports.init = function () {
        $(document.forms['login-form']).on('submit', submit);
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {

    };
            
    var submit = function() {
        var form = $(this);

        $('.error', form).html('');
//        $(":submit", form).button("loading");

        var request = $.ajax({
            url : url + "login",
            method : "POST",
            data : form.serialize(),
            complete : function() {
                $(":submit", form).button("reset");
            },
//             statusCode : {
//                 200 : function() {
//                 },
//                 403 : function(jqXHR) {
//                     var error = JSON.parse(jqXHR.responseText);
//                     $('.error', form).html(error.message);
//                 }
//             }
        });
        request.done(function(data) {
//             //window.location.href = "/chat";
//             window.location.href = "/nims.html";
            window.location.href = url + "page.html";
        });
        
        request.fail(function(errorInfo, textStatus, errorThrown) {
            var msg;
            try {
                msg = Utils.handleErrorMsg(JSON.parse(errorInfo.responseText));
            } catch(err){
                msg = Utils.handleErrorMsg(errorInfo.responseText || textStatus || 'error');
            }
//             var error = JSON.parse(jqXHR.responseText);
//             $('.error', form).html(error.message); 
//            $('.error', form).html(textStatus); 
            $('.error', form).html(msg); 
        });
        
        return false;
    };
    
})(this['Enter']={});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

var ShopManagement = {};

var ShopManagementTmpl = (function(exports, enableShopSelect, shopShopWindow){
    
    var root = '.shop-management-tab ';
    var categoryRoot = root + '.category-management ';
    var localAssetRoot = root + '.local-asset-management ';
    var categoryContentRoot = root + '.category-content-management ';
    var state = {};

    exports.init = function() {
        state.views = {};
        var nav = root + ".sub-tab-navigation";
        var content = root + ".sub-tab-content";
        var containers = {
            root: state,
            navigation: queryEl(nav),
            content: queryEl(content)
        };
        Utils.addView(containers, "category-content-management", CategoryContentManagement, {mainPage:true});
        Utils.addView(containers, "local-asset-profile", LocalAssetProfile);
        Utils.addView(containers, "global-asset-profile", GlobalAssetProfile);
        if(shopShopWindow){
            Utils.addView(containers, "shop-window", ShopWindow);
        }
        
        listen(queryEl(categoryRoot + ".create-entity-button"),"click", createCategory);
        listen(queryEl(categoryRoot + ".rename-entity-button"),"click", renameCategory);
        listen(queryEl(categoryRoot + ".remove-entity-button"),"click", removeCategory);
        
        listen(queryEl(localAssetRoot + ".create-entity-button"),"click", createLocalAsset);
        listen(queryEl(localAssetRoot + ".rename-entity-button"),"click", renameLocalAsset);
        listen(queryEl(localAssetRoot + ".remove-entity-button"),"click", removeLocalAsset);
        
        ShopManagement.getCurrentShopName = () => state.shopName;
        
        if(enableShopSelect){
            $(root + ".shop-select").select2().on("change", buildContentDelegate);
        }
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {
        if(enableShopSelect){
            clearEl(queryEl(root + ".shop-select"));
            
            PermissionInformer.getEntityNamesArray('shop', true, function(err, entityNames){
                if(err) {Utils.handleError(err); return;}
                
                var data = getSelect2Data(entityNames);
                if(entityNames.length > 0){
                    if(state.shopName != undefined && R.contains(state.shopName, entityNames.map(R.prop('value')))){
                        $(root + ".shop-select").select2(data).val(state.shopName).trigger('change');
                    } else {
                        $(root + ".shop-select").select2(data).val(entityNames[0].value).trigger('change');
                    }
                } else {
                    $(root + ".shop-select").select2(data);
                }
            });
        } else {
            DBMS.getShopName(function(err, shopName){
                if(err) {Utils.handleError(err); return;}
                state.shopName = shopName;
                buildContent(shopName);
            });
        }
    };
    
    var buildContentDelegate = (event) => buildContent(event.target.value);
    
    exports.getCurrentShopName = () => state.shopName;
    
    var buildContent = (shopName) => {
        state.shopName = shopName;
        DBMS.getShop(shopName, function(err, shopData){
            if(err) {Utils.handleError(err); return;}
            
            var data = arr2Select2(R.keys(shopData.categories).sort(CommonUtils.charOrdA));
            clearEl(queryEl(categoryRoot + ".rename-entity-select"));
            $(categoryRoot + ".rename-entity-select").select2(data);
            clearEl(queryEl(categoryRoot + ".remove-entity-select"));
            $(categoryRoot + ".remove-entity-select").select2(data);
            
            data = arr2Select2(R.keys(shopData.localAssets).sort(CommonUtils.charOrdA));
            clearEl(queryEl(localAssetRoot + ".rename-entity-select"));
            $(localAssetRoot + ".rename-entity-select").select2(data);
            clearEl(queryEl(localAssetRoot + ".remove-entity-select"));
            $(localAssetRoot + ".remove-entity-select").select2(data);
            
            state.currentView.refresh();
//            DBMS.getShopIndex(shopName, function(err, index){
//                if(err) {Utils.handleError(err); return;}
//                addEl(clearEl(queryEl(root + ".third-panel")), setAttr(addEl(makeEl('h2'), makeText(index)), 'style', 'text-align: center;'));
//            });
        });
        
    };
    
    var createCategory = function () {
        var input = queryEl(categoryRoot + ".create-entity-input");
        DBMS.createCategory(state.shopName, input.value.trim(), Utils.processError(function(){
            input.value = '';
            exports.refresh();
        }));
    };
    
    var renameCategory = function () {
        var toInput = queryEl(categoryRoot + ".rename-entity-input");
        var fromName = queryEl(categoryRoot + ".rename-entity-select").value.trim();
        var toName = toInput.value.trim();
        DBMS.renameCategory(state.shopName, fromName, toName, function(err){
            if(err) {Utils.handleError(err); return;}
            toInput.value = '';
            exports.refresh();
        });
    };
    
    var removeCategory = function () {
        var name = queryEl(categoryRoot + ".remove-entity-select").value.trim();
        Utils.confirm(strFormat(getL10n('shop-confirm-category-remove'), [name]), () => {
            DBMS.removeCategory(state.shopName, name, Utils.processError(exports.refresh));
        });
    };
    
    var createLocalAsset = function () {
        var input = queryEl(localAssetRoot + ".create-entity-input");
        DBMS.createLocalAsset(state.shopName, input.value.trim(), Utils.processError(function(){
            input.value = '';
            exports.refresh();
        }));
    };
    
    var renameLocalAsset = function () {
        var toInput = queryEl(localAssetRoot + ".rename-entity-input");
        var fromName = queryEl(localAssetRoot + ".rename-entity-select").value.trim();
        var toName = toInput.value.trim();
        DBMS.renameLocalAsset(state.shopName, fromName, toName, function(err){
            if(err) {Utils.handleError(err); return;}
            toInput.value = '';
            exports.refresh();
        });
    };
    
    var removeLocalAsset = function () {
        var name = queryEl(localAssetRoot + ".remove-entity-select").value.trim();
        Utils.confirm(strFormat(getL10n('shop-confirm-local-asset-remove'), [name]), () => {
            DBMS.removeLocalAsset(state.shopName, name, Utils.processError(exports.refresh));
        });
    };

});

ShopManagementTmpl(this['MasterShopManagement']={}, true, true);

ShopManagementTmpl(this['PlayerShopManagement']={}, false, false);

//(this['ShopManagement']={});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

(function(exports){
    
    var root = '.shop-window-tab ';
    var state = {};
    var l10n = L10n.get('shop');

    exports.init = function() {
//        listen(queryEl(root + '.refreshButton'), 'click', exports.refresh);
//        queryEls(root + '.discount-button').map(listen(R.__, 'click', (event)=>{
////            state.discount = Number(getAttr(event.target, 'value'));
//            updateFinalCost();
//        }));
        checkForQR();
        listen(queryEl(root + ".amount-input"), 'change', onAmountChange);
        listen(queryEl(root + ".buy-button"), 'click', onBuy);
        listen(queryEl(root + ".start-qr-read"), 'click', readQR);
        
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {
        var shopName = ShopManagement.getCurrentShopName();
        DBMS.getShop(shopName, function(err, shopData){
            if(err) {Utils.handleError(err); return;}
            state.shopData = shopData;
            var categoryList  = R.keys(state.shopData.categories).sort(CommonUtils.charOrdA);
            
            var catSelect = clearEl(queryEl(root + ".category-select"));
            clearEl(queryEl(root + ".asset-select"));
            
            
            var catBtns = categoryList.map( name => {
                var btn = addEl(makeEl('button'), makeText(name));
                addClass(btn, 'select-button');
                btn.catName = name;
                listen(btn, "click", onCategorySelect);
                return btn;
            });
            addEls(catSelect, catBtns);
            if(catBtns.length > 0) onCategorySelect({target:catBtns[0]});
        });
    };

    var makeBtn = R.curry((catName, el) => {
        var btn = addEl(makeEl('button'), makeText(el.dispName));
        addClass(btn, 'select-button');
        btn.name = el.name;
        btn.catName = catName;
        btn.assetType = el.type;
        listen(btn, "click", onAssetSelect);
        return btn;
    });
    
    var onCategorySelect = (event) => {
        queryEls(root + ".category-select > button").map(removeClass(R.__, 'active'));
        addClass(event.target, 'active');
        var catName = event.target.catName;
        var category = state.shopData.categories[catName];
        
        clearEl(queryEl(root + ".asset-info"));
        addClass(queryEl(root + ".buy-controls"), 'hidden');
        var assetSelect = clearEl(queryEl(root + ".asset-select"));
        
        var arr = R.keys(category.globals).map(R.pair(R.__, 'global'));
        arr = R.concat(arr, R.keys(category.locals).map(R.pair(R.__, 'local')));

        DBMS.getGlobalAssetDisplayNames( (err, globalDisplayNames) => {
            if(err) {Utils.handleError(err); return;}
            
            arr = arr.map(el => {
                if(el[1] === 'global'){
                    var dispName = globalDisplayNames[el[0]].displayString;
                } else {
                    var dispName = state.shopData.localAssets[el[0]].displayString;
                }
                return {
                    name: el[0],
                    type: el[1],
                    dispName: dispName.trim() === '' ? el[0] : dispName
                }
            }).sort(CommonUtils.charOrdAFactory(R.prop('dispName')));
            
            addEls(assetSelect, arr.map(makeBtn(catName)))
        });
    };
    
    var onAssetSelect = (event) => {
        queryEls(root + ".asset-select > button").map(removeClass(R.__, 'active'));
        addClass(event.target, 'active');
        removeClass(queryEl(root + ".buy-controls"), 'hidden');
        queryEl('.customer-login').value = '';
        queryEl('.customer-password').value = '';
        state.curAsset = {
            name : event.target.name ,
            catName : event.target.catName ,
            assetType : event.target.assetType 
        };
        showAssetInfo();
    };
    
    var showAssetInfo = () => {
        var set = state.curAsset.assetType === 'local' ? 'locals' : 'globals';
        var cost = state.shopData.categories[state.curAsset.catName][set][state.curAsset.name].cost;
        state.cost = cost;
        queryEl(root + ".final-cost-input").value = cost;
//        state.discount = 0;
        if(state.curAsset.assetType === 'local'){
            state.assetData = state.shopData.localAssets[state.curAsset.name];
            renderAssetInfo();
        } else {
            DBMS.getAsset(state.curAsset.name, (err, assetData) => {
                if(err) {Utils.handleError(err); return;}
                state.assetData = assetData;
                renderAssetInfo();
            });
        }
    };
    
    var renderAssetInfo = () => {
        var info = clearEl(queryEl(root + ".asset-info"));
        var displayName = state.assetData.displayString.trim() !== '' ? state.assetData.displayString : state.curAsset.name;
        addEl(info, addEl(makeEl('h2'), makeText(displayName)));
        addEl(info, addEl(makeEl('span'), makeText(state.assetData.description)));
        addEl(clearEl(queryEl(root + ".initial-cost-value")), makeText(state.cost));

        setClassByCondition(queryEl(root + ".activation-codes-container"), 'hidden', !state.assetData.isPhysical);
        setClassByCondition(queryEl(root + ".qr-reader"), 'hidden', !(state.assetData.isPhysical && state.isCanvasOk));
        var amount = clearEl(queryEl(root + ".amount-input"));
        amount.value = 1;
        if(state.assetData.isPhysical){
            delAttr(amount, 'disabled');
        } else {
            setAttr(amount, 'disabled', 'disabled');
        }
        onAmountChange({target: amount});
    };
    
    var onAmountChange = (event) => {
        var num = Number(event.target.value);
        var el = clearEl(queryEl(root + ".activation-codes"));
        if(num < 1) num = 1;
        if(num > 10) num = 10;
        addEls(el, R.repeat(1, num).map(val => {
//            return setAttr(makeEl('input'), 'type', 'number');
            return addClasses(makeEl('input'), ['form-control','qr-code-input']);
        }));
    };
    
    var onBuy = () => {
        var shopName = ShopManagement.getCurrentShopName();
        var cost = Number(queryEl(root + ".final-cost-input").value);
        var customerLogin = queryEl('.customer-login').value;
        var customerPassword = queryEl('.customer-password').value;
        var opts = {
            amount: Number(queryEl(root + ".amount-input").value)
        };
        if(state.assetData.isPhysical){
            var values = queryEls(root + ".activation-codes input").map(R.compose(R.trim, R.prop('value')));
            if(values.some(R.isEmpty)){
                Utils.alert(l10n('not-all-activation-codes-are-full'));
                return;
            }
            opts.codes = values;
        }
        DBMS.buyAsset(shopName, state.curAsset.name, state.curAsset.assetType, cost, customerLogin, customerPassword, opts, function(err){
            if(err) {Utils.handleError(err); return;}
            queryEl('.customer-login').value = '';
            queryEl('.customer-password').value = '';
            Utils.alert(l10n('on-purchase-success'));
        });
    };
    
    var checkForQR = () => {
        function isCanvasSupported(){
          var elem = document.createElement('canvas');
          return !!(elem.getContext && elem.getContext('2d'));
        }
        state.isCanvasOk = isCanvasSupported() && window.File && window.FileReader;
    };
    
    var readQR = () => {
        qrcode.callback = read;
        qrcode.customCanvas = queryEl(root + ".qr-canvas");
        var video = setAttr(makeEl('video'), 'autoplay','autoplay');
        addEl(clearEl(queryEl(root + ".video")), video);
        qrcode.setWebcam(video);
    };
    
    var read = (a) => {
        console.log('read called');
        console.log(a);
        queryEl(root + ".video video").pause();
        clearEl(queryEl(root + ".video"));
        
        var request = $.ajax({
//            url : 'http://dev.alice.digital:8159/decode?content=' + a,
            url : 'https://alice.digital/app/qr/decode?content=' + a,
            dataType : "text",
            method : "GET",
            contentType : "application/json;charset=utf-8",
            cache: false,
            timeout: Constants.httpTimeout,
        });
        
        request.done(function(data) {
            data = JSON.parse(data);
            var length = data.payload.length;
            var payload = data.payload.substring(length-6, length);
            var values = queryEls(root + ".activation-codes input").map(R.compose(R.trim, R.prop('value')));
            if(R.contains(payload, values)){
                Utils.alert(l10n('this-qr-code-already-used-in-inputs'));
                return;
            }
            var inputs = queryEls(root + ".activation-codes input").filter(R.compose(R.isEmpty, R.trim, R.prop('value')));
            if(inputs.length > 0){
                inputs[0].value = data.payload.substring(length-6, length);
            } else {
                Utils.alert(l10n('all-activation-codes-are-full'));
            }
        });
        
        request.fail(function(errorInfo, textStatus, errorThrown) {
            Utils.alert(errorInfo.responseText || textStatus || 'error');
        });
    };
    

})(this['ShopWindow']={});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

(function(exports){
    
    var root = '.shop-about-tab ';
    var state = {};
    var l10n = L10n.get('shop');

    exports.init = function() {
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {
        var shopName = ShopManagement.getCurrentShopName();
        DBMS.getShop(shopName, function(err, shopData){
            if(err) {Utils.handleError(err); return;}
            var body = clearEl(queryEl(root + '.shop-info-table-body'));
            var el1 = addEls(makeEl('tr'), [ addEl(makeEl('td'), addEl(makeEl('span'), makeText(l10n('corporation-name')))),
                                             addEl(makeEl('td'), addEl(makeEl('span'), makeText(shopData.corporation)))])
            var el2 = addEls(makeEl('tr'), [ addEl(makeEl('td'), addEl(makeEl('span'), makeText(l10n('legal-body')))),
                                             addEl(makeEl('td'), addEl(makeEl('span'), makeText(shopData.sellerLogin)))])
            addEls(body, [el1, el2]);
        });
    };

})(this['ShopAbout']={});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

(function(exports){
    
    var root = '.category-content-management-tab ';
    var categoryContentRoot = root + '.category-content-management ';
    var state = {};
    state.sortKey = 0;
    state.sortDir = "asc";

    var headArr = [ 'categoryName',
        'assetName',
        'displayString',
        'cost',
        'type',
        'resourceCost',
        'isPhysical',
        'description' ];

    exports.init = function() {
        listen(queryEl(categoryContentRoot + ".add-entity-button-1"),"click", addGlobalAssetToCategory);
        listen(queryEl(categoryContentRoot + ".add-entity-button-2"),"click", addLocalAssetToCategory);
        listen(queryEl(categoryContentRoot + ".remove-entity-button-1"),"click", removeGlobalAssetFromCategory);
        listen(queryEl(categoryContentRoot + ".remove-entity-button-2"),"click", removeLocalAssetFromCategory);
        
        initSortIcons();
        queryEls(categoryContentRoot + "thead tr input").map(listen(R.__, 'input', exports.refresh));
        
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {
        var shopName = ShopManagement.getCurrentShopName();
        DBMS.getShop(shopName, function(err, shopData){
            if(err) {Utils.handleError(err); return;}
            
            var data = arr2Select2(R.keys(shopData.categories).sort(CommonUtils.charOrdA));
            
            clearEl(queryEl(categoryContentRoot + ".add-entity-select-12"));
            $(categoryContentRoot + ".add-entity-select-12").select2(data);
            
            clearEl(queryEl(categoryContentRoot + ".add-entity-select-22"));
            $(categoryContentRoot + ".add-entity-select-22").select2(data);

            var globalAssets = arr2Select2(R.keys(shopData.assets));
//            globalAssets.placeholder = "Select an option";
            clearEl(queryEl(categoryContentRoot + ".add-entity-select-11"));
            $(categoryContentRoot + ".add-entity-select-11").select2((globalAssets));
            
            var localAssets = arr2Select2(R.keys(shopData.localAssets));
            clearEl(queryEl(categoryContentRoot + ".add-entity-select-21"));
            $(categoryContentRoot + ".add-entity-select-21").select2((localAssets));
            
            var getList = (container) => {
                return R.unnest(R.keys(shopData.categories).map(categoryName => {
                    return R.keys(shopData.categories[categoryName][container]).map(assetName => [categoryName, assetName])
                }));
            }
            var assets = getList('globals').map( arr => R.zipObj(['displayName','value'], [arr[0] + '/' + arr[1], JSON.stringify(arr)]));
            assets.sort(CommonUtils.charOrdAFactory(R.prop('displayName')))
            clearEl(queryEl(categoryContentRoot + ".remove-entity-select-1"));
            $(categoryContentRoot + ".remove-entity-select-1").select2(getSelect2Data(assets));
            
            var assets = getList('locals').map( arr => R.zipObj(['displayName','value'], [arr[0] + '/' + arr[1], JSON.stringify(arr)]));
            assets.sort(CommonUtils.charOrdAFactory(R.prop('displayName')))
            clearEl(queryEl(categoryContentRoot + ".remove-entity-select-2"));
            $(categoryContentRoot + ".remove-entity-select-2").select2(getSelect2Data(assets));
            
            fillShopTable(shopData);
        });
    };
    
    var initSortIcons = () => {
        var icons = queryEls(categoryContentRoot + "thead tr.first-row th");
        icons.map((icon, i) => {
            icon.index = i;
            listen(icon, "click", onSortChange);
        });
    };
    
    var onSortChange = function (event) {
        var target = event.target;
        if(target.tagName.toLowerCase() === "span"){
            target = target.parentElement;
        }
        
        if (state.sortKey === target.index) {
            state.sortDir = state.sortDir === "asc" ? "desc" : "asc";
            setClassByCondition(target, 'sortDesc', state.sortDir === 'desc');
            setClassByCondition(target, 'sortAsc', state.sortDir === 'asc');
        } else {
            var filterHead = queryEl(categoryContentRoot + "thead");
            nl2array(filterHead.getElementsByClassName("sortAsc")).forEach(removeClass(R.__, "sortAsc"));
            nl2array(filterHead.getElementsByClassName("sortDesc")).forEach(removeClass(R.__, "sortDesc"));
            
            state.sortKey = target.index;
            state.sortDir = "asc";
            addClass(target, "sortAsc");
        }
        exports.refresh();
    };
    
    var data2str = (data) => {
        if(data.cost !== -1){
            var input = addClass(makeEl('input'),'form-control');
            setAttr(input, 'type', 'number');
            setAttr(input, 'min', '0');
            input.value = data.cost;
            listen(input, "change", (event) => {
                DBMS.setAssetCost(ShopManagement.getCurrentShopName(), data.type, data.categoryName, data.assetName, Number(event.target.value), Utils.processError());
            });
        } else {
            input = makeText('');
        }
        return addEls(makeEl('tr'), [addEl(makeEl('td'), makeText(data.categoryName)),
                addEl(makeEl('td'), makeText(data.assetName)),
                addEl(makeEl('td'), makeText(data.displayString)),
                addEl(makeEl('td'), input),
//                addEl(makeEl('td'), makeText(data.cost)),
                addEl(makeEl('td'), makeText(data.type)),
                addEl(makeEl('td'), makeText(data.resourceCost)),
                addEl(makeEl('td'), makeText(data.isPhysical ? L10n.get('constant', 'yes') : '')),
                addEl(makeEl('td'), makeText(data.description))]);
    };
    
    var fillShopTable = (shopData) => {
        var table = clearEl(queryEl(categoryContentRoot + "tbody.table-content"));
        var data = R.unnest(R.keys(shopData.categories).map(categoryName => {
            var globals = shopData.categories[categoryName].globals;
            var data = R.keys(globals).map(global => {
                return {
                    categoryName: categoryName,
                    assetName: global,
                    displayString: shopData.globalAssets[global].displayString,
                    cost: globals[global].cost,
                    type: 'global',
                    resourceCost: shopData.globalAssets[global].resourceCost,
                    isPhysical: shopData.globalAssets[global].isPhysical,
                    description: shopData.globalAssets[global].description,
                }
            });
            
            var locals = shopData.categories[categoryName].locals;
            data = data.concat(R.keys(locals).map(local => {
                return {
                    categoryName: categoryName,
                    assetName: local,
                    displayString: shopData.localAssets[local].displayString,
                    cost: locals[local].cost,
                    type: 'local',
                    resourceCost: 0,
                    isPhysical: false,
                    description: shopData.localAssets[local].description,
                }
            }));
            
            return data;
        }));
        var usedGlobals = R.uniq(R.flatten(R.keys(shopData.categories).map(categoryName => R.keys(shopData.categories[categoryName].globals))));
        var usedLocals = R.uniq(R.flatten(R.keys(shopData.categories).map(categoryName => R.keys(shopData.categories[categoryName].locals))));
        var allGlobals = R.keys(shopData.assets);
        var allLocals = R.keys(shopData.localAssets);
        
        data = R.concat(data, R.difference(allGlobals, usedGlobals).map(global => {
            return {
                categoryName: L10n.get('shop','not-in-category'),
                assetName: global,
                displayString: shopData.globalAssets[global].displayString,
                cost: -1,
                type: 'global',
                resourceCost: shopData.globalAssets[global].resourceCost,
                isPhysical: shopData.globalAssets[global].isPhysical,
                description: shopData.globalAssets[global].description,
            }
        }));
        data = R.concat(data, R.difference(allLocals, usedLocals).map(local => {
            return {
                categoryName: L10n.get('shop','not-in-category'),
                assetName: local,
                displayString: shopData.localAssets[local].displayString,
                cost: -1,
                type: 'local',
                resourceCost: 0,
                isPhysical: false,
                description: shopData.localAssets[local].description,
            }
        }));

        var sortFunc = CommonUtils.charOrdAFactoryBase(state.sortDir, function(a){
            var value = a[headArr[state.sortKey]]; 
            if(R.is(String, value)){
                value = value.toLowerCase();
            }
            return value;
        });
        addEls(table, data.filter(makeFilterFunc()).sort(sortFunc).map(data2str));
    };
    
    var makeFilterFunc = () => {
        var values = queryEls(categoryContentRoot + "thead tr input").map(R.prop('value'));
        return function(data){
            return headArr.every((el, index) => {
                if(values[index].trim() === ''){
                    return true;
                }
                return String(data[headArr[index]]).toLowerCase().indexOf(String(values[index]).toLowerCase()) != -1;
            })
        };
    };
    
    var addGlobalAssetToCategory = ()=>{
        var asset = queryEl(categoryContentRoot + ".add-entity-select-11").value.trim();
        var category = queryEl(categoryContentRoot + ".add-entity-select-12").value.trim();
        DBMS.addGlobalAssetToCategory(ShopManagement.getCurrentShopName(), category, asset, Utils.processError(exports.refresh));
    };
    var addLocalAssetToCategory = ()=>{
        var asset = queryEl(categoryContentRoot + ".add-entity-select-21").value.trim();
        var category = queryEl(categoryContentRoot + ".add-entity-select-22").value.trim();
        DBMS.addLocalAssetToCategory(ShopManagement.getCurrentShopName(), category, asset, Utils.processError(exports.refresh));
    };
    var removeGlobalAssetFromCategory = ()=>{
        var arr = JSON.parse(queryEl(categoryContentRoot + ".remove-entity-select-1").value.trim());
        DBMS.removeGlobalAssetFromCategory(ShopManagement.getCurrentShopName(), arr[0], arr[1], Utils.processError(exports.refresh));
    };
    var removeLocalAssetFromCategory = ()=>{
        var arr = JSON.parse(queryEl(categoryContentRoot + ".remove-entity-select-2").value.trim());
        DBMS.removeLocalAssetFromCategory(ShopManagement.getCurrentShopName(), arr[0], arr[1], Utils.processError(exports.refresh));
    };

})(this['CategoryContentManagement']={});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

var AssetProfileTmpl = (function(exports, root, assetProfileStructure, isEditable, getAssetNames, updateAssetField, getAsset){
    
    var state = {};
    var l10n = L10n.get('asset');

    exports.init = function() {
        listen(queryEl(root +".entity-selector"), "change", showProfileInfoDelegate);
        
        var tbody = clearEl(queryEl(root + ".entity-profile"));
        
        state.inputItems = {};
        
        Constants[assetProfileStructure].forEach(function (profileSettings) {
            profileSettings.displayName = l10n(profileSettings.name);
            addEl(tbody, makeInput(profileSettings));
        });
        
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {
        getAssetNames(function(err, names){
            if(err) {Utils.handleError(err); return;}
            var sel = clearEl(queryEl(root + ".entity-selector"));
            fillSelector(sel, names.map(remapProps4Select));
        });
    };
    
    var makeInput = function (profileItemConfig) {
        var span = setAttr(makeEl('span'), "l10n-id", "asset-" + profileItemConfig.name);
        var tr = addEl(makeEl("tr"), addEl(makeEl('td'), addEl(span, makeText(profileItemConfig.displayName))))
        var input;
        switch (profileItemConfig.type) {
        case "text":
            input = makeEl("textarea");
            addClass(input, "profileTextInput");
            addClass(input,'form-control');
            break;
        case "string":
            input = makeEl("input");
            addClass(input, "profileStringInput");
            addClass(input,'form-control');
            break;
        case "number":
            input = makeEl("input");
            input.type = "number";
            addClass(input,'form-control');
            break;
        case "checkbox":
            input = makeEl("input");
            input.type = "checkbox";
            break;
        default:
            throw new Error('Unexpected type ' + profileItemConfig.type);
        }
        input.selfName = profileItemConfig.name;
        
        if(!isEditable){
            setAttr(input, 'disabled', 'true');
        }
//        addClass(input,"isGroupEditable");
        state.inputItems[profileItemConfig.name] = input;
        
        listen(input, "change", updateFieldValue(profileItemConfig.type));
    
        return addEl(tr, addEl(makeEl('td'), input));
    };
    
    var updateFieldValue = function(type){
        return function(event){
            var fieldName = event.target.selfName;
            var assetName = state.name;
            
            var value;
            switch(type){
            case "text":
            case "string":
                value = event.target.value;
                break;
            case "number":
                if (isNaN(event.target.value)) {
                    Utils.alert(getL10n("profiles-not-a-number"));
                    event.target.value = event.target.oldValue;
                    return;
                }
                value = Number(event.target.value);
                break;
            case "checkbox":
                value = event.target.checked;
                break;
            default:
                throw new Error('Unexpected type ' + type);
            }
            updateAssetField(assetName, fieldName, value, Utils.processError());
        }
    };
    
    var showProfileInfoDelegate = function (event) {
        var name = event.target.value.trim();
        getAsset(name, showProfileInfoCallback);
    };
    
    var showProfileInfoCallback = function (err, asset) {
        if(err) {Utils.handleError(err); return;}
        var name = asset.name;
        state.name = name;
        var inputItems = state.inputItems;
        Object.keys(inputItems).forEach(function (inputName) {
            if (inputItems[inputName].type === "checkbox") {
                inputItems[inputName].checked = asset[inputName];
            } else {
                inputItems[inputName].value = asset[inputName];
            }
            inputItems[inputName].oldValue = asset[inputName];
        });
    };
    
});

AssetProfileTmpl(this['AssetProfile']={}, '.asset-profile-tab ', 'assetProfileStructure', true, (callback) => {
    PermissionInformer.getEntityNamesArray('asset', false, callback);
}, (assetName, fieldName, value, callback) => {
    DBMS.updateAssetField(assetName, fieldName, value, callback);
}, (name, callback) => {
    DBMS.getAsset(name, callback);
});

AssetProfileTmpl(this['GlobalAssetProfile']={}, '.global-asset-profile-tab ', 'assetProfileStructure', false, (callback) => {
    var shopName = ShopManagement.getCurrentShopName();
    DBMS.getShop(shopName, function(err, shopData){
        if(err) {callback(err); return;}
        var assets = R.keys(shopData.assets).sort(CommonUtils.charOrdA).map(name => {
            return {
                displayName: name,
                value: name
            }
        });
        callback(null,assets);
    });
}, (assetName, fieldName, value, callback) => {
    Utils.alert(getL10n('errors-unsupported-operation'));
}, (name, callback) => {
    DBMS.getAsset(name, callback);
});

AssetProfileTmpl(this['LocalAssetProfile']={}, '.local-asset-profile-tab ', 'localAssetProfileStructure', true, (callback) => {
    var shopName = ShopManagement.getCurrentShopName();
    DBMS.getShop(shopName, function(err, shopData){
        if(err) {callback(err); return;}
        var localAssets = R.keys(shopData.localAssets).sort(CommonUtils.charOrdA).map(name => {
            return {
                displayName: name,
                value: name
            }
        });
        callback(null,localAssets);
    });
}, (assetName, fieldName, value, callback) => {
    DBMS.updateLocalAssetField(ShopManagement.getCurrentShopName(), assetName, fieldName, value, callback);
}, (name, callback) => {
    DBMS.getLocalAsset(ShopManagement.getCurrentShopName(), name, (err, asset) => {
        if(err) {callback(err); return;}
        asset.name = name;
        callback(null, asset);
    });
});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

var About = {};

About.init = function() {
    "use strict";

    About.content = getEl('aboutDiv');
};

About.refresh = function() {
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzL3BhZ2VzL2VudGVyLmpzIiwianMvcGFnZXMvZGV1c2V4L3Nob3BNYW5hZ2VtZW50LmpzIiwianMvcGFnZXMvZGV1c2V4L3Nob3BXaW5kb3cuanMiLCJqcy9wYWdlcy9kZXVzZXgvc2hvcEFib3V0LmpzIiwianMvcGFnZXMvZGV1c2V4L2NhdGVnb3J5Q29udGVudE1hbmFnZW1lbnQuanMiLCJqcy9wYWdlcy9kZXVzZXgvYXNzZXRQcm9maWxlLmpzIiwianMvcGFnZXMvbG9ncy9hYm91dC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDL0VBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDakxBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN2UEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzNDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdlBBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3pMQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJwYWdlc0xpZ2h0Lm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcblxyXG5cInVzZSBzdHJpY3RcIjtcclxuXHJcbihmdW5jdGlvbihleHBvcnRzKXtcclxuICAgIFxyXG4gICAgdmFyIHJvb3QgPSBcIi5lbnRlci10YWIgXCI7XHJcbiAgICB2YXIgdXJsID0gd2luZG93LmxvY2F0aW9uLmhyZWYuc3Vic3RyaW5nKDAsIHdpbmRvdy5sb2NhdGlvbi5ocmVmLmxhc3RJbmRleE9mKCcvJykrMSk7XHJcbiAgICBcclxuICAgIGV4cG9ydHMuaW5pdCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAkKGRvY3VtZW50LmZvcm1zWydsb2dpbi1mb3JtJ10pLm9uKCdzdWJtaXQnLCBzdWJtaXQpO1xyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSBmdW5jdGlvbigpIHtcclxuXHJcbiAgICB9O1xyXG4gICAgICAgICAgICBcclxuICAgIHZhciBzdWJtaXQgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICB2YXIgZm9ybSA9ICQodGhpcyk7XHJcblxyXG4gICAgICAgICQoJy5lcnJvcicsIGZvcm0pLmh0bWwoJycpO1xyXG4vLyAgICAgICAgJChcIjpzdWJtaXRcIiwgZm9ybSkuYnV0dG9uKFwibG9hZGluZ1wiKTtcclxuXHJcbiAgICAgICAgdmFyIHJlcXVlc3QgPSAkLmFqYXgoe1xyXG4gICAgICAgICAgICB1cmwgOiB1cmwgKyBcImxvZ2luXCIsXHJcbiAgICAgICAgICAgIG1ldGhvZCA6IFwiUE9TVFwiLFxyXG4gICAgICAgICAgICBkYXRhIDogZm9ybS5zZXJpYWxpemUoKSxcclxuICAgICAgICAgICAgY29tcGxldGUgOiBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgICQoXCI6c3VibWl0XCIsIGZvcm0pLmJ1dHRvbihcInJlc2V0XCIpO1xyXG4gICAgICAgICAgICB9LFxyXG4vLyAgICAgICAgICAgICBzdGF0dXNDb2RlIDoge1xyXG4vLyAgICAgICAgICAgICAgICAgMjAwIDogZnVuY3Rpb24oKSB7XHJcbi8vICAgICAgICAgICAgICAgICB9LFxyXG4vLyAgICAgICAgICAgICAgICAgNDAzIDogZnVuY3Rpb24oanFYSFIpIHtcclxuLy8gICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBKU09OLnBhcnNlKGpxWEhSLnJlc3BvbnNlVGV4dCk7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgJCgnLmVycm9yJywgZm9ybSkuaHRtbChlcnJvci5tZXNzYWdlKTtcclxuLy8gICAgICAgICAgICAgICAgIH1cclxuLy8gICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJlcXVlc3QuZG9uZShmdW5jdGlvbihkYXRhKSB7XHJcbi8vICAgICAgICAgICAgIC8vd2luZG93LmxvY2F0aW9uLmhyZWYgPSBcIi9jaGF0XCI7XHJcbi8vICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gXCIvbmltcy5odG1sXCI7XHJcbiAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gdXJsICsgXCJwYWdlLmh0bWxcIjtcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICByZXF1ZXN0LmZhaWwoZnVuY3Rpb24oZXJyb3JJbmZvLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikge1xyXG4gICAgICAgICAgICB2YXIgbXNnO1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgbXNnID0gVXRpbHMuaGFuZGxlRXJyb3JNc2coSlNPTi5wYXJzZShlcnJvckluZm8ucmVzcG9uc2VUZXh0KSk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2goZXJyKXtcclxuICAgICAgICAgICAgICAgIG1zZyA9IFV0aWxzLmhhbmRsZUVycm9yTXNnKGVycm9ySW5mby5yZXNwb25zZVRleHQgfHwgdGV4dFN0YXR1cyB8fCAnZXJyb3InKTtcclxuICAgICAgICAgICAgfVxyXG4vLyAgICAgICAgICAgICB2YXIgZXJyb3IgPSBKU09OLnBhcnNlKGpxWEhSLnJlc3BvbnNlVGV4dCk7XHJcbi8vICAgICAgICAgICAgICQoJy5lcnJvcicsIGZvcm0pLmh0bWwoZXJyb3IubWVzc2FnZSk7IFxyXG4vLyAgICAgICAgICAgICQoJy5lcnJvcicsIGZvcm0pLmh0bWwodGV4dFN0YXR1cyk7IFxyXG4gICAgICAgICAgICAkKCcuZXJyb3InLCBmb3JtKS5odG1sKG1zZyk7IFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH07XHJcbiAgICBcclxufSkodGhpc1snRW50ZXInXT17fSk7IiwiLypDb3B5cmlnaHQgMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG52YXIgU2hvcE1hbmFnZW1lbnQgPSB7fTtcclxuXHJcbnZhciBTaG9wTWFuYWdlbWVudFRtcGwgPSAoZnVuY3Rpb24oZXhwb3J0cywgZW5hYmxlU2hvcFNlbGVjdCwgc2hvcFNob3BXaW5kb3cpe1xyXG4gICAgXHJcbiAgICB2YXIgcm9vdCA9ICcuc2hvcC1tYW5hZ2VtZW50LXRhYiAnO1xyXG4gICAgdmFyIGNhdGVnb3J5Um9vdCA9IHJvb3QgKyAnLmNhdGVnb3J5LW1hbmFnZW1lbnQgJztcclxuICAgIHZhciBsb2NhbEFzc2V0Um9vdCA9IHJvb3QgKyAnLmxvY2FsLWFzc2V0LW1hbmFnZW1lbnQgJztcclxuICAgIHZhciBjYXRlZ29yeUNvbnRlbnRSb290ID0gcm9vdCArICcuY2F0ZWdvcnktY29udGVudC1tYW5hZ2VtZW50ICc7XHJcbiAgICB2YXIgc3RhdGUgPSB7fTtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICBzdGF0ZS52aWV3cyA9IHt9O1xyXG4gICAgICAgIHZhciBuYXYgPSByb290ICsgXCIuc3ViLXRhYi1uYXZpZ2F0aW9uXCI7XHJcbiAgICAgICAgdmFyIGNvbnRlbnQgPSByb290ICsgXCIuc3ViLXRhYi1jb250ZW50XCI7XHJcbiAgICAgICAgdmFyIGNvbnRhaW5lcnMgPSB7XHJcbiAgICAgICAgICAgIHJvb3Q6IHN0YXRlLFxyXG4gICAgICAgICAgICBuYXZpZ2F0aW9uOiBxdWVyeUVsKG5hdiksXHJcbiAgICAgICAgICAgIGNvbnRlbnQ6IHF1ZXJ5RWwoY29udGVudClcclxuICAgICAgICB9O1xyXG4gICAgICAgIFV0aWxzLmFkZFZpZXcoY29udGFpbmVycywgXCJjYXRlZ29yeS1jb250ZW50LW1hbmFnZW1lbnRcIiwgQ2F0ZWdvcnlDb250ZW50TWFuYWdlbWVudCwge21haW5QYWdlOnRydWV9KTtcclxuICAgICAgICBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsIFwibG9jYWwtYXNzZXQtcHJvZmlsZVwiLCBMb2NhbEFzc2V0UHJvZmlsZSk7XHJcbiAgICAgICAgVXRpbHMuYWRkVmlldyhjb250YWluZXJzLCBcImdsb2JhbC1hc3NldC1wcm9maWxlXCIsIEdsb2JhbEFzc2V0UHJvZmlsZSk7XHJcbiAgICAgICAgaWYoc2hvcFNob3BXaW5kb3cpe1xyXG4gICAgICAgICAgICBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsIFwic2hvcC13aW5kb3dcIiwgU2hvcFdpbmRvdyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGNhdGVnb3J5Um9vdCArIFwiLmNyZWF0ZS1lbnRpdHktYnV0dG9uXCIpLFwiY2xpY2tcIiwgY3JlYXRlQ2F0ZWdvcnkpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGNhdGVnb3J5Um9vdCArIFwiLnJlbmFtZS1lbnRpdHktYnV0dG9uXCIpLFwiY2xpY2tcIiwgcmVuYW1lQ2F0ZWdvcnkpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGNhdGVnb3J5Um9vdCArIFwiLnJlbW92ZS1lbnRpdHktYnV0dG9uXCIpLFwiY2xpY2tcIiwgcmVtb3ZlQ2F0ZWdvcnkpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGxvY2FsQXNzZXRSb290ICsgXCIuY3JlYXRlLWVudGl0eS1idXR0b25cIiksXCJjbGlja1wiLCBjcmVhdGVMb2NhbEFzc2V0KTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChsb2NhbEFzc2V0Um9vdCArIFwiLnJlbmFtZS1lbnRpdHktYnV0dG9uXCIpLFwiY2xpY2tcIiwgcmVuYW1lTG9jYWxBc3NldCk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwobG9jYWxBc3NldFJvb3QgKyBcIi5yZW1vdmUtZW50aXR5LWJ1dHRvblwiKSxcImNsaWNrXCIsIHJlbW92ZUxvY2FsQXNzZXQpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIFNob3BNYW5hZ2VtZW50LmdldEN1cnJlbnRTaG9wTmFtZSA9ICgpID0+IHN0YXRlLnNob3BOYW1lO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmKGVuYWJsZVNob3BTZWxlY3Qpe1xyXG4gICAgICAgICAgICAkKHJvb3QgKyBcIi5zaG9wLXNlbGVjdFwiKS5zZWxlY3QyKCkub24oXCJjaGFuZ2VcIiwgYnVpbGRDb250ZW50RGVsZWdhdGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgaWYoZW5hYmxlU2hvcFNlbGVjdCl7XHJcbiAgICAgICAgICAgIGNsZWFyRWwocXVlcnlFbChyb290ICsgXCIuc2hvcC1zZWxlY3RcIikpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ3Nob3AnLCB0cnVlLCBmdW5jdGlvbihlcnIsIGVudGl0eU5hbWVzKXtcclxuICAgICAgICAgICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIHZhciBkYXRhID0gZ2V0U2VsZWN0MkRhdGEoZW50aXR5TmFtZXMpO1xyXG4gICAgICAgICAgICAgICAgaWYoZW50aXR5TmFtZXMubGVuZ3RoID4gMCl7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoc3RhdGUuc2hvcE5hbWUgIT0gdW5kZWZpbmVkICYmIFIuY29udGFpbnMoc3RhdGUuc2hvcE5hbWUsIGVudGl0eU5hbWVzLm1hcChSLnByb3AoJ3ZhbHVlJykpKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICQocm9vdCArIFwiLnNob3Atc2VsZWN0XCIpLnNlbGVjdDIoZGF0YSkudmFsKHN0YXRlLnNob3BOYW1lKS50cmlnZ2VyKCdjaGFuZ2UnKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkKHJvb3QgKyBcIi5zaG9wLXNlbGVjdFwiKS5zZWxlY3QyKGRhdGEpLnZhbChlbnRpdHlOYW1lc1swXS52YWx1ZSkudHJpZ2dlcignY2hhbmdlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAkKHJvb3QgKyBcIi5zaG9wLXNlbGVjdFwiKS5zZWxlY3QyKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBEQk1TLmdldFNob3BOYW1lKGZ1bmN0aW9uKGVyciwgc2hvcE5hbWUpe1xyXG4gICAgICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgICAgICAgICAgICAgIHN0YXRlLnNob3BOYW1lID0gc2hvcE5hbWU7XHJcbiAgICAgICAgICAgICAgICBidWlsZENvbnRlbnQoc2hvcE5hbWUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgYnVpbGRDb250ZW50RGVsZWdhdGUgPSAoZXZlbnQpID0+IGJ1aWxkQ29udGVudChldmVudC50YXJnZXQudmFsdWUpO1xyXG4gICAgXHJcbiAgICBleHBvcnRzLmdldEN1cnJlbnRTaG9wTmFtZSA9ICgpID0+IHN0YXRlLnNob3BOYW1lO1xyXG4gICAgXHJcbiAgICB2YXIgYnVpbGRDb250ZW50ID0gKHNob3BOYW1lKSA9PiB7XHJcbiAgICAgICAgc3RhdGUuc2hvcE5hbWUgPSBzaG9wTmFtZTtcclxuICAgICAgICBEQk1TLmdldFNob3Aoc2hvcE5hbWUsIGZ1bmN0aW9uKGVyciwgc2hvcERhdGEpe1xyXG4gICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgdmFyIGRhdGEgPSBhcnIyU2VsZWN0MihSLmtleXMoc2hvcERhdGEuY2F0ZWdvcmllcykuc29ydChDb21tb25VdGlscy5jaGFyT3JkQSkpO1xyXG4gICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoY2F0ZWdvcnlSb290ICsgXCIucmVuYW1lLWVudGl0eS1zZWxlY3RcIikpO1xyXG4gICAgICAgICAgICAkKGNhdGVnb3J5Um9vdCArIFwiLnJlbmFtZS1lbnRpdHktc2VsZWN0XCIpLnNlbGVjdDIoZGF0YSk7XHJcbiAgICAgICAgICAgIGNsZWFyRWwocXVlcnlFbChjYXRlZ29yeVJvb3QgKyBcIi5yZW1vdmUtZW50aXR5LXNlbGVjdFwiKSk7XHJcbiAgICAgICAgICAgICQoY2F0ZWdvcnlSb290ICsgXCIucmVtb3ZlLWVudGl0eS1zZWxlY3RcIikuc2VsZWN0MihkYXRhKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGRhdGEgPSBhcnIyU2VsZWN0MihSLmtleXMoc2hvcERhdGEubG9jYWxBc3NldHMpLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEpKTtcclxuICAgICAgICAgICAgY2xlYXJFbChxdWVyeUVsKGxvY2FsQXNzZXRSb290ICsgXCIucmVuYW1lLWVudGl0eS1zZWxlY3RcIikpO1xyXG4gICAgICAgICAgICAkKGxvY2FsQXNzZXRSb290ICsgXCIucmVuYW1lLWVudGl0eS1zZWxlY3RcIikuc2VsZWN0MihkYXRhKTtcclxuICAgICAgICAgICAgY2xlYXJFbChxdWVyeUVsKGxvY2FsQXNzZXRSb290ICsgXCIucmVtb3ZlLWVudGl0eS1zZWxlY3RcIikpO1xyXG4gICAgICAgICAgICAkKGxvY2FsQXNzZXRSb290ICsgXCIucmVtb3ZlLWVudGl0eS1zZWxlY3RcIikuc2VsZWN0MihkYXRhKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHN0YXRlLmN1cnJlbnRWaWV3LnJlZnJlc2goKTtcclxuLy8gICAgICAgICAgICBEQk1TLmdldFNob3BJbmRleChzaG9wTmFtZSwgZnVuY3Rpb24oZXJyLCBpbmRleCl7XHJcbi8vICAgICAgICAgICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XHJcbi8vICAgICAgICAgICAgICAgIGFkZEVsKGNsZWFyRWwocXVlcnlFbChyb290ICsgXCIudGhpcmQtcGFuZWxcIikpLCBzZXRBdHRyKGFkZEVsKG1ha2VFbCgnaDInKSwgbWFrZVRleHQoaW5kZXgpKSwgJ3N0eWxlJywgJ3RleHQtYWxpZ246IGNlbnRlcjsnKSk7XHJcbi8vICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgY3JlYXRlQ2F0ZWdvcnkgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIGlucHV0ID0gcXVlcnlFbChjYXRlZ29yeVJvb3QgKyBcIi5jcmVhdGUtZW50aXR5LWlucHV0XCIpO1xyXG4gICAgICAgIERCTVMuY3JlYXRlQ2F0ZWdvcnkoc3RhdGUuc2hvcE5hbWUsIGlucHV0LnZhbHVlLnRyaW0oKSwgVXRpbHMucHJvY2Vzc0Vycm9yKGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgIGlucHV0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgIH0pKTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciByZW5hbWVDYXRlZ29yeSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgdG9JbnB1dCA9IHF1ZXJ5RWwoY2F0ZWdvcnlSb290ICsgXCIucmVuYW1lLWVudGl0eS1pbnB1dFwiKTtcclxuICAgICAgICB2YXIgZnJvbU5hbWUgPSBxdWVyeUVsKGNhdGVnb3J5Um9vdCArIFwiLnJlbmFtZS1lbnRpdHktc2VsZWN0XCIpLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICB2YXIgdG9OYW1lID0gdG9JbnB1dC52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgREJNUy5yZW5hbWVDYXRlZ29yeShzdGF0ZS5zaG9wTmFtZSwgZnJvbU5hbWUsIHRvTmFtZSwgZnVuY3Rpb24oZXJyKXtcclxuICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgICAgICAgICAgdG9JbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciByZW1vdmVDYXRlZ29yeSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgbmFtZSA9IHF1ZXJ5RWwoY2F0ZWdvcnlSb290ICsgXCIucmVtb3ZlLWVudGl0eS1zZWxlY3RcIikudmFsdWUudHJpbSgpO1xyXG4gICAgICAgIFV0aWxzLmNvbmZpcm0oc3RyRm9ybWF0KGdldEwxMG4oJ3Nob3AtY29uZmlybS1jYXRlZ29yeS1yZW1vdmUnKSwgW25hbWVdKSwgKCkgPT4ge1xyXG4gICAgICAgICAgICBEQk1TLnJlbW92ZUNhdGVnb3J5KHN0YXRlLnNob3BOYW1lLCBuYW1lLCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgY3JlYXRlTG9jYWxBc3NldCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgaW5wdXQgPSBxdWVyeUVsKGxvY2FsQXNzZXRSb290ICsgXCIuY3JlYXRlLWVudGl0eS1pbnB1dFwiKTtcclxuICAgICAgICBEQk1TLmNyZWF0ZUxvY2FsQXNzZXQoc3RhdGUuc2hvcE5hbWUsIGlucHV0LnZhbHVlLnRyaW0oKSwgVXRpbHMucHJvY2Vzc0Vycm9yKGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgIGlucHV0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgIH0pKTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciByZW5hbWVMb2NhbEFzc2V0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciB0b0lucHV0ID0gcXVlcnlFbChsb2NhbEFzc2V0Um9vdCArIFwiLnJlbmFtZS1lbnRpdHktaW5wdXRcIik7XHJcbiAgICAgICAgdmFyIGZyb21OYW1lID0gcXVlcnlFbChsb2NhbEFzc2V0Um9vdCArIFwiLnJlbmFtZS1lbnRpdHktc2VsZWN0XCIpLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICB2YXIgdG9OYW1lID0gdG9JbnB1dC52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgREJNUy5yZW5hbWVMb2NhbEFzc2V0KHN0YXRlLnNob3BOYW1lLCBmcm9tTmFtZSwgdG9OYW1lLCBmdW5jdGlvbihlcnIpe1xyXG4gICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICB0b0lucHV0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIHJlbW92ZUxvY2FsQXNzZXQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIG5hbWUgPSBxdWVyeUVsKGxvY2FsQXNzZXRSb290ICsgXCIucmVtb3ZlLWVudGl0eS1zZWxlY3RcIikudmFsdWUudHJpbSgpO1xyXG4gICAgICAgIFV0aWxzLmNvbmZpcm0oc3RyRm9ybWF0KGdldEwxMG4oJ3Nob3AtY29uZmlybS1sb2NhbC1hc3NldC1yZW1vdmUnKSwgW25hbWVdKSwgKCkgPT4ge1xyXG4gICAgICAgICAgICBEQk1TLnJlbW92ZUxvY2FsQXNzZXQoc3RhdGUuc2hvcE5hbWUsIG5hbWUsIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG59KTtcclxuXHJcblNob3BNYW5hZ2VtZW50VG1wbCh0aGlzWydNYXN0ZXJTaG9wTWFuYWdlbWVudCddPXt9LCB0cnVlLCB0cnVlKTtcclxuXHJcblNob3BNYW5hZ2VtZW50VG1wbCh0aGlzWydQbGF5ZXJTaG9wTWFuYWdlbWVudCddPXt9LCBmYWxzZSwgZmFsc2UpO1xyXG5cclxuLy8odGhpc1snU2hvcE1hbmFnZW1lbnQnXT17fSk7IiwiLypDb3B5cmlnaHQgMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4oZnVuY3Rpb24oZXhwb3J0cyl7XHJcbiAgICBcclxuICAgIHZhciByb290ID0gJy5zaG9wLXdpbmRvdy10YWIgJztcclxuICAgIHZhciBzdGF0ZSA9IHt9O1xyXG4gICAgdmFyIGwxMG4gPSBMMTBuLmdldCgnc2hvcCcpO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9IGZ1bmN0aW9uKCkge1xyXG4vLyAgICAgICAgbGlzdGVuKHF1ZXJ5RWwocm9vdCArICcucmVmcmVzaEJ1dHRvbicpLCAnY2xpY2snLCBleHBvcnRzLnJlZnJlc2gpO1xyXG4vLyAgICAgICAgcXVlcnlFbHMocm9vdCArICcuZGlzY291bnQtYnV0dG9uJykubWFwKGxpc3RlbihSLl9fLCAnY2xpY2snLCAoZXZlbnQpPT57XHJcbi8vLy8gICAgICAgICAgICBzdGF0ZS5kaXNjb3VudCA9IE51bWJlcihnZXRBdHRyKGV2ZW50LnRhcmdldCwgJ3ZhbHVlJykpO1xyXG4vLyAgICAgICAgICAgIHVwZGF0ZUZpbmFsQ29zdCgpO1xyXG4vLyAgICAgICAgfSkpO1xyXG4gICAgICAgIGNoZWNrRm9yUVIoKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChyb290ICsgXCIuYW1vdW50LWlucHV0XCIpLCAnY2hhbmdlJywgb25BbW91bnRDaGFuZ2UpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKHJvb3QgKyBcIi5idXktYnV0dG9uXCIpLCAnY2xpY2snLCBvbkJ1eSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwocm9vdCArIFwiLnN0YXJ0LXFyLXJlYWRcIiksICdjbGljaycsIHJlYWRRUik7XHJcbiAgICAgICAgXHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMucmVmcmVzaCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHZhciBzaG9wTmFtZSA9IFNob3BNYW5hZ2VtZW50LmdldEN1cnJlbnRTaG9wTmFtZSgpO1xyXG4gICAgICAgIERCTVMuZ2V0U2hvcChzaG9wTmFtZSwgZnVuY3Rpb24oZXJyLCBzaG9wRGF0YSl7XHJcbiAgICAgICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XHJcbiAgICAgICAgICAgIHN0YXRlLnNob3BEYXRhID0gc2hvcERhdGE7XHJcbiAgICAgICAgICAgIHZhciBjYXRlZ29yeUxpc3QgID0gUi5rZXlzKHN0YXRlLnNob3BEYXRhLmNhdGVnb3JpZXMpLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgdmFyIGNhdFNlbGVjdCA9IGNsZWFyRWwocXVlcnlFbChyb290ICsgXCIuY2F0ZWdvcnktc2VsZWN0XCIpKTtcclxuICAgICAgICAgICAgY2xlYXJFbChxdWVyeUVsKHJvb3QgKyBcIi5hc3NldC1zZWxlY3RcIikpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHZhciBjYXRCdG5zID0gY2F0ZWdvcnlMaXN0Lm1hcCggbmFtZSA9PiB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYnRuID0gYWRkRWwobWFrZUVsKCdidXR0b24nKSwgbWFrZVRleHQobmFtZSkpO1xyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3MoYnRuLCAnc2VsZWN0LWJ1dHRvbicpO1xyXG4gICAgICAgICAgICAgICAgYnRuLmNhdE5hbWUgPSBuYW1lO1xyXG4gICAgICAgICAgICAgICAgbGlzdGVuKGJ0biwgXCJjbGlja1wiLCBvbkNhdGVnb3J5U2VsZWN0KTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBidG47XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBhZGRFbHMoY2F0U2VsZWN0LCBjYXRCdG5zKTtcclxuICAgICAgICAgICAgaWYoY2F0QnRucy5sZW5ndGggPiAwKSBvbkNhdGVnb3J5U2VsZWN0KHt0YXJnZXQ6Y2F0QnRuc1swXX0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgbWFrZUJ0biA9IFIuY3VycnkoKGNhdE5hbWUsIGVsKSA9PiB7XHJcbiAgICAgICAgdmFyIGJ0biA9IGFkZEVsKG1ha2VFbCgnYnV0dG9uJyksIG1ha2VUZXh0KGVsLmRpc3BOYW1lKSk7XHJcbiAgICAgICAgYWRkQ2xhc3MoYnRuLCAnc2VsZWN0LWJ1dHRvbicpO1xyXG4gICAgICAgIGJ0bi5uYW1lID0gZWwubmFtZTtcclxuICAgICAgICBidG4uY2F0TmFtZSA9IGNhdE5hbWU7XHJcbiAgICAgICAgYnRuLmFzc2V0VHlwZSA9IGVsLnR5cGU7XHJcbiAgICAgICAgbGlzdGVuKGJ0biwgXCJjbGlja1wiLCBvbkFzc2V0U2VsZWN0KTtcclxuICAgICAgICByZXR1cm4gYnRuO1xyXG4gICAgfSk7XHJcbiAgICBcclxuICAgIHZhciBvbkNhdGVnb3J5U2VsZWN0ID0gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgcXVlcnlFbHMocm9vdCArIFwiLmNhdGVnb3J5LXNlbGVjdCA+IGJ1dHRvblwiKS5tYXAocmVtb3ZlQ2xhc3MoUi5fXywgJ2FjdGl2ZScpKTtcclxuICAgICAgICBhZGRDbGFzcyhldmVudC50YXJnZXQsICdhY3RpdmUnKTtcclxuICAgICAgICB2YXIgY2F0TmFtZSA9IGV2ZW50LnRhcmdldC5jYXROYW1lO1xyXG4gICAgICAgIHZhciBjYXRlZ29yeSA9IHN0YXRlLnNob3BEYXRhLmNhdGVnb3JpZXNbY2F0TmFtZV07XHJcbiAgICAgICAgXHJcbiAgICAgICAgY2xlYXJFbChxdWVyeUVsKHJvb3QgKyBcIi5hc3NldC1pbmZvXCIpKTtcclxuICAgICAgICBhZGRDbGFzcyhxdWVyeUVsKHJvb3QgKyBcIi5idXktY29udHJvbHNcIiksICdoaWRkZW4nKTtcclxuICAgICAgICB2YXIgYXNzZXRTZWxlY3QgPSBjbGVhckVsKHF1ZXJ5RWwocm9vdCArIFwiLmFzc2V0LXNlbGVjdFwiKSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgdmFyIGFyciA9IFIua2V5cyhjYXRlZ29yeS5nbG9iYWxzKS5tYXAoUi5wYWlyKFIuX18sICdnbG9iYWwnKSk7XHJcbiAgICAgICAgYXJyID0gUi5jb25jYXQoYXJyLCBSLmtleXMoY2F0ZWdvcnkubG9jYWxzKS5tYXAoUi5wYWlyKFIuX18sICdsb2NhbCcpKSk7XHJcblxyXG4gICAgICAgIERCTVMuZ2V0R2xvYmFsQXNzZXREaXNwbGF5TmFtZXMoIChlcnIsIGdsb2JhbERpc3BsYXlOYW1lcykgPT4ge1xyXG4gICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgYXJyID0gYXJyLm1hcChlbCA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZihlbFsxXSA9PT0gJ2dsb2JhbCcpe1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBkaXNwTmFtZSA9IGdsb2JhbERpc3BsYXlOYW1lc1tlbFswXV0uZGlzcGxheVN0cmluZztcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGRpc3BOYW1lID0gc3RhdGUuc2hvcERhdGEubG9jYWxBc3NldHNbZWxbMF1dLmRpc3BsYXlTdHJpbmc7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IGVsWzBdLFxyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IGVsWzFdLFxyXG4gICAgICAgICAgICAgICAgICAgIGRpc3BOYW1lOiBkaXNwTmFtZS50cmltKCkgPT09ICcnID8gZWxbMF0gOiBkaXNwTmFtZVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KS5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBRmFjdG9yeShSLnByb3AoJ2Rpc3BOYW1lJykpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGFkZEVscyhhc3NldFNlbGVjdCwgYXJyLm1hcChtYWtlQnRuKGNhdE5hbWUpKSlcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBvbkFzc2V0U2VsZWN0ID0gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgcXVlcnlFbHMocm9vdCArIFwiLmFzc2V0LXNlbGVjdCA+IGJ1dHRvblwiKS5tYXAocmVtb3ZlQ2xhc3MoUi5fXywgJ2FjdGl2ZScpKTtcclxuICAgICAgICBhZGRDbGFzcyhldmVudC50YXJnZXQsICdhY3RpdmUnKTtcclxuICAgICAgICByZW1vdmVDbGFzcyhxdWVyeUVsKHJvb3QgKyBcIi5idXktY29udHJvbHNcIiksICdoaWRkZW4nKTtcclxuICAgICAgICBxdWVyeUVsKCcuY3VzdG9tZXItbG9naW4nKS52YWx1ZSA9ICcnO1xyXG4gICAgICAgIHF1ZXJ5RWwoJy5jdXN0b21lci1wYXNzd29yZCcpLnZhbHVlID0gJyc7XHJcbiAgICAgICAgc3RhdGUuY3VyQXNzZXQgPSB7XHJcbiAgICAgICAgICAgIG5hbWUgOiBldmVudC50YXJnZXQubmFtZSAsXHJcbiAgICAgICAgICAgIGNhdE5hbWUgOiBldmVudC50YXJnZXQuY2F0TmFtZSAsXHJcbiAgICAgICAgICAgIGFzc2V0VHlwZSA6IGV2ZW50LnRhcmdldC5hc3NldFR5cGUgXHJcbiAgICAgICAgfTtcclxuICAgICAgICBzaG93QXNzZXRJbmZvKCk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgc2hvd0Fzc2V0SW5mbyA9ICgpID0+IHtcclxuICAgICAgICB2YXIgc2V0ID0gc3RhdGUuY3VyQXNzZXQuYXNzZXRUeXBlID09PSAnbG9jYWwnID8gJ2xvY2FscycgOiAnZ2xvYmFscyc7XHJcbiAgICAgICAgdmFyIGNvc3QgPSBzdGF0ZS5zaG9wRGF0YS5jYXRlZ29yaWVzW3N0YXRlLmN1ckFzc2V0LmNhdE5hbWVdW3NldF1bc3RhdGUuY3VyQXNzZXQubmFtZV0uY29zdDtcclxuICAgICAgICBzdGF0ZS5jb3N0ID0gY29zdDtcclxuICAgICAgICBxdWVyeUVsKHJvb3QgKyBcIi5maW5hbC1jb3N0LWlucHV0XCIpLnZhbHVlID0gY29zdDtcclxuLy8gICAgICAgIHN0YXRlLmRpc2NvdW50ID0gMDtcclxuICAgICAgICBpZihzdGF0ZS5jdXJBc3NldC5hc3NldFR5cGUgPT09ICdsb2NhbCcpe1xyXG4gICAgICAgICAgICBzdGF0ZS5hc3NldERhdGEgPSBzdGF0ZS5zaG9wRGF0YS5sb2NhbEFzc2V0c1tzdGF0ZS5jdXJBc3NldC5uYW1lXTtcclxuICAgICAgICAgICAgcmVuZGVyQXNzZXRJbmZvKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgREJNUy5nZXRBc3NldChzdGF0ZS5jdXJBc3NldC5uYW1lLCAoZXJyLCBhc3NldERhdGEpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5hc3NldERhdGEgPSBhc3NldERhdGE7XHJcbiAgICAgICAgICAgICAgICByZW5kZXJBc3NldEluZm8oKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIHJlbmRlckFzc2V0SW5mbyA9ICgpID0+IHtcclxuICAgICAgICB2YXIgaW5mbyA9IGNsZWFyRWwocXVlcnlFbChyb290ICsgXCIuYXNzZXQtaW5mb1wiKSk7XHJcbiAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gc3RhdGUuYXNzZXREYXRhLmRpc3BsYXlTdHJpbmcudHJpbSgpICE9PSAnJyA/IHN0YXRlLmFzc2V0RGF0YS5kaXNwbGF5U3RyaW5nIDogc3RhdGUuY3VyQXNzZXQubmFtZTtcclxuICAgICAgICBhZGRFbChpbmZvLCBhZGRFbChtYWtlRWwoJ2gyJyksIG1ha2VUZXh0KGRpc3BsYXlOYW1lKSkpO1xyXG4gICAgICAgIGFkZEVsKGluZm8sIGFkZEVsKG1ha2VFbCgnc3BhbicpLCBtYWtlVGV4dChzdGF0ZS5hc3NldERhdGEuZGVzY3JpcHRpb24pKSk7XHJcbiAgICAgICAgYWRkRWwoY2xlYXJFbChxdWVyeUVsKHJvb3QgKyBcIi5pbml0aWFsLWNvc3QtdmFsdWVcIikpLCBtYWtlVGV4dChzdGF0ZS5jb3N0KSk7XHJcblxyXG4gICAgICAgIHNldENsYXNzQnlDb25kaXRpb24ocXVlcnlFbChyb290ICsgXCIuYWN0aXZhdGlvbi1jb2Rlcy1jb250YWluZXJcIiksICdoaWRkZW4nLCAhc3RhdGUuYXNzZXREYXRhLmlzUGh5c2ljYWwpO1xyXG4gICAgICAgIHNldENsYXNzQnlDb25kaXRpb24ocXVlcnlFbChyb290ICsgXCIucXItcmVhZGVyXCIpLCAnaGlkZGVuJywgIShzdGF0ZS5hc3NldERhdGEuaXNQaHlzaWNhbCAmJiBzdGF0ZS5pc0NhbnZhc09rKSk7XHJcbiAgICAgICAgdmFyIGFtb3VudCA9IGNsZWFyRWwocXVlcnlFbChyb290ICsgXCIuYW1vdW50LWlucHV0XCIpKTtcclxuICAgICAgICBhbW91bnQudmFsdWUgPSAxO1xyXG4gICAgICAgIGlmKHN0YXRlLmFzc2V0RGF0YS5pc1BoeXNpY2FsKXtcclxuICAgICAgICAgICAgZGVsQXR0cihhbW91bnQsICdkaXNhYmxlZCcpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHNldEF0dHIoYW1vdW50LCAnZGlzYWJsZWQnLCAnZGlzYWJsZWQnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgb25BbW91bnRDaGFuZ2Uoe3RhcmdldDogYW1vdW50fSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgb25BbW91bnRDaGFuZ2UgPSAoZXZlbnQpID0+IHtcclxuICAgICAgICB2YXIgbnVtID0gTnVtYmVyKGV2ZW50LnRhcmdldC52YWx1ZSk7XHJcbiAgICAgICAgdmFyIGVsID0gY2xlYXJFbChxdWVyeUVsKHJvb3QgKyBcIi5hY3RpdmF0aW9uLWNvZGVzXCIpKTtcclxuICAgICAgICBpZihudW0gPCAxKSBudW0gPSAxO1xyXG4gICAgICAgIGlmKG51bSA+IDEwKSBudW0gPSAxMDtcclxuICAgICAgICBhZGRFbHMoZWwsIFIucmVwZWF0KDEsIG51bSkubWFwKHZhbCA9PiB7XHJcbi8vICAgICAgICAgICAgcmV0dXJuIHNldEF0dHIobWFrZUVsKCdpbnB1dCcpLCAndHlwZScsICdudW1iZXInKTtcclxuICAgICAgICAgICAgcmV0dXJuIGFkZENsYXNzZXMobWFrZUVsKCdpbnB1dCcpLCBbJ2Zvcm0tY29udHJvbCcsJ3FyLWNvZGUtaW5wdXQnXSk7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIG9uQnV5ID0gKCkgPT4ge1xyXG4gICAgICAgIHZhciBzaG9wTmFtZSA9IFNob3BNYW5hZ2VtZW50LmdldEN1cnJlbnRTaG9wTmFtZSgpO1xyXG4gICAgICAgIHZhciBjb3N0ID0gTnVtYmVyKHF1ZXJ5RWwocm9vdCArIFwiLmZpbmFsLWNvc3QtaW5wdXRcIikudmFsdWUpO1xyXG4gICAgICAgIHZhciBjdXN0b21lckxvZ2luID0gcXVlcnlFbCgnLmN1c3RvbWVyLWxvZ2luJykudmFsdWU7XHJcbiAgICAgICAgdmFyIGN1c3RvbWVyUGFzc3dvcmQgPSBxdWVyeUVsKCcuY3VzdG9tZXItcGFzc3dvcmQnKS52YWx1ZTtcclxuICAgICAgICB2YXIgb3B0cyA9IHtcclxuICAgICAgICAgICAgYW1vdW50OiBOdW1iZXIocXVlcnlFbChyb290ICsgXCIuYW1vdW50LWlucHV0XCIpLnZhbHVlKVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgaWYoc3RhdGUuYXNzZXREYXRhLmlzUGh5c2ljYWwpe1xyXG4gICAgICAgICAgICB2YXIgdmFsdWVzID0gcXVlcnlFbHMocm9vdCArIFwiLmFjdGl2YXRpb24tY29kZXMgaW5wdXRcIikubWFwKFIuY29tcG9zZShSLnRyaW0sIFIucHJvcCgndmFsdWUnKSkpO1xyXG4gICAgICAgICAgICBpZih2YWx1ZXMuc29tZShSLmlzRW1wdHkpKXtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGwxMG4oJ25vdC1hbGwtYWN0aXZhdGlvbi1jb2Rlcy1hcmUtZnVsbCcpKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBvcHRzLmNvZGVzID0gdmFsdWVzO1xyXG4gICAgICAgIH1cclxuICAgICAgICBEQk1TLmJ1eUFzc2V0KHNob3BOYW1lLCBzdGF0ZS5jdXJBc3NldC5uYW1lLCBzdGF0ZS5jdXJBc3NldC5hc3NldFR5cGUsIGNvc3QsIGN1c3RvbWVyTG9naW4sIGN1c3RvbWVyUGFzc3dvcmQsIG9wdHMsIGZ1bmN0aW9uKGVycil7XHJcbiAgICAgICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XHJcbiAgICAgICAgICAgIHF1ZXJ5RWwoJy5jdXN0b21lci1sb2dpbicpLnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgIHF1ZXJ5RWwoJy5jdXN0b21lci1wYXNzd29yZCcpLnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGwxMG4oJ29uLXB1cmNoYXNlLXN1Y2Nlc3MnKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgY2hlY2tGb3JRUiA9ICgpID0+IHtcclxuICAgICAgICBmdW5jdGlvbiBpc0NhbnZhc1N1cHBvcnRlZCgpe1xyXG4gICAgICAgICAgdmFyIGVsZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcclxuICAgICAgICAgIHJldHVybiAhIShlbGVtLmdldENvbnRleHQgJiYgZWxlbS5nZXRDb250ZXh0KCcyZCcpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgc3RhdGUuaXNDYW52YXNPayA9IGlzQ2FudmFzU3VwcG9ydGVkKCkgJiYgd2luZG93LkZpbGUgJiYgd2luZG93LkZpbGVSZWFkZXI7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgcmVhZFFSID0gKCkgPT4ge1xyXG4gICAgICAgIHFyY29kZS5jYWxsYmFjayA9IHJlYWQ7XHJcbiAgICAgICAgcXJjb2RlLmN1c3RvbUNhbnZhcyA9IHF1ZXJ5RWwocm9vdCArIFwiLnFyLWNhbnZhc1wiKTtcclxuICAgICAgICB2YXIgdmlkZW8gPSBzZXRBdHRyKG1ha2VFbCgndmlkZW8nKSwgJ2F1dG9wbGF5JywnYXV0b3BsYXknKTtcclxuICAgICAgICBhZGRFbChjbGVhckVsKHF1ZXJ5RWwocm9vdCArIFwiLnZpZGVvXCIpKSwgdmlkZW8pO1xyXG4gICAgICAgIHFyY29kZS5zZXRXZWJjYW0odmlkZW8pO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIHJlYWQgPSAoYSkgPT4ge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdyZWFkIGNhbGxlZCcpO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGEpO1xyXG4gICAgICAgIHF1ZXJ5RWwocm9vdCArIFwiLnZpZGVvIHZpZGVvXCIpLnBhdXNlKCk7XHJcbiAgICAgICAgY2xlYXJFbChxdWVyeUVsKHJvb3QgKyBcIi52aWRlb1wiKSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgdmFyIHJlcXVlc3QgPSAkLmFqYXgoe1xyXG4vLyAgICAgICAgICAgIHVybCA6ICdodHRwOi8vZGV2LmFsaWNlLmRpZ2l0YWw6ODE1OS9kZWNvZGU/Y29udGVudD0nICsgYSxcclxuICAgICAgICAgICAgdXJsIDogJ2h0dHBzOi8vYWxpY2UuZGlnaXRhbC9hcHAvcXIvZGVjb2RlP2NvbnRlbnQ9JyArIGEsXHJcbiAgICAgICAgICAgIGRhdGFUeXBlIDogXCJ0ZXh0XCIsXHJcbiAgICAgICAgICAgIG1ldGhvZCA6IFwiR0VUXCIsXHJcbiAgICAgICAgICAgIGNvbnRlbnRUeXBlIDogXCJhcHBsaWNhdGlvbi9qc29uO2NoYXJzZXQ9dXRmLThcIixcclxuICAgICAgICAgICAgY2FjaGU6IGZhbHNlLFxyXG4gICAgICAgICAgICB0aW1lb3V0OiBDb25zdGFudHMuaHR0cFRpbWVvdXQsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmVxdWVzdC5kb25lKGZ1bmN0aW9uKGRhdGEpIHtcclxuICAgICAgICAgICAgZGF0YSA9IEpTT04ucGFyc2UoZGF0YSk7XHJcbiAgICAgICAgICAgIHZhciBsZW5ndGggPSBkYXRhLnBheWxvYWQubGVuZ3RoO1xyXG4gICAgICAgICAgICB2YXIgcGF5bG9hZCA9IGRhdGEucGF5bG9hZC5zdWJzdHJpbmcobGVuZ3RoLTYsIGxlbmd0aCk7XHJcbiAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBxdWVyeUVscyhyb290ICsgXCIuYWN0aXZhdGlvbi1jb2RlcyBpbnB1dFwiKS5tYXAoUi5jb21wb3NlKFIudHJpbSwgUi5wcm9wKCd2YWx1ZScpKSk7XHJcbiAgICAgICAgICAgIGlmKFIuY29udGFpbnMocGF5bG9hZCwgdmFsdWVzKSl7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5hbGVydChsMTBuKCd0aGlzLXFyLWNvZGUtYWxyZWFkeS11c2VkLWluLWlucHV0cycpKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgaW5wdXRzID0gcXVlcnlFbHMocm9vdCArIFwiLmFjdGl2YXRpb24tY29kZXMgaW5wdXRcIikuZmlsdGVyKFIuY29tcG9zZShSLmlzRW1wdHksIFIudHJpbSwgUi5wcm9wKCd2YWx1ZScpKSk7XHJcbiAgICAgICAgICAgIGlmKGlucHV0cy5sZW5ndGggPiAwKXtcclxuICAgICAgICAgICAgICAgIGlucHV0c1swXS52YWx1ZSA9IGRhdGEucGF5bG9hZC5zdWJzdHJpbmcobGVuZ3RoLTYsIGxlbmd0aCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5hbGVydChsMTBuKCdhbGwtYWN0aXZhdGlvbi1jb2Rlcy1hcmUtZnVsbCcpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHJlcXVlc3QuZmFpbChmdW5jdGlvbihlcnJvckluZm8sIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSB7XHJcbiAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGVycm9ySW5mby5yZXNwb25zZVRleHQgfHwgdGV4dFN0YXR1cyB8fCAnZXJyb3InKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBcclxuXHJcbn0pKHRoaXNbJ1Nob3BXaW5kb3cnXT17fSk7IiwiLypDb3B5cmlnaHQgMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4oZnVuY3Rpb24oZXhwb3J0cyl7XHJcbiAgICBcclxuICAgIHZhciByb290ID0gJy5zaG9wLWFib3V0LXRhYiAnO1xyXG4gICAgdmFyIHN0YXRlID0ge307XHJcbiAgICB2YXIgbDEwbiA9IEwxMG4uZ2V0KCdzaG9wJyk7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMucmVmcmVzaCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHZhciBzaG9wTmFtZSA9IFNob3BNYW5hZ2VtZW50LmdldEN1cnJlbnRTaG9wTmFtZSgpO1xyXG4gICAgICAgIERCTVMuZ2V0U2hvcChzaG9wTmFtZSwgZnVuY3Rpb24oZXJyLCBzaG9wRGF0YSl7XHJcbiAgICAgICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XHJcbiAgICAgICAgICAgIHZhciBib2R5ID0gY2xlYXJFbChxdWVyeUVsKHJvb3QgKyAnLnNob3AtaW5mby10YWJsZS1ib2R5JykpO1xyXG4gICAgICAgICAgICB2YXIgZWwxID0gYWRkRWxzKG1ha2VFbCgndHInKSwgWyBhZGRFbChtYWtlRWwoJ3RkJyksIGFkZEVsKG1ha2VFbCgnc3BhbicpLCBtYWtlVGV4dChsMTBuKCdjb3Jwb3JhdGlvbi1uYW1lJykpKSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZEVsKG1ha2VFbCgndGQnKSwgYWRkRWwobWFrZUVsKCdzcGFuJyksIG1ha2VUZXh0KHNob3BEYXRhLmNvcnBvcmF0aW9uKSkpXSlcclxuICAgICAgICAgICAgdmFyIGVsMiA9IGFkZEVscyhtYWtlRWwoJ3RyJyksIFsgYWRkRWwobWFrZUVsKCd0ZCcpLCBhZGRFbChtYWtlRWwoJ3NwYW4nKSwgbWFrZVRleHQobDEwbignbGVnYWwtYm9keScpKSkpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFbChtYWtlRWwoJ3RkJyksIGFkZEVsKG1ha2VFbCgnc3BhbicpLCBtYWtlVGV4dChzaG9wRGF0YS5zZWxsZXJMb2dpbikpKV0pXHJcbiAgICAgICAgICAgIGFkZEVscyhib2R5LCBbZWwxLCBlbDJdKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG59KSh0aGlzWydTaG9wQWJvdXQnXT17fSk7IiwiLypDb3B5cmlnaHQgMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4oZnVuY3Rpb24oZXhwb3J0cyl7XHJcbiAgICBcclxuICAgIHZhciByb290ID0gJy5jYXRlZ29yeS1jb250ZW50LW1hbmFnZW1lbnQtdGFiICc7XHJcbiAgICB2YXIgY2F0ZWdvcnlDb250ZW50Um9vdCA9IHJvb3QgKyAnLmNhdGVnb3J5LWNvbnRlbnQtbWFuYWdlbWVudCAnO1xyXG4gICAgdmFyIHN0YXRlID0ge307XHJcbiAgICBzdGF0ZS5zb3J0S2V5ID0gMDtcclxuICAgIHN0YXRlLnNvcnREaXIgPSBcImFzY1wiO1xyXG5cclxuICAgIHZhciBoZWFkQXJyID0gWyAnY2F0ZWdvcnlOYW1lJyxcclxuICAgICAgICAnYXNzZXROYW1lJyxcclxuICAgICAgICAnZGlzcGxheVN0cmluZycsXHJcbiAgICAgICAgJ2Nvc3QnLFxyXG4gICAgICAgICd0eXBlJyxcclxuICAgICAgICAncmVzb3VyY2VDb3N0JyxcclxuICAgICAgICAnaXNQaHlzaWNhbCcsXHJcbiAgICAgICAgJ2Rlc2NyaXB0aW9uJyBdO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGNhdGVnb3J5Q29udGVudFJvb3QgKyBcIi5hZGQtZW50aXR5LWJ1dHRvbi0xXCIpLFwiY2xpY2tcIiwgYWRkR2xvYmFsQXNzZXRUb0NhdGVnb3J5KTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChjYXRlZ29yeUNvbnRlbnRSb290ICsgXCIuYWRkLWVudGl0eS1idXR0b24tMlwiKSxcImNsaWNrXCIsIGFkZExvY2FsQXNzZXRUb0NhdGVnb3J5KTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChjYXRlZ29yeUNvbnRlbnRSb290ICsgXCIucmVtb3ZlLWVudGl0eS1idXR0b24tMVwiKSxcImNsaWNrXCIsIHJlbW92ZUdsb2JhbEFzc2V0RnJvbUNhdGVnb3J5KTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChjYXRlZ29yeUNvbnRlbnRSb290ICsgXCIucmVtb3ZlLWVudGl0eS1idXR0b24tMlwiKSxcImNsaWNrXCIsIHJlbW92ZUxvY2FsQXNzZXRGcm9tQ2F0ZWdvcnkpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGluaXRTb3J0SWNvbnMoKTtcclxuICAgICAgICBxdWVyeUVscyhjYXRlZ29yeUNvbnRlbnRSb290ICsgXCJ0aGVhZCB0ciBpbnB1dFwiKS5tYXAobGlzdGVuKFIuX18sICdpbnB1dCcsIGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSBmdW5jdGlvbigpIHtcclxuICAgICAgICB2YXIgc2hvcE5hbWUgPSBTaG9wTWFuYWdlbWVudC5nZXRDdXJyZW50U2hvcE5hbWUoKTtcclxuICAgICAgICBEQk1TLmdldFNob3Aoc2hvcE5hbWUsIGZ1bmN0aW9uKGVyciwgc2hvcERhdGEpe1xyXG4gICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgdmFyIGRhdGEgPSBhcnIyU2VsZWN0MihSLmtleXMoc2hvcERhdGEuY2F0ZWdvcmllcykuc29ydChDb21tb25VdGlscy5jaGFyT3JkQSkpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY2xlYXJFbChxdWVyeUVsKGNhdGVnb3J5Q29udGVudFJvb3QgKyBcIi5hZGQtZW50aXR5LXNlbGVjdC0xMlwiKSk7XHJcbiAgICAgICAgICAgICQoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwiLmFkZC1lbnRpdHktc2VsZWN0LTEyXCIpLnNlbGVjdDIoZGF0YSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwiLmFkZC1lbnRpdHktc2VsZWN0LTIyXCIpKTtcclxuICAgICAgICAgICAgJChjYXRlZ29yeUNvbnRlbnRSb290ICsgXCIuYWRkLWVudGl0eS1zZWxlY3QtMjJcIikuc2VsZWN0MihkYXRhKTtcclxuXHJcbiAgICAgICAgICAgIHZhciBnbG9iYWxBc3NldHMgPSBhcnIyU2VsZWN0MihSLmtleXMoc2hvcERhdGEuYXNzZXRzKSk7XHJcbi8vICAgICAgICAgICAgZ2xvYmFsQXNzZXRzLnBsYWNlaG9sZGVyID0gXCJTZWxlY3QgYW4gb3B0aW9uXCI7XHJcbiAgICAgICAgICAgIGNsZWFyRWwocXVlcnlFbChjYXRlZ29yeUNvbnRlbnRSb290ICsgXCIuYWRkLWVudGl0eS1zZWxlY3QtMTFcIikpO1xyXG4gICAgICAgICAgICAkKGNhdGVnb3J5Q29udGVudFJvb3QgKyBcIi5hZGQtZW50aXR5LXNlbGVjdC0xMVwiKS5zZWxlY3QyKChnbG9iYWxBc3NldHMpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHZhciBsb2NhbEFzc2V0cyA9IGFycjJTZWxlY3QyKFIua2V5cyhzaG9wRGF0YS5sb2NhbEFzc2V0cykpO1xyXG4gICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwiLmFkZC1lbnRpdHktc2VsZWN0LTIxXCIpKTtcclxuICAgICAgICAgICAgJChjYXRlZ29yeUNvbnRlbnRSb290ICsgXCIuYWRkLWVudGl0eS1zZWxlY3QtMjFcIikuc2VsZWN0MigobG9jYWxBc3NldHMpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHZhciBnZXRMaXN0ID0gKGNvbnRhaW5lcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFIudW5uZXN0KFIua2V5cyhzaG9wRGF0YS5jYXRlZ29yaWVzKS5tYXAoY2F0ZWdvcnlOYW1lID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gUi5rZXlzKHNob3BEYXRhLmNhdGVnb3JpZXNbY2F0ZWdvcnlOYW1lXVtjb250YWluZXJdKS5tYXAoYXNzZXROYW1lID0+IFtjYXRlZ29yeU5hbWUsIGFzc2V0TmFtZV0pXHJcbiAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGFzc2V0cyA9IGdldExpc3QoJ2dsb2JhbHMnKS5tYXAoIGFyciA9PiBSLnppcE9iaihbJ2Rpc3BsYXlOYW1lJywndmFsdWUnXSwgW2FyclswXSArICcvJyArIGFyclsxXSwgSlNPTi5zdHJpbmdpZnkoYXJyKV0pKTtcclxuICAgICAgICAgICAgYXNzZXRzLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEFGYWN0b3J5KFIucHJvcCgnZGlzcGxheU5hbWUnKSkpXHJcbiAgICAgICAgICAgIGNsZWFyRWwocXVlcnlFbChjYXRlZ29yeUNvbnRlbnRSb290ICsgXCIucmVtb3ZlLWVudGl0eS1zZWxlY3QtMVwiKSk7XHJcbiAgICAgICAgICAgICQoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwiLnJlbW92ZS1lbnRpdHktc2VsZWN0LTFcIikuc2VsZWN0MihnZXRTZWxlY3QyRGF0YShhc3NldHMpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHZhciBhc3NldHMgPSBnZXRMaXN0KCdsb2NhbHMnKS5tYXAoIGFyciA9PiBSLnppcE9iaihbJ2Rpc3BsYXlOYW1lJywndmFsdWUnXSwgW2FyclswXSArICcvJyArIGFyclsxXSwgSlNPTi5zdHJpbmdpZnkoYXJyKV0pKTtcclxuICAgICAgICAgICAgYXNzZXRzLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEFGYWN0b3J5KFIucHJvcCgnZGlzcGxheU5hbWUnKSkpXHJcbiAgICAgICAgICAgIGNsZWFyRWwocXVlcnlFbChjYXRlZ29yeUNvbnRlbnRSb290ICsgXCIucmVtb3ZlLWVudGl0eS1zZWxlY3QtMlwiKSk7XHJcbiAgICAgICAgICAgICQoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwiLnJlbW92ZS1lbnRpdHktc2VsZWN0LTJcIikuc2VsZWN0MihnZXRTZWxlY3QyRGF0YShhc3NldHMpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGZpbGxTaG9wVGFibGUoc2hvcERhdGEpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIGluaXRTb3J0SWNvbnMgPSAoKSA9PiB7XHJcbiAgICAgICAgdmFyIGljb25zID0gcXVlcnlFbHMoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwidGhlYWQgdHIuZmlyc3Qtcm93IHRoXCIpO1xyXG4gICAgICAgIGljb25zLm1hcCgoaWNvbiwgaSkgPT4ge1xyXG4gICAgICAgICAgICBpY29uLmluZGV4ID0gaTtcclxuICAgICAgICAgICAgbGlzdGVuKGljb24sIFwiY2xpY2tcIiwgb25Tb3J0Q2hhbmdlKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBvblNvcnRDaGFuZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0O1xyXG4gICAgICAgIGlmKHRhcmdldC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09IFwic3BhblwiKXtcclxuICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudEVsZW1lbnQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGlmIChzdGF0ZS5zb3J0S2V5ID09PSB0YXJnZXQuaW5kZXgpIHtcclxuICAgICAgICAgICAgc3RhdGUuc29ydERpciA9IHN0YXRlLnNvcnREaXIgPT09IFwiYXNjXCIgPyBcImRlc2NcIiA6IFwiYXNjXCI7XHJcbiAgICAgICAgICAgIHNldENsYXNzQnlDb25kaXRpb24odGFyZ2V0LCAnc29ydERlc2MnLCBzdGF0ZS5zb3J0RGlyID09PSAnZGVzYycpO1xyXG4gICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKHRhcmdldCwgJ3NvcnRBc2MnLCBzdGF0ZS5zb3J0RGlyID09PSAnYXNjJyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdmFyIGZpbHRlckhlYWQgPSBxdWVyeUVsKGNhdGVnb3J5Q29udGVudFJvb3QgKyBcInRoZWFkXCIpO1xyXG4gICAgICAgICAgICBubDJhcnJheShmaWx0ZXJIZWFkLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoXCJzb3J0QXNjXCIpKS5mb3JFYWNoKHJlbW92ZUNsYXNzKFIuX18sIFwic29ydEFzY1wiKSk7XHJcbiAgICAgICAgICAgIG5sMmFycmF5KGZpbHRlckhlYWQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShcInNvcnREZXNjXCIpKS5mb3JFYWNoKHJlbW92ZUNsYXNzKFIuX18sIFwic29ydERlc2NcIikpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgc3RhdGUuc29ydEtleSA9IHRhcmdldC5pbmRleDtcclxuICAgICAgICAgICAgc3RhdGUuc29ydERpciA9IFwiYXNjXCI7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKHRhcmdldCwgXCJzb3J0QXNjXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBkYXRhMnN0ciA9IChkYXRhKSA9PiB7XHJcbiAgICAgICAgaWYoZGF0YS5jb3N0ICE9PSAtMSl7XHJcbiAgICAgICAgICAgIHZhciBpbnB1dCA9IGFkZENsYXNzKG1ha2VFbCgnaW5wdXQnKSwnZm9ybS1jb250cm9sJyk7XHJcbiAgICAgICAgICAgIHNldEF0dHIoaW5wdXQsICd0eXBlJywgJ251bWJlcicpO1xyXG4gICAgICAgICAgICBzZXRBdHRyKGlucHV0LCAnbWluJywgJzAnKTtcclxuICAgICAgICAgICAgaW5wdXQudmFsdWUgPSBkYXRhLmNvc3Q7XHJcbiAgICAgICAgICAgIGxpc3RlbihpbnB1dCwgXCJjaGFuZ2VcIiwgKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBEQk1TLnNldEFzc2V0Q29zdChTaG9wTWFuYWdlbWVudC5nZXRDdXJyZW50U2hvcE5hbWUoKSwgZGF0YS50eXBlLCBkYXRhLmNhdGVnb3J5TmFtZSwgZGF0YS5hc3NldE5hbWUsIE51bWJlcihldmVudC50YXJnZXQudmFsdWUpLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlucHV0ID0gbWFrZVRleHQoJycpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYWRkRWxzKG1ha2VFbCgndHInKSwgW2FkZEVsKG1ha2VFbCgndGQnKSwgbWFrZVRleHQoZGF0YS5jYXRlZ29yeU5hbWUpKSxcclxuICAgICAgICAgICAgICAgIGFkZEVsKG1ha2VFbCgndGQnKSwgbWFrZVRleHQoZGF0YS5hc3NldE5hbWUpKSxcclxuICAgICAgICAgICAgICAgIGFkZEVsKG1ha2VFbCgndGQnKSwgbWFrZVRleHQoZGF0YS5kaXNwbGF5U3RyaW5nKSksXHJcbiAgICAgICAgICAgICAgICBhZGRFbChtYWtlRWwoJ3RkJyksIGlucHV0KSxcclxuLy8gICAgICAgICAgICAgICAgYWRkRWwobWFrZUVsKCd0ZCcpLCBtYWtlVGV4dChkYXRhLmNvc3QpKSxcclxuICAgICAgICAgICAgICAgIGFkZEVsKG1ha2VFbCgndGQnKSwgbWFrZVRleHQoZGF0YS50eXBlKSksXHJcbiAgICAgICAgICAgICAgICBhZGRFbChtYWtlRWwoJ3RkJyksIG1ha2VUZXh0KGRhdGEucmVzb3VyY2VDb3N0KSksXHJcbiAgICAgICAgICAgICAgICBhZGRFbChtYWtlRWwoJ3RkJyksIG1ha2VUZXh0KGRhdGEuaXNQaHlzaWNhbCA/IEwxMG4uZ2V0KCdjb25zdGFudCcsICd5ZXMnKSA6ICcnKSksXHJcbiAgICAgICAgICAgICAgICBhZGRFbChtYWtlRWwoJ3RkJyksIG1ha2VUZXh0KGRhdGEuZGVzY3JpcHRpb24pKV0pO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIGZpbGxTaG9wVGFibGUgPSAoc2hvcERhdGEpID0+IHtcclxuICAgICAgICB2YXIgdGFibGUgPSBjbGVhckVsKHF1ZXJ5RWwoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwidGJvZHkudGFibGUtY29udGVudFwiKSk7XHJcbiAgICAgICAgdmFyIGRhdGEgPSBSLnVubmVzdChSLmtleXMoc2hvcERhdGEuY2F0ZWdvcmllcykubWFwKGNhdGVnb3J5TmFtZSA9PiB7XHJcbiAgICAgICAgICAgIHZhciBnbG9iYWxzID0gc2hvcERhdGEuY2F0ZWdvcmllc1tjYXRlZ29yeU5hbWVdLmdsb2JhbHM7XHJcbiAgICAgICAgICAgIHZhciBkYXRhID0gUi5rZXlzKGdsb2JhbHMpLm1hcChnbG9iYWwgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXRlZ29yeU5hbWU6IGNhdGVnb3J5TmFtZSxcclxuICAgICAgICAgICAgICAgICAgICBhc3NldE5hbWU6IGdsb2JhbCxcclxuICAgICAgICAgICAgICAgICAgICBkaXNwbGF5U3RyaW5nOiBzaG9wRGF0YS5nbG9iYWxBc3NldHNbZ2xvYmFsXS5kaXNwbGF5U3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgICAgIGNvc3Q6IGdsb2JhbHNbZ2xvYmFsXS5jb3N0LFxyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdnbG9iYWwnLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlc291cmNlQ29zdDogc2hvcERhdGEuZ2xvYmFsQXNzZXRzW2dsb2JhbF0ucmVzb3VyY2VDb3N0LFxyXG4gICAgICAgICAgICAgICAgICAgIGlzUGh5c2ljYWw6IHNob3BEYXRhLmdsb2JhbEFzc2V0c1tnbG9iYWxdLmlzUGh5c2ljYWwsXHJcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHNob3BEYXRhLmdsb2JhbEFzc2V0c1tnbG9iYWxdLmRlc2NyaXB0aW9uLFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHZhciBsb2NhbHMgPSBzaG9wRGF0YS5jYXRlZ29yaWVzW2NhdGVnb3J5TmFtZV0ubG9jYWxzO1xyXG4gICAgICAgICAgICBkYXRhID0gZGF0YS5jb25jYXQoUi5rZXlzKGxvY2FscykubWFwKGxvY2FsID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnlOYW1lOiBjYXRlZ29yeU5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgYXNzZXROYW1lOiBsb2NhbCxcclxuICAgICAgICAgICAgICAgICAgICBkaXNwbGF5U3RyaW5nOiBzaG9wRGF0YS5sb2NhbEFzc2V0c1tsb2NhbF0uZGlzcGxheVN0cmluZyxcclxuICAgICAgICAgICAgICAgICAgICBjb3N0OiBsb2NhbHNbbG9jYWxdLmNvc3QsXHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2xvY2FsJyxcclxuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZUNvc3Q6IDAsXHJcbiAgICAgICAgICAgICAgICAgICAgaXNQaHlzaWNhbDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHNob3BEYXRhLmxvY2FsQXNzZXRzW2xvY2FsXS5kZXNjcmlwdGlvbixcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgcmV0dXJuIGRhdGE7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIHZhciB1c2VkR2xvYmFscyA9IFIudW5pcShSLmZsYXR0ZW4oUi5rZXlzKHNob3BEYXRhLmNhdGVnb3JpZXMpLm1hcChjYXRlZ29yeU5hbWUgPT4gUi5rZXlzKHNob3BEYXRhLmNhdGVnb3JpZXNbY2F0ZWdvcnlOYW1lXS5nbG9iYWxzKSkpKTtcclxuICAgICAgICB2YXIgdXNlZExvY2FscyA9IFIudW5pcShSLmZsYXR0ZW4oUi5rZXlzKHNob3BEYXRhLmNhdGVnb3JpZXMpLm1hcChjYXRlZ29yeU5hbWUgPT4gUi5rZXlzKHNob3BEYXRhLmNhdGVnb3JpZXNbY2F0ZWdvcnlOYW1lXS5sb2NhbHMpKSkpO1xyXG4gICAgICAgIHZhciBhbGxHbG9iYWxzID0gUi5rZXlzKHNob3BEYXRhLmFzc2V0cyk7XHJcbiAgICAgICAgdmFyIGFsbExvY2FscyA9IFIua2V5cyhzaG9wRGF0YS5sb2NhbEFzc2V0cyk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgZGF0YSA9IFIuY29uY2F0KGRhdGEsIFIuZGlmZmVyZW5jZShhbGxHbG9iYWxzLCB1c2VkR2xvYmFscykubWFwKGdsb2JhbCA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBjYXRlZ29yeU5hbWU6IEwxMG4uZ2V0KCdzaG9wJywnbm90LWluLWNhdGVnb3J5JyksXHJcbiAgICAgICAgICAgICAgICBhc3NldE5hbWU6IGdsb2JhbCxcclxuICAgICAgICAgICAgICAgIGRpc3BsYXlTdHJpbmc6IHNob3BEYXRhLmdsb2JhbEFzc2V0c1tnbG9iYWxdLmRpc3BsYXlTdHJpbmcsXHJcbiAgICAgICAgICAgICAgICBjb3N0OiAtMSxcclxuICAgICAgICAgICAgICAgIHR5cGU6ICdnbG9iYWwnLFxyXG4gICAgICAgICAgICAgICAgcmVzb3VyY2VDb3N0OiBzaG9wRGF0YS5nbG9iYWxBc3NldHNbZ2xvYmFsXS5yZXNvdXJjZUNvc3QsXHJcbiAgICAgICAgICAgICAgICBpc1BoeXNpY2FsOiBzaG9wRGF0YS5nbG9iYWxBc3NldHNbZ2xvYmFsXS5pc1BoeXNpY2FsLFxyXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHNob3BEYXRhLmdsb2JhbEFzc2V0c1tnbG9iYWxdLmRlc2NyaXB0aW9uLFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIGRhdGEgPSBSLmNvbmNhdChkYXRhLCBSLmRpZmZlcmVuY2UoYWxsTG9jYWxzLCB1c2VkTG9jYWxzKS5tYXAobG9jYWwgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgY2F0ZWdvcnlOYW1lOiBMMTBuLmdldCgnc2hvcCcsJ25vdC1pbi1jYXRlZ29yeScpLFxyXG4gICAgICAgICAgICAgICAgYXNzZXROYW1lOiBsb2NhbCxcclxuICAgICAgICAgICAgICAgIGRpc3BsYXlTdHJpbmc6IHNob3BEYXRhLmxvY2FsQXNzZXRzW2xvY2FsXS5kaXNwbGF5U3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgY29zdDogLTEsXHJcbiAgICAgICAgICAgICAgICB0eXBlOiAnbG9jYWwnLFxyXG4gICAgICAgICAgICAgICAgcmVzb3VyY2VDb3N0OiAwLFxyXG4gICAgICAgICAgICAgICAgaXNQaHlzaWNhbDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogc2hvcERhdGEubG9jYWxBc3NldHNbbG9jYWxdLmRlc2NyaXB0aW9uLFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICB2YXIgc29ydEZ1bmMgPSBDb21tb25VdGlscy5jaGFyT3JkQUZhY3RvcnlCYXNlKHN0YXRlLnNvcnREaXIsIGZ1bmN0aW9uKGEpe1xyXG4gICAgICAgICAgICB2YXIgdmFsdWUgPSBhW2hlYWRBcnJbc3RhdGUuc29ydEtleV1dOyBcclxuICAgICAgICAgICAgaWYoUi5pcyhTdHJpbmcsIHZhbHVlKSl7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGFkZEVscyh0YWJsZSwgZGF0YS5maWx0ZXIobWFrZUZpbHRlckZ1bmMoKSkuc29ydChzb3J0RnVuYykubWFwKGRhdGEyc3RyKSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgbWFrZUZpbHRlckZ1bmMgPSAoKSA9PiB7XHJcbiAgICAgICAgdmFyIHZhbHVlcyA9IHF1ZXJ5RWxzKGNhdGVnb3J5Q29udGVudFJvb3QgKyBcInRoZWFkIHRyIGlucHV0XCIpLm1hcChSLnByb3AoJ3ZhbHVlJykpO1xyXG4gICAgICAgIHJldHVybiBmdW5jdGlvbihkYXRhKXtcclxuICAgICAgICAgICAgcmV0dXJuIGhlYWRBcnIuZXZlcnkoKGVsLCBpbmRleCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYodmFsdWVzW2luZGV4XS50cmltKCkgPT09ICcnKXtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBTdHJpbmcoZGF0YVtoZWFkQXJyW2luZGV4XV0pLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihTdHJpbmcodmFsdWVzW2luZGV4XSkudG9Mb3dlckNhc2UoKSkgIT0gLTE7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBhZGRHbG9iYWxBc3NldFRvQ2F0ZWdvcnkgPSAoKT0+e1xyXG4gICAgICAgIHZhciBhc3NldCA9IHF1ZXJ5RWwoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwiLmFkZC1lbnRpdHktc2VsZWN0LTExXCIpLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICB2YXIgY2F0ZWdvcnkgPSBxdWVyeUVsKGNhdGVnb3J5Q29udGVudFJvb3QgKyBcIi5hZGQtZW50aXR5LXNlbGVjdC0xMlwiKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgREJNUy5hZGRHbG9iYWxBc3NldFRvQ2F0ZWdvcnkoU2hvcE1hbmFnZW1lbnQuZ2V0Q3VycmVudFNob3BOYW1lKCksIGNhdGVnb3J5LCBhc3NldCwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgfTtcclxuICAgIHZhciBhZGRMb2NhbEFzc2V0VG9DYXRlZ29yeSA9ICgpPT57XHJcbiAgICAgICAgdmFyIGFzc2V0ID0gcXVlcnlFbChjYXRlZ29yeUNvbnRlbnRSb290ICsgXCIuYWRkLWVudGl0eS1zZWxlY3QtMjFcIikudmFsdWUudHJpbSgpO1xyXG4gICAgICAgIHZhciBjYXRlZ29yeSA9IHF1ZXJ5RWwoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwiLmFkZC1lbnRpdHktc2VsZWN0LTIyXCIpLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICBEQk1TLmFkZExvY2FsQXNzZXRUb0NhdGVnb3J5KFNob3BNYW5hZ2VtZW50LmdldEN1cnJlbnRTaG9wTmFtZSgpLCBjYXRlZ29yeSwgYXNzZXQsIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcclxuICAgIH07XHJcbiAgICB2YXIgcmVtb3ZlR2xvYmFsQXNzZXRGcm9tQ2F0ZWdvcnkgPSAoKT0+e1xyXG4gICAgICAgIHZhciBhcnIgPSBKU09OLnBhcnNlKHF1ZXJ5RWwoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwiLnJlbW92ZS1lbnRpdHktc2VsZWN0LTFcIikudmFsdWUudHJpbSgpKTtcclxuICAgICAgICBEQk1TLnJlbW92ZUdsb2JhbEFzc2V0RnJvbUNhdGVnb3J5KFNob3BNYW5hZ2VtZW50LmdldEN1cnJlbnRTaG9wTmFtZSgpLCBhcnJbMF0sIGFyclsxXSwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgfTtcclxuICAgIHZhciByZW1vdmVMb2NhbEFzc2V0RnJvbUNhdGVnb3J5ID0gKCk9PntcclxuICAgICAgICB2YXIgYXJyID0gSlNPTi5wYXJzZShxdWVyeUVsKGNhdGVnb3J5Q29udGVudFJvb3QgKyBcIi5yZW1vdmUtZW50aXR5LXNlbGVjdC0yXCIpLnZhbHVlLnRyaW0oKSk7XHJcbiAgICAgICAgREJNUy5yZW1vdmVMb2NhbEFzc2V0RnJvbUNhdGVnb3J5KFNob3BNYW5hZ2VtZW50LmdldEN1cnJlbnRTaG9wTmFtZSgpLCBhcnJbMF0sIGFyclsxXSwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgfTtcclxuXHJcbn0pKHRoaXNbJ0NhdGVnb3J5Q29udGVudE1hbmFnZW1lbnQnXT17fSk7IiwiLypDb3B5cmlnaHQgMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG52YXIgQXNzZXRQcm9maWxlVG1wbCA9IChmdW5jdGlvbihleHBvcnRzLCByb290LCBhc3NldFByb2ZpbGVTdHJ1Y3R1cmUsIGlzRWRpdGFibGUsIGdldEFzc2V0TmFtZXMsIHVwZGF0ZUFzc2V0RmllbGQsIGdldEFzc2V0KXtcclxuICAgIFxyXG4gICAgdmFyIHN0YXRlID0ge307XHJcbiAgICB2YXIgbDEwbiA9IEwxMG4uZ2V0KCdhc3NldCcpO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKHJvb3QgK1wiLmVudGl0eS1zZWxlY3RvclwiKSwgXCJjaGFuZ2VcIiwgc2hvd1Byb2ZpbGVJbmZvRGVsZWdhdGUpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHZhciB0Ym9keSA9IGNsZWFyRWwocXVlcnlFbChyb290ICsgXCIuZW50aXR5LXByb2ZpbGVcIikpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHN0YXRlLmlucHV0SXRlbXMgPSB7fTtcclxuICAgICAgICBcclxuICAgICAgICBDb25zdGFudHNbYXNzZXRQcm9maWxlU3RydWN0dXJlXS5mb3JFYWNoKGZ1bmN0aW9uIChwcm9maWxlU2V0dGluZ3MpIHtcclxuICAgICAgICAgICAgcHJvZmlsZVNldHRpbmdzLmRpc3BsYXlOYW1lID0gbDEwbihwcm9maWxlU2V0dGluZ3MubmFtZSk7XHJcbiAgICAgICAgICAgIGFkZEVsKHRib2R5LCBtYWtlSW5wdXQocHJvZmlsZVNldHRpbmdzKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMucmVmcmVzaCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIGdldEFzc2V0TmFtZXMoZnVuY3Rpb24oZXJyLCBuYW1lcyl7XHJcbiAgICAgICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XHJcbiAgICAgICAgICAgIHZhciBzZWwgPSBjbGVhckVsKHF1ZXJ5RWwocm9vdCArIFwiLmVudGl0eS1zZWxlY3RvclwiKSk7XHJcbiAgICAgICAgICAgIGZpbGxTZWxlY3RvcihzZWwsIG5hbWVzLm1hcChyZW1hcFByb3BzNFNlbGVjdCkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIG1ha2VJbnB1dCA9IGZ1bmN0aW9uIChwcm9maWxlSXRlbUNvbmZpZykge1xyXG4gICAgICAgIHZhciBzcGFuID0gc2V0QXR0cihtYWtlRWwoJ3NwYW4nKSwgXCJsMTBuLWlkXCIsIFwiYXNzZXQtXCIgKyBwcm9maWxlSXRlbUNvbmZpZy5uYW1lKTtcclxuICAgICAgICB2YXIgdHIgPSBhZGRFbChtYWtlRWwoXCJ0clwiKSwgYWRkRWwobWFrZUVsKCd0ZCcpLCBhZGRFbChzcGFuLCBtYWtlVGV4dChwcm9maWxlSXRlbUNvbmZpZy5kaXNwbGF5TmFtZSkpKSlcclxuICAgICAgICB2YXIgaW5wdXQ7XHJcbiAgICAgICAgc3dpdGNoIChwcm9maWxlSXRlbUNvbmZpZy50eXBlKSB7XHJcbiAgICAgICAgY2FzZSBcInRleHRcIjpcclxuICAgICAgICAgICAgaW5wdXQgPSBtYWtlRWwoXCJ0ZXh0YXJlYVwiKTtcclxuICAgICAgICAgICAgYWRkQ2xhc3MoaW5wdXQsIFwicHJvZmlsZVRleHRJbnB1dFwiKTtcclxuICAgICAgICAgICAgYWRkQ2xhc3MoaW5wdXQsJ2Zvcm0tY29udHJvbCcpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlIFwic3RyaW5nXCI6XHJcbiAgICAgICAgICAgIGlucHV0ID0gbWFrZUVsKFwiaW5wdXRcIik7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKGlucHV0LCBcInByb2ZpbGVTdHJpbmdJbnB1dFwiKTtcclxuICAgICAgICAgICAgYWRkQ2xhc3MoaW5wdXQsJ2Zvcm0tY29udHJvbCcpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlIFwibnVtYmVyXCI6XHJcbiAgICAgICAgICAgIGlucHV0ID0gbWFrZUVsKFwiaW5wdXRcIik7XHJcbiAgICAgICAgICAgIGlucHV0LnR5cGUgPSBcIm51bWJlclwiO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhpbnB1dCwnZm9ybS1jb250cm9sJyk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgXCJjaGVja2JveFwiOlxyXG4gICAgICAgICAgICBpbnB1dCA9IG1ha2VFbChcImlucHV0XCIpO1xyXG4gICAgICAgICAgICBpbnB1dC50eXBlID0gXCJjaGVja2JveFwiO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuZXhwZWN0ZWQgdHlwZSAnICsgcHJvZmlsZUl0ZW1Db25maWcudHlwZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlucHV0LnNlbGZOYW1lID0gcHJvZmlsZUl0ZW1Db25maWcubmFtZTtcclxuICAgICAgICBcclxuICAgICAgICBpZighaXNFZGl0YWJsZSl7XHJcbiAgICAgICAgICAgIHNldEF0dHIoaW5wdXQsICdkaXNhYmxlZCcsICd0cnVlJyk7XHJcbiAgICAgICAgfVxyXG4vLyAgICAgICAgYWRkQ2xhc3MoaW5wdXQsXCJpc0dyb3VwRWRpdGFibGVcIik7XHJcbiAgICAgICAgc3RhdGUuaW5wdXRJdGVtc1twcm9maWxlSXRlbUNvbmZpZy5uYW1lXSA9IGlucHV0O1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxpc3RlbihpbnB1dCwgXCJjaGFuZ2VcIiwgdXBkYXRlRmllbGRWYWx1ZShwcm9maWxlSXRlbUNvbmZpZy50eXBlKSk7XHJcbiAgICBcclxuICAgICAgICByZXR1cm4gYWRkRWwodHIsIGFkZEVsKG1ha2VFbCgndGQnKSwgaW5wdXQpKTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciB1cGRhdGVGaWVsZFZhbHVlID0gZnVuY3Rpb24odHlwZSl7XHJcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KXtcclxuICAgICAgICAgICAgdmFyIGZpZWxkTmFtZSA9IGV2ZW50LnRhcmdldC5zZWxmTmFtZTtcclxuICAgICAgICAgICAgdmFyIGFzc2V0TmFtZSA9IHN0YXRlLm5hbWU7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB2YXIgdmFsdWU7XHJcbiAgICAgICAgICAgIHN3aXRjaCh0eXBlKXtcclxuICAgICAgICAgICAgY2FzZSBcInRleHRcIjpcclxuICAgICAgICAgICAgY2FzZSBcInN0cmluZ1wiOlxyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSBldmVudC50YXJnZXQudmFsdWU7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcIm51bWJlclwiOlxyXG4gICAgICAgICAgICAgICAgaWYgKGlzTmFOKGV2ZW50LnRhcmdldC52YWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBVdGlscy5hbGVydChnZXRMMTBuKFwicHJvZmlsZXMtbm90LWEtbnVtYmVyXCIpKTtcclxuICAgICAgICAgICAgICAgICAgICBldmVudC50YXJnZXQudmFsdWUgPSBldmVudC50YXJnZXQub2xkVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSBOdW1iZXIoZXZlbnQudGFyZ2V0LnZhbHVlKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFwiY2hlY2tib3hcIjpcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gZXZlbnQudGFyZ2V0LmNoZWNrZWQ7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5leHBlY3RlZCB0eXBlICcgKyB0eXBlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB1cGRhdGVBc3NldEZpZWxkKGFzc2V0TmFtZSwgZmllbGROYW1lLCB2YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBzaG93UHJvZmlsZUluZm9EZWxlZ2F0ZSA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIHZhciBuYW1lID0gZXZlbnQudGFyZ2V0LnZhbHVlLnRyaW0oKTtcclxuICAgICAgICBnZXRBc3NldChuYW1lLCBzaG93UHJvZmlsZUluZm9DYWxsYmFjayk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgc2hvd1Byb2ZpbGVJbmZvQ2FsbGJhY2sgPSBmdW5jdGlvbiAoZXJyLCBhc3NldCkge1xyXG4gICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XHJcbiAgICAgICAgdmFyIG5hbWUgPSBhc3NldC5uYW1lO1xyXG4gICAgICAgIHN0YXRlLm5hbWUgPSBuYW1lO1xyXG4gICAgICAgIHZhciBpbnB1dEl0ZW1zID0gc3RhdGUuaW5wdXRJdGVtcztcclxuICAgICAgICBPYmplY3Qua2V5cyhpbnB1dEl0ZW1zKS5mb3JFYWNoKGZ1bmN0aW9uIChpbnB1dE5hbWUpIHtcclxuICAgICAgICAgICAgaWYgKGlucHV0SXRlbXNbaW5wdXROYW1lXS50eXBlID09PSBcImNoZWNrYm94XCIpIHtcclxuICAgICAgICAgICAgICAgIGlucHV0SXRlbXNbaW5wdXROYW1lXS5jaGVja2VkID0gYXNzZXRbaW5wdXROYW1lXTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlucHV0SXRlbXNbaW5wdXROYW1lXS52YWx1ZSA9IGFzc2V0W2lucHV0TmFtZV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaW5wdXRJdGVtc1tpbnB1dE5hbWVdLm9sZFZhbHVlID0gYXNzZXRbaW5wdXROYW1lXTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBcclxufSk7XHJcblxyXG5Bc3NldFByb2ZpbGVUbXBsKHRoaXNbJ0Fzc2V0UHJvZmlsZSddPXt9LCAnLmFzc2V0LXByb2ZpbGUtdGFiICcsICdhc3NldFByb2ZpbGVTdHJ1Y3R1cmUnLCB0cnVlLCAoY2FsbGJhY2spID0+IHtcclxuICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdhc3NldCcsIGZhbHNlLCBjYWxsYmFjayk7XHJcbn0sIChhc3NldE5hbWUsIGZpZWxkTmFtZSwgdmFsdWUsIGNhbGxiYWNrKSA9PiB7XHJcbiAgICBEQk1TLnVwZGF0ZUFzc2V0RmllbGQoYXNzZXROYW1lLCBmaWVsZE5hbWUsIHZhbHVlLCBjYWxsYmFjayk7XHJcbn0sIChuYW1lLCBjYWxsYmFjaykgPT4ge1xyXG4gICAgREJNUy5nZXRBc3NldChuYW1lLCBjYWxsYmFjayk7XHJcbn0pO1xyXG5cclxuQXNzZXRQcm9maWxlVG1wbCh0aGlzWydHbG9iYWxBc3NldFByb2ZpbGUnXT17fSwgJy5nbG9iYWwtYXNzZXQtcHJvZmlsZS10YWIgJywgJ2Fzc2V0UHJvZmlsZVN0cnVjdHVyZScsIGZhbHNlLCAoY2FsbGJhY2spID0+IHtcclxuICAgIHZhciBzaG9wTmFtZSA9IFNob3BNYW5hZ2VtZW50LmdldEN1cnJlbnRTaG9wTmFtZSgpO1xyXG4gICAgREJNUy5nZXRTaG9wKHNob3BOYW1lLCBmdW5jdGlvbihlcnIsIHNob3BEYXRhKXtcclxuICAgICAgICBpZihlcnIpIHtjYWxsYmFjayhlcnIpOyByZXR1cm47fVxyXG4gICAgICAgIHZhciBhc3NldHMgPSBSLmtleXMoc2hvcERhdGEuYXNzZXRzKS5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBKS5tYXAobmFtZSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBkaXNwbGF5TmFtZTogbmFtZSxcclxuICAgICAgICAgICAgICAgIHZhbHVlOiBuYW1lXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICBjYWxsYmFjayhudWxsLGFzc2V0cyk7XHJcbiAgICB9KTtcclxufSwgKGFzc2V0TmFtZSwgZmllbGROYW1lLCB2YWx1ZSwgY2FsbGJhY2spID0+IHtcclxuICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oJ2Vycm9ycy11bnN1cHBvcnRlZC1vcGVyYXRpb24nKSk7XHJcbn0sIChuYW1lLCBjYWxsYmFjaykgPT4ge1xyXG4gICAgREJNUy5nZXRBc3NldChuYW1lLCBjYWxsYmFjayk7XHJcbn0pO1xyXG5cclxuQXNzZXRQcm9maWxlVG1wbCh0aGlzWydMb2NhbEFzc2V0UHJvZmlsZSddPXt9LCAnLmxvY2FsLWFzc2V0LXByb2ZpbGUtdGFiICcsICdsb2NhbEFzc2V0UHJvZmlsZVN0cnVjdHVyZScsIHRydWUsIChjYWxsYmFjaykgPT4ge1xyXG4gICAgdmFyIHNob3BOYW1lID0gU2hvcE1hbmFnZW1lbnQuZ2V0Q3VycmVudFNob3BOYW1lKCk7XHJcbiAgICBEQk1TLmdldFNob3Aoc2hvcE5hbWUsIGZ1bmN0aW9uKGVyciwgc2hvcERhdGEpe1xyXG4gICAgICAgIGlmKGVycikge2NhbGxiYWNrKGVycik7IHJldHVybjt9XHJcbiAgICAgICAgdmFyIGxvY2FsQXNzZXRzID0gUi5rZXlzKHNob3BEYXRhLmxvY2FsQXNzZXRzKS5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBKS5tYXAobmFtZSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBkaXNwbGF5TmFtZTogbmFtZSxcclxuICAgICAgICAgICAgICAgIHZhbHVlOiBuYW1lXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICBjYWxsYmFjayhudWxsLGxvY2FsQXNzZXRzKTtcclxuICAgIH0pO1xyXG59LCAoYXNzZXROYW1lLCBmaWVsZE5hbWUsIHZhbHVlLCBjYWxsYmFjaykgPT4ge1xyXG4gICAgREJNUy51cGRhdGVMb2NhbEFzc2V0RmllbGQoU2hvcE1hbmFnZW1lbnQuZ2V0Q3VycmVudFNob3BOYW1lKCksIGFzc2V0TmFtZSwgZmllbGROYW1lLCB2YWx1ZSwgY2FsbGJhY2spO1xyXG59LCAobmFtZSwgY2FsbGJhY2spID0+IHtcclxuICAgIERCTVMuZ2V0TG9jYWxBc3NldChTaG9wTWFuYWdlbWVudC5nZXRDdXJyZW50U2hvcE5hbWUoKSwgbmFtZSwgKGVyciwgYXNzZXQpID0+IHtcclxuICAgICAgICBpZihlcnIpIHtjYWxsYmFjayhlcnIpOyByZXR1cm47fVxyXG4gICAgICAgIGFzc2V0Lm5hbWUgPSBuYW1lO1xyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIGFzc2V0KTtcclxuICAgIH0pO1xyXG59KTsiLCIvKkNvcHlyaWdodCAyMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG5cInVzZSBzdHJpY3RcIjtcclxuXHJcbnZhciBBYm91dCA9IHt9O1xyXG5cclxuQWJvdXQuaW5pdCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgQWJvdXQuY29udGVudCA9IGdldEVsKCdhYm91dERpdicpO1xyXG59O1xyXG5cclxuQWJvdXQucmVmcmVzaCA9IGZ1bmN0aW9uKCkge1xyXG59O1xyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
