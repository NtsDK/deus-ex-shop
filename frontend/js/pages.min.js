/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */


"use strict";

(function(exports){
    
    var root = ".enter-tab ";
    var url = window.location.href.substring(0, window.location.href.lastIndexOf('/')+1);
    
    exports.init = function () {
        $(document.forms['login-form']).on('submit', submit);
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {

    };
            
    var submit = function() {
        var form = $(this);

        $('.error', form).html('');
//        $(":submit", form).button("loading");

        var request = $.ajax({
            url : url + "login",
            method : "POST",
            data : form.serialize(),
            complete : function() {
                $(":submit", form).button("reset");
            },
//             statusCode : {
//                 200 : function() {
//                 },
//                 403 : function(jqXHR) {
//                     var error = JSON.parse(jqXHR.responseText);
//                     $('.error', form).html(error.message);
//                 }
//             }
        });
        request.done(function(data) {
//             //window.location.href = "/chat";
//             window.location.href = "/nims.html";
            window.location.href = url + "page.html";
        });
        
        request.fail(function(errorInfo, textStatus, errorThrown) {
            var msg;
            try {
                msg = Utils.handleErrorMsg(JSON.parse(errorInfo.responseText));
            } catch(err){
                msg = Utils.handleErrorMsg(errorInfo.responseText || textStatus || 'error');
            }
//             var error = JSON.parse(jqXHR.responseText);
//             $('.error', form).html(error.message); 
//            $('.error', form).html(textStatus); 
            $('.error', form).html(msg); 
        });
        
        return false;
    };
    
})(this['Enter']={});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

(function(exports){
    
    var root = '.-tab ';
    var state = {};

    exports.init = function() {
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {
    
    };

})(this['Template']={});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

(function(exports){
    
    var root = '.api-check-tab ';
    var state = {};
    var l10n = L10n.get('api-check');

    exports.init = function() {
        listen(queryEl(root + '.shop-check-button'), 'click', checkAPI('.shop-check-area', 'getShopsAPICheck'));
        listen(queryEl(root + '.implant-check-button'), 'click', checkAPI('.implant-check-area', 'getImplantsAPICheck'));
        listen(queryEl(root + '.pills-check-button'), 'click', checkAPI('.pills-check-area', 'getPillsAPICheck'));
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {
    };
    
    var checkAPI = R.curry((clazz,dbCall) => {
        return () => {
            clearEl(queryEl(root + clazz + ' .container'));
            DBMS[dbCall](function(err, arr){
                if(err) {Utils.handleError(err); return;}
                arr.sort(CommonUtils.charOrdAFactory(R.prop('name')))
                console.log(arr);
                var container = clearEl(queryEl(root + clazz + ' .container'));
                addEls(container, arr.map(makeStr));
            });
        }
    });
    
    var makeStr = (el) => {
        return addEls(setClassByCondition(makeEl('tr'), 'red-row', !(200 <= el.statusCode && el.statusCode < 300)), [
            addEl(makeEl('td'), makeText(el.name)                     ),
            addEl(makeEl('td'), makeText(el.statusCode)               ),
            addEl(makeEl('td'), makeText(l10n(String(el.statusCode))) )
        ]);
    };

})(this['ApiCheck']={});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

(function(exports){
    
    var root = '.asset-presence-tab ';
    var assetSelectContainer = root +'.asset-select-container ';
    var shopSelectContainer = root +'.shop-select-container ';
    var state = {};

    exports.init = function() {
        listen(queryEl(root + '.show-asset-select'), "change", UI.showSelectedEls("-row-dependent"));
        listen(queryEl(assetSelectContainer + '.select-all-button'), "click", makeSelectAllFun(root + '.show-asset-select', UI.showSelectedEls("-row-dependent"), true));
        listen(queryEl(assetSelectContainer + '.deselect-all-button'), "click", makeSelectAllFun(root + '.show-asset-select', UI.showSelectedEls("-row-dependent"), false));
        
        listen(queryEl(root + '.show-shop-select'), "change", UI.showSelectedEls("-col-dependent"));
        listen(queryEl(shopSelectContainer + '.select-all-button'), "click", makeSelectAllFun(root + '.show-shop-select', UI.showSelectedEls("-col-dependent"), true));
        listen(queryEl(shopSelectContainer + '.deselect-all-button'), "click", makeSelectAllFun(root + '.show-shop-select', UI.showSelectedEls("-col-dependent"), false));
        
        exports.content = queryEl(root);
    };
    
    var makeSelectAllFun = (selector, callback, value) => {
        return () => {
            nl2array(queryEl(selector).options).filter(opt => !hasClass(opt,'hidden')).forEach( option => option.selected = value);
            callback({target:queryEl(selector)});
        };
    };
    
    exports.refresh = function() {
        PermissionInformer.getEntityNamesArray('asset', true, function(err, assetNames){
            if(err) {Utils.handleError(err); return;}
            DBMS.getShopAssets(function(err, shopAssets){
                if(err) {Utils.handleError(err); return;}
            
            
//                fillSelector(clearEl(queryEl(root + ".show-asset-select")), assetNames.map(remapProps4Select));
                fillSelector(clearEl(queryEl(root + ".show-asset-select")), assetNames.map(asset => R.zipObj(['name','selected'], [asset.value, true])));
                fillSelector(clearEl(queryEl(root + ".show-shop-select")), shopAssets.map(shop => R.zipObj(['name','selected'], [shop.name, true])));
                
                setAttr(queryEl(root + ".show-asset-select"), 'size', assetNames.length > 15 ? 15 : assetNames.length);  
                setAttr(queryEl(root + ".show-shop-select"), 'size', shopAssets.length > 15 ? 15 : shopAssets.length);  
                
                var head = clearEl(queryEl(root + ".asset-presence-table-head"));
                var body = clearEl(queryEl(root + ".asset-presence-table-body"));
                
                addEl(head, makeTableHead(shopAssets));
                addEls(body, assetNames.map( (asset, i) => makeTableInput(asset, i, shopAssets)));
            });
        });
    };
    
    var makeTableHead = function (shopAssets) {
        var els = shopAssets.map((item, i) => addClass(addEl(makeEl("th"),makeText(item.name)), i + "-col-dependent"));
        return addEls(makeEl("tr"), [makeEl("th")].concat(els));
    };
    
    var makeTableInput = function (asset, i, shopAssets) {
        var tr = makeEl("tr");
        var td = makeEl("td");
        td.appendChild(makeText(asset.value));
        tr.appendChild(td);
        addClass(tr, i + "-row-dependent");

        shopAssets.forEach( (shopAssetData, j) => {
            td = addClass(makeEl("td"),'vertical-aligned-td');
            addClass(td, j + "-col-dependent");
            var input = makeEl("input");
//            addClass(input, "isStoryEditable");
            input.type = "checkbox";
            if (shopAssetData.assets[asset.value]) {
                input.checked = true;
            }
//            input.eventIndex = i;
//            input.eventName = event.name;
            input.assetName = asset.value;
            input.shopName = shopAssetData.name;
//            input.hasText = event.characters[character] != null && event.characters[character].text != "";
            listen(input, "change", onChangeCharacterCheckbox);
            
            var id = i+shopAssetData.name;
            setAttr(input, 'id', id);
            addClass(input, 'hidden');
            addEl(td, input);
            var label = addClass(makeEl('label'),'checkbox-label');
            setAttr(label, 'for', id);
            addEl(td, label);
            
            tr.appendChild(td);
        });
        
        return tr;
    };
    
    var onChangeCharacterCheckbox = (event)=>{
        var target = event.target;
        if (target.checked) {
//            Utils.confirm(strFormat(getL10n('asset-confirm-adding-asset'), [target.assetName, target.shopName]), () => {  
                DBMS.addAssetToShop(target.assetName, target.shopName, Utils.processError());
//            }, () => target.checked = !target.checked); 
        } else {
//            Utils.confirm(strFormat(getL10n('asset-confirm-removing-asset'), [target.assetName, target.shopName]), () => {  
                DBMS.removeAssetFromShop(target.assetName, target.shopName, Utils.processError());
//            }, () => target.checked = !target.checked); 
        }
    }

})(this['AssetPresence']={});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

var AssetProfileTmpl = (function(exports, root, assetProfileStructure, isEditable, getAssetNames, updateAssetField, getAsset){
    
    var state = {};
    var l10n = L10n.get('asset');

    exports.init = function() {
        listen(queryEl(root +".entity-selector"), "change", showProfileInfoDelegate);
        
        var tbody = clearEl(queryEl(root + ".entity-profile"));
        
        state.inputItems = {};
        
        Constants[assetProfileStructure].forEach(function (profileSettings) {
            profileSettings.displayName = l10n(profileSettings.name);
            addEl(tbody, makeInput(profileSettings));
        });
        
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {
        getAssetNames(function(err, names){
            if(err) {Utils.handleError(err); return;}
            var sel = clearEl(queryEl(root + ".entity-selector"));
            fillSelector(sel, names.map(remapProps4Select));
        });
    };
    
    var makeInput = function (profileItemConfig) {
        var span = setAttr(makeEl('span'), "l10n-id", "asset-" + profileItemConfig.name);
        var tr = addEl(makeEl("tr"), addEl(makeEl('td'), addEl(span, makeText(profileItemConfig.displayName))))
        var input;
        switch (profileItemConfig.type) {
        case "text":
            input = makeEl("textarea");
            addClass(input, "profileTextInput");
            addClass(input,'form-control');
            break;
        case "string":
            input = makeEl("input");
            addClass(input, "profileStringInput");
            addClass(input,'form-control');
            break;
        case "number":
            input = makeEl("input");
            input.type = "number";
            addClass(input,'form-control');
            break;
        case "checkbox":
            input = makeEl("input");
            input.type = "checkbox";
            break;
        default:
            throw new Error('Unexpected type ' + profileItemConfig.type);
        }
        input.selfName = profileItemConfig.name;
        
        if(!isEditable){
            setAttr(input, 'disabled', 'true');
        }
//        addClass(input,"isGroupEditable");
        state.inputItems[profileItemConfig.name] = input;
        
        listen(input, "change", updateFieldValue(profileItemConfig.type));
    
        return addEl(tr, addEl(makeEl('td'), input));
    };
    
    var updateFieldValue = function(type){
        return function(event){
            var fieldName = event.target.selfName;
            var assetName = state.name;
            
            var value;
            switch(type){
            case "text":
            case "string":
                value = event.target.value;
                break;
            case "number":
                if (isNaN(event.target.value)) {
                    Utils.alert(getL10n("profiles-not-a-number"));
                    event.target.value = event.target.oldValue;
                    return;
                }
                value = Number(event.target.value);
                break;
            case "checkbox":
                value = event.target.checked;
                break;
            default:
                throw new Error('Unexpected type ' + type);
            }
            updateAssetField(assetName, fieldName, value, Utils.processError());
        }
    };
    
    var showProfileInfoDelegate = function (event) {
        var name = event.target.value.trim();
        getAsset(name, showProfileInfoCallback);
    };
    
    var showProfileInfoCallback = function (err, asset) {
        if(err) {Utils.handleError(err); return;}
        var name = asset.name;
        state.name = name;
        var inputItems = state.inputItems;
        Object.keys(inputItems).forEach(function (inputName) {
            if (inputItems[inputName].type === "checkbox") {
                inputItems[inputName].checked = asset[inputName];
            } else {
                inputItems[inputName].value = asset[inputName];
            }
            inputItems[inputName].oldValue = asset[inputName];
        });
    };
    
});

AssetProfileTmpl(this['AssetProfile']={}, '.asset-profile-tab ', 'assetProfileStructure', true, (callback) => {
    PermissionInformer.getEntityNamesArray('asset', false, callback);
}, (assetName, fieldName, value, callback) => {
    DBMS.updateAssetField(assetName, fieldName, value, callback);
}, (name, callback) => {
    DBMS.getAsset(name, callback);
});

AssetProfileTmpl(this['GlobalAssetProfile']={}, '.global-asset-profile-tab ', 'assetProfileStructure', false, (callback) => {
    var shopName = ShopManagement.getCurrentShopName();
    DBMS.getShop(shopName, function(err, shopData){
        if(err) {callback(err); return;}
        var assets = R.keys(shopData.assets).sort(CommonUtils.charOrdA).map(name => {
            return {
                displayName: name,
                value: name
            }
        });
        callback(null,assets);
    });
}, (assetName, fieldName, value, callback) => {
    Utils.alert(getL10n('errors-unsupported-operation'));
}, (name, callback) => {
    DBMS.getAsset(name, callback);
});

AssetProfileTmpl(this['LocalAssetProfile']={}, '.local-asset-profile-tab ', 'localAssetProfileStructure', true, (callback) => {
    var shopName = ShopManagement.getCurrentShopName();
    DBMS.getShop(shopName, function(err, shopData){
        if(err) {callback(err); return;}
        var localAssets = R.keys(shopData.localAssets).sort(CommonUtils.charOrdA).map(name => {
            return {
                displayName: name,
                value: name
            }
        });
        callback(null,localAssets);
    });
}, (assetName, fieldName, value, callback) => {
    DBMS.updateLocalAssetField(ShopManagement.getCurrentShopName(), assetName, fieldName, value, callback);
}, (name, callback) => {
    DBMS.getLocalAsset(ShopManagement.getCurrentShopName(), name, (err, asset) => {
        if(err) {callback(err); return;}
        asset.name = name;
        callback(null, asset);
    });
});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

(function(exports){

    var state = {};
    var root = '.assets-tab ';
    var currentShop = undefined;
    
    exports.init = function () {
        state.views = {};
        var nav = root + ".sub-tab-navigation";
        var content = root + ".sub-tab-content";
        var containers = {
            root: state,
            navigation: queryEl(nav),
            content: queryEl(content)
        };
//        Utils.addView(containers, "shop-editor", ShopEditor,{mainPage:true});
//        Utils.addView(containers, "shop-view", ShopView);
//        Utils.addView(containers, "shop-binding", ShopBinding);
        Utils.addView(containers, "asset-profile", AssetProfile, {mainPage:true});
        Utils.addView(containers, "asset-presence", AssetPresence);
    
        listen(queryEl(root + ".create-entity-button"), "click", createProfile());
        listen(queryEl(root + ".rename-entity-button"), "click", renameProfile());
        listen(queryEl(root + ".remove-entity-button"), "click", removeProfile());
        
        listen(queryEl(root + ".import-implants-button"), "click", importImplants);
        listen(queryEl(root + ".import-pills-button"), "click", importPills);
//        $("#assetSelector").select2().on("change", onShopSelectorChangeDelegate);

        exports.content = queryEl(root);
    };
    
    exports.refresh = function () {
        PermissionInformer.getEntityNamesArray('asset', true, function(err, entityNames){
            if(err) {Utils.handleError(err); return;}
            rebuildInterface(entityNames);
            state.currentView.refresh();
        });
    };
    
    exports.getCurrentShop = () => currentShop;
    
    var onShopSelectorChangeDelegate = (event) =>{
        currentShop = event.target.value;
//        state.currentView.refresh();
//        exports.refresh();
    };
    
    var rebuildInterface = function (names) {
//        if(names.length === 0){
//            currentShop = undefined;
//        } else {
//            if(currentShop !== undefined){
//                if(R.find(R.equals(currentShop), names.map(R.prop('value'))) === undefined){
//                    currentShop = names[0].value;
//                }
//            } else {
//                currentShop = names[0].value;
//            }
//        }
        var data = getSelect2Data(names);
//        
//        clearEl(queryEl( "#assetSelector"));
//        if(currentShop === undefined){
//            $("#assetSelector").select2(data);
//        } else {
//            $("#assetSelector").select2(data).val(currentShop).trigger('change');
////            $("#shopSelector").select2(data).val(currentShop);
//        }
        
        clearEl(queryEl(root + ".rename-entity-select"));
        $(root + ".rename-entity-select").select2(data);
        
        clearEl(queryEl(root + ".remove-entity-select"));
        $(root + ".remove-entity-select").select2(data);
    };
    
    var importImplants = () => {
        DBMS.importImplants(function(err){
            if(err) {Utils.handleError(err); return;}
            exports.refresh();
        });
    };
    
    var importPills = () => {
        DBMS.importPills(function(err){
            if(err) {Utils.handleError(err); return;}
            exports.refresh();
        });
    };
    
    var createProfile = function () {
        return function(){
            var input = queryEl(root + ".create-entity-input");
            var name = input.value.trim();
            
            DBMS.createAsset(name, function(err){
                if(err) {Utils.handleError(err); return;}
                PermissionInformer.refresh(function(err){
                    if(err) {Utils.handleError(err); return;}
//                    if(state.currentView.updateSettings){
//                        state.currentView.updateSettings(name);
//                    }
                    input.value = '';
                    exports.refresh();
                });
            });
        }
    };
    
    var renameProfile = function () {
        return function(){
            var toInput = queryEl(root + ".rename-entity-input");
            var fromName = queryEl(root + ".rename-entity-select").value.trim();
            var toName = toInput.value.trim();
        
            DBMS.renameAsset(fromName, toName, function(err){
                if(err) {Utils.handleError(err); return;}
                PermissionInformer.refresh(function(err){
                    if(err) {Utils.handleError(err); return;}
                    toInput.value = '';
//                    if(state.currentView.updateSettings){
//                        state.currentView.updateSettings(type, toName);
//                    }
                    exports.refresh();
                });
            });
        }
    };
    
    var removeProfile = function () {
        return function(){
            var name = queryEl(root + ".remove-entity-select").value.trim();
        
            Utils.confirm(strFormat(getL10n("asset-are-you-sure-about-asset-removing"),[name]), () => {
                DBMS.removeAsset(name, function(err){
                    if(err) {Utils.handleError(err); return;}
                    PermissionInformer.refresh(function(err){
                        if(err) {Utils.handleError(err); return;}
                        exports.refresh();
                    });
                });
            });
        }
    };

})(this['Assets']={});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

(function(exports){
    
    var root = '.category-content-management-tab ';
    var categoryContentRoot = root + '.category-content-management ';
    var state = {};
    state.sortKey = 0;
    state.sortDir = "asc";

    var headArr = [ 'categoryName',
        'assetName',
        'displayString',
        'cost',
        'type',
        'resourceCost',
        'isPhysical',
        'description' ];

    exports.init = function() {
        listen(queryEl(categoryContentRoot + ".add-entity-button-1"),"click", addGlobalAssetToCategory);
        listen(queryEl(categoryContentRoot + ".add-entity-button-2"),"click", addLocalAssetToCategory);
        listen(queryEl(categoryContentRoot + ".remove-entity-button-1"),"click", removeGlobalAssetFromCategory);
        listen(queryEl(categoryContentRoot + ".remove-entity-button-2"),"click", removeLocalAssetFromCategory);
        
        initSortIcons();
        queryEls(categoryContentRoot + "thead tr input").map(listen(R.__, 'input', exports.refresh));
        
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {
        var shopName = ShopManagement.getCurrentShopName();
        DBMS.getShop(shopName, function(err, shopData){
            if(err) {Utils.handleError(err); return;}
            
            var data = arr2Select2(R.keys(shopData.categories).sort(CommonUtils.charOrdA));
            
            clearEl(queryEl(categoryContentRoot + ".add-entity-select-12"));
            $(categoryContentRoot + ".add-entity-select-12").select2(data);
            
            clearEl(queryEl(categoryContentRoot + ".add-entity-select-22"));
            $(categoryContentRoot + ".add-entity-select-22").select2(data);

            var globalAssets = arr2Select2(R.keys(shopData.assets));
//            globalAssets.placeholder = "Select an option";
            clearEl(queryEl(categoryContentRoot + ".add-entity-select-11"));
            $(categoryContentRoot + ".add-entity-select-11").select2((globalAssets));
            
            var localAssets = arr2Select2(R.keys(shopData.localAssets));
            clearEl(queryEl(categoryContentRoot + ".add-entity-select-21"));
            $(categoryContentRoot + ".add-entity-select-21").select2((localAssets));
            
            var getList = (container) => {
                return R.unnest(R.keys(shopData.categories).map(categoryName => {
                    return R.keys(shopData.categories[categoryName][container]).map(assetName => [categoryName, assetName])
                }));
            }
            var assets = getList('globals').map( arr => R.zipObj(['displayName','value'], [arr[0] + '/' + arr[1], JSON.stringify(arr)]));
            assets.sort(CommonUtils.charOrdAFactory(R.prop('displayName')))
            clearEl(queryEl(categoryContentRoot + ".remove-entity-select-1"));
            $(categoryContentRoot + ".remove-entity-select-1").select2(getSelect2Data(assets));
            
            var assets = getList('locals').map( arr => R.zipObj(['displayName','value'], [arr[0] + '/' + arr[1], JSON.stringify(arr)]));
            assets.sort(CommonUtils.charOrdAFactory(R.prop('displayName')))
            clearEl(queryEl(categoryContentRoot + ".remove-entity-select-2"));
            $(categoryContentRoot + ".remove-entity-select-2").select2(getSelect2Data(assets));
            
            fillShopTable(shopData);
        });
    };
    
    var initSortIcons = () => {
        var icons = queryEls(categoryContentRoot + "thead tr.first-row th");
        icons.map((icon, i) => {
            icon.index = i;
            listen(icon, "click", onSortChange);
        });
    };
    
    var onSortChange = function (event) {
        var target = event.target;
        if(target.tagName.toLowerCase() === "span"){
            target = target.parentElement;
        }
        
        if (state.sortKey === target.index) {
            state.sortDir = state.sortDir === "asc" ? "desc" : "asc";
            setClassByCondition(target, 'sortDesc', state.sortDir === 'desc');
            setClassByCondition(target, 'sortAsc', state.sortDir === 'asc');
        } else {
            var filterHead = queryEl(categoryContentRoot + "thead");
            nl2array(filterHead.getElementsByClassName("sortAsc")).forEach(removeClass(R.__, "sortAsc"));
            nl2array(filterHead.getElementsByClassName("sortDesc")).forEach(removeClass(R.__, "sortDesc"));
            
            state.sortKey = target.index;
            state.sortDir = "asc";
            addClass(target, "sortAsc");
        }
        exports.refresh();
    };
    
    var data2str = (data) => {
        if(data.cost !== -1){
            var input = addClass(makeEl('input'),'form-control');
            setAttr(input, 'type', 'number');
            setAttr(input, 'min', '0');
            input.value = data.cost;
            listen(input, "change", (event) => {
                DBMS.setAssetCost(ShopManagement.getCurrentShopName(), data.type, data.categoryName, data.assetName, Number(event.target.value), Utils.processError());
            });
        } else {
            input = makeText('');
        }
        return addEls(makeEl('tr'), [addEl(makeEl('td'), makeText(data.categoryName)),
                addEl(makeEl('td'), makeText(data.assetName)),
                addEl(makeEl('td'), makeText(data.displayString)),
                addEl(makeEl('td'), input),
//                addEl(makeEl('td'), makeText(data.cost)),
                addEl(makeEl('td'), makeText(data.type)),
                addEl(makeEl('td'), makeText(data.resourceCost)),
                addEl(makeEl('td'), makeText(data.isPhysical ? L10n.get('constant', 'yes') : '')),
                addEl(makeEl('td'), makeText(data.description))]);
    };
    
    var fillShopTable = (shopData) => {
        var table = clearEl(queryEl(categoryContentRoot + "tbody.table-content"));
        var data = R.unnest(R.keys(shopData.categories).map(categoryName => {
            var globals = shopData.categories[categoryName].globals;
            var data = R.keys(globals).map(global => {
                return {
                    categoryName: categoryName,
                    assetName: global,
                    displayString: shopData.globalAssets[global].displayString,
                    cost: globals[global].cost,
                    type: 'global',
                    resourceCost: shopData.globalAssets[global].resourceCost,
                    isPhysical: shopData.globalAssets[global].isPhysical,
                    description: shopData.globalAssets[global].description,
                }
            });
            
            var locals = shopData.categories[categoryName].locals;
            data = data.concat(R.keys(locals).map(local => {
                return {
                    categoryName: categoryName,
                    assetName: local,
                    displayString: shopData.localAssets[local].displayString,
                    cost: locals[local].cost,
                    type: 'local',
                    resourceCost: 0,
                    isPhysical: false,
                    description: shopData.localAssets[local].description,
                }
            }));
            
            return data;
        }));
        var usedGlobals = R.uniq(R.flatten(R.keys(shopData.categories).map(categoryName => R.keys(shopData.categories[categoryName].globals))));
        var usedLocals = R.uniq(R.flatten(R.keys(shopData.categories).map(categoryName => R.keys(shopData.categories[categoryName].locals))));
        var allGlobals = R.keys(shopData.assets);
        var allLocals = R.keys(shopData.localAssets);
        
        data = R.concat(data, R.difference(allGlobals, usedGlobals).map(global => {
            return {
                categoryName: L10n.get('shop','not-in-category'),
                assetName: global,
                displayString: shopData.globalAssets[global].displayString,
                cost: -1,
                type: 'global',
                resourceCost: shopData.globalAssets[global].resourceCost,
                isPhysical: shopData.globalAssets[global].isPhysical,
                description: shopData.globalAssets[global].description,
            }
        }));
        data = R.concat(data, R.difference(allLocals, usedLocals).map(local => {
            return {
                categoryName: L10n.get('shop','not-in-category'),
                assetName: local,
                displayString: shopData.localAssets[local].displayString,
                cost: -1,
                type: 'local',
                resourceCost: 0,
                isPhysical: false,
                description: shopData.localAssets[local].description,
            }
        }));

        var sortFunc = CommonUtils.charOrdAFactoryBase(state.sortDir, function(a){
            var value = a[headArr[state.sortKey]]; 
            if(R.is(String, value)){
                value = value.toLowerCase();
            }
            return value;
        });
        addEls(table, data.filter(makeFilterFunc()).sort(sortFunc).map(data2str));
    };
    
    var makeFilterFunc = () => {
        var values = queryEls(categoryContentRoot + "thead tr input").map(R.prop('value'));
        return function(data){
            return headArr.every((el, index) => {
                if(values[index].trim() === ''){
                    return true;
                }
                return String(data[headArr[index]]).toLowerCase().indexOf(String(values[index]).toLowerCase()) != -1;
            })
        };
    };
    
    var addGlobalAssetToCategory = ()=>{
        var asset = queryEl(categoryContentRoot + ".add-entity-select-11").value.trim();
        var category = queryEl(categoryContentRoot + ".add-entity-select-12").value.trim();
        DBMS.addGlobalAssetToCategory(ShopManagement.getCurrentShopName(), category, asset, Utils.processError(exports.refresh));
    };
    var addLocalAssetToCategory = ()=>{
        var asset = queryEl(categoryContentRoot + ".add-entity-select-21").value.trim();
        var category = queryEl(categoryContentRoot + ".add-entity-select-22").value.trim();
        DBMS.addLocalAssetToCategory(ShopManagement.getCurrentShopName(), category, asset, Utils.processError(exports.refresh));
    };
    var removeGlobalAssetFromCategory = ()=>{
        var arr = JSON.parse(queryEl(categoryContentRoot + ".remove-entity-select-1").value.trim());
        DBMS.removeGlobalAssetFromCategory(ShopManagement.getCurrentShopName(), arr[0], arr[1], Utils.processError(exports.refresh));
    };
    var removeLocalAssetFromCategory = ()=>{
        var arr = JSON.parse(queryEl(categoryContentRoot + ".remove-entity-select-2").value.trim());
        DBMS.removeLocalAssetFromCategory(ShopManagement.getCurrentShopName(), arr[0], arr[1], Utils.processError(exports.refresh));
    };

})(this['CategoryContentManagement']={});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

(function(exports){
    
    var root = '.shop-about-tab ';
    var state = {};
    var l10n = L10n.get('shop');

    exports.init = function() {
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {
        var shopName = ShopManagement.getCurrentShopName();
        DBMS.getShop(shopName, function(err, shopData){
            if(err) {Utils.handleError(err); return;}
            var body = clearEl(queryEl(root + '.shop-info-table-body'));
            var el1 = addEls(makeEl('tr'), [ addEl(makeEl('td'), addEl(makeEl('span'), makeText(l10n('corporation-name')))),
                                             addEl(makeEl('td'), addEl(makeEl('span'), makeText(shopData.corporation)))])
            var el2 = addEls(makeEl('tr'), [ addEl(makeEl('td'), addEl(makeEl('span'), makeText(l10n('legal-body')))),
                                             addEl(makeEl('td'), addEl(makeEl('span'), makeText(shopData.sellerLogin)))])
            addEls(body, [el1, el2]);
        });
    };

})(this['ShopAbout']={});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

var ShopManagement = {};

var ShopManagementTmpl = (function(exports, enableShopSelect, shopShopWindow){
    
    var root = '.shop-management-tab ';
    var categoryRoot = root + '.category-management ';
    var localAssetRoot = root + '.local-asset-management ';
    var categoryContentRoot = root + '.category-content-management ';
    var state = {};

    exports.init = function() {
        state.views = {};
        var nav = root + ".sub-tab-navigation";
        var content = root + ".sub-tab-content";
        var containers = {
            root: state,
            navigation: queryEl(nav),
            content: queryEl(content)
        };
        Utils.addView(containers, "category-content-management", CategoryContentManagement, {mainPage:true});
        Utils.addView(containers, "local-asset-profile", LocalAssetProfile);
        Utils.addView(containers, "global-asset-profile", GlobalAssetProfile);
        if(shopShopWindow){
            Utils.addView(containers, "shop-window", ShopWindow);
        }
        
        listen(queryEl(categoryRoot + ".create-entity-button"),"click", createCategory);
        listen(queryEl(categoryRoot + ".rename-entity-button"),"click", renameCategory);
        listen(queryEl(categoryRoot + ".remove-entity-button"),"click", removeCategory);
        
        listen(queryEl(localAssetRoot + ".create-entity-button"),"click", createLocalAsset);
        listen(queryEl(localAssetRoot + ".rename-entity-button"),"click", renameLocalAsset);
        listen(queryEl(localAssetRoot + ".remove-entity-button"),"click", removeLocalAsset);
        
        ShopManagement.getCurrentShopName = () => state.shopName;
        
        if(enableShopSelect){
            $(root + ".shop-select").select2().on("change", buildContentDelegate);
        }
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {
        if(enableShopSelect){
            clearEl(queryEl(root + ".shop-select"));
            
            PermissionInformer.getEntityNamesArray('shop', true, function(err, entityNames){
                if(err) {Utils.handleError(err); return;}
                
                var data = getSelect2Data(entityNames);
                if(entityNames.length > 0){
                    if(state.shopName != undefined && R.contains(state.shopName, entityNames.map(R.prop('value')))){
                        $(root + ".shop-select").select2(data).val(state.shopName).trigger('change');
                    } else {
                        $(root + ".shop-select").select2(data).val(entityNames[0].value).trigger('change');
                    }
                } else {
                    $(root + ".shop-select").select2(data);
                }
            });
        } else {
            DBMS.getShopName(function(err, shopName){
                if(err) {Utils.handleError(err); return;}
                state.shopName = shopName;
                buildContent(shopName);
            });
        }
    };
    
    var buildContentDelegate = (event) => buildContent(event.target.value);
    
    exports.getCurrentShopName = () => state.shopName;
    
    var buildContent = (shopName) => {
        state.shopName = shopName;
        DBMS.getShop(shopName, function(err, shopData){
            if(err) {Utils.handleError(err); return;}
            
            var data = arr2Select2(R.keys(shopData.categories).sort(CommonUtils.charOrdA));
            clearEl(queryEl(categoryRoot + ".rename-entity-select"));
            $(categoryRoot + ".rename-entity-select").select2(data);
            clearEl(queryEl(categoryRoot + ".remove-entity-select"));
            $(categoryRoot + ".remove-entity-select").select2(data);
            
            data = arr2Select2(R.keys(shopData.localAssets).sort(CommonUtils.charOrdA));
            clearEl(queryEl(localAssetRoot + ".rename-entity-select"));
            $(localAssetRoot + ".rename-entity-select").select2(data);
            clearEl(queryEl(localAssetRoot + ".remove-entity-select"));
            $(localAssetRoot + ".remove-entity-select").select2(data);
            
            state.currentView.refresh();
//            DBMS.getShopIndex(shopName, function(err, index){
//                if(err) {Utils.handleError(err); return;}
//                addEl(clearEl(queryEl(root + ".third-panel")), setAttr(addEl(makeEl('h2'), makeText(index)), 'style', 'text-align: center;'));
//            });
        });
        
    };
    
    var createCategory = function () {
        var input = queryEl(categoryRoot + ".create-entity-input");
        DBMS.createCategory(state.shopName, input.value.trim(), Utils.processError(function(){
            input.value = '';
            exports.refresh();
        }));
    };
    
    var renameCategory = function () {
        var toInput = queryEl(categoryRoot + ".rename-entity-input");
        var fromName = queryEl(categoryRoot + ".rename-entity-select").value.trim();
        var toName = toInput.value.trim();
        DBMS.renameCategory(state.shopName, fromName, toName, function(err){
            if(err) {Utils.handleError(err); return;}
            toInput.value = '';
            exports.refresh();
        });
    };
    
    var removeCategory = function () {
        var name = queryEl(categoryRoot + ".remove-entity-select").value.trim();
        Utils.confirm(strFormat(getL10n('shop-confirm-category-remove'), [name]), () => {
            DBMS.removeCategory(state.shopName, name, Utils.processError(exports.refresh));
        });
    };
    
    var createLocalAsset = function () {
        var input = queryEl(localAssetRoot + ".create-entity-input");
        DBMS.createLocalAsset(state.shopName, input.value.trim(), Utils.processError(function(){
            input.value = '';
            exports.refresh();
        }));
    };
    
    var renameLocalAsset = function () {
        var toInput = queryEl(localAssetRoot + ".rename-entity-input");
        var fromName = queryEl(localAssetRoot + ".rename-entity-select").value.trim();
        var toName = toInput.value.trim();
        DBMS.renameLocalAsset(state.shopName, fromName, toName, function(err){
            if(err) {Utils.handleError(err); return;}
            toInput.value = '';
            exports.refresh();
        });
    };
    
    var removeLocalAsset = function () {
        var name = queryEl(localAssetRoot + ".remove-entity-select").value.trim();
        Utils.confirm(strFormat(getL10n('shop-confirm-local-asset-remove'), [name]), () => {
            DBMS.removeLocalAsset(state.shopName, name, Utils.processError(exports.refresh));
        });
    };

});

ShopManagementTmpl(this['MasterShopManagement']={}, true, true);

ShopManagementTmpl(this['PlayerShopManagement']={}, false, false);

//(this['ShopManagement']={});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

(function(exports){
    
    var root = '.shop-passwords-tab ';
    var state = {};

    exports.init = function() {
        listen(queryEl(root + '.show-passwords-button'), 'click', onShowPasswords);
        
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {
        clearEl(queryEl(root + '.shop-passwords-table-body'));
    };
    
    var onShowPasswords = () => {
        DBMS.getShopPasswords(function(err, shopPasswords){
            addEls(clearEl(queryEl(root + '.shop-passwords-table-body')), shopPasswords.map(makePassRow));
        });
    };
    
    var makePassRow = (data) => {
        return addEls(makeEl('tr'), [addEl(makeEl('td'), makeText(data.name)), addEl(makeEl('td'), makeText(data.password))]);
    };

})(this['ShopPasswords']={});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

(function(exports){
    
    var root = '.shop-profile-tab ';
    var state = {};

    exports.init = function() {
        listen(queryEl(root + '.entity-selector'), "change", onShopSelect);
        listen(queryEl(root + '.corp-name-input'), "change", onShopDataInput('.corp-name-input', 'corporation'));
        listen(queryEl(root + '.seller-login-input'), "change", onShopDataInput('.seller-login-input', 'sellerLogin'));
        listen(queryEl(root + '.seller-password-input'), "change", onShopDataInput('.seller-password-input', 'sellerPassword'));
        listen(queryEl(root + '.check-shop-button'), "click", checkShopCredentials);
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {
        PermissionInformer.getEntityNamesArray('shop', false, function(err, names){
            if(err) {Utils.handleError(err); return;}
            
            var sel = clearEl(queryEl(root + ".entity-selector"));
            fillSelector(sel, names.map(remapProps4Select));
            
//            applySettings(groupNames, sel);
        });
    };
    
    var onShopSelect = (event)  => {
        var shopName = event.target.selectedOptions[0].value;
        clearEl(queryEl(root + ".check-shop-result"));
        DBMS.getShop(shopName, function(err, shopData){
            if(err) {Utils.handleError(err); return;}
            queryEl(root + '.corp-name-input').value = shopData.corporation;
            queryEl(root + '.seller-login-input').value = shopData.sellerLogin;
            queryEl(root + '.seller-password-input').value = shopData.sellerPassword;
        });
    };
    
    var onShopDataInput = (clazz, type)  => {
        return function(){
            var input = queryEl(root + clazz);
            var value = input.value.trim();
            var shopSelector = queryEl(root + ".entity-selector");
            if(shopSelector.selectedOptions.length === 0){
                Utils.alert(L10n.get('shop', 'shop-is-not-selected'));
                return;
            }
            var shopName = shopSelector.selectedOptions[0].value;
            DBMS.setShopData(shopName, type, value,  Utils.processError(function(){
                input = '';
            }));
        }
    };
    
    var checkShopCredentials = () => {
        var opt = queryEl(root + ".entity-selector").selectedOptions[0];
        if(opt === undefined){
            return;
        }
        var shopName = opt.value;
        DBMS.getShopAPICheck(shopName, function(err, res){
            if(err) {Utils.handleError(err); return;}
            addEls(clearEl(queryEl(root + ".check-shop-result")), [
                addEl(makeEl('span'), makeText(res.statusCode)               ),
                addEl(makeEl('span'), makeText(L10n.get('api-check', String(res.statusCode))) )
            ]);
        });
        
    };
    

})(this['ShopProfile']={});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

(function(exports){

    var state = {};
    var root = '.shops-tab2 ';
    var currentShop = undefined;
    
    exports.init = function () {
        listen(queryEl(root + ".create-user-button"),"click", createShop);
        listen(queryEl(root + ".change-password-button"),"click", changeShopPassword);
        listen(queryEl(root + ".remove-user-button"),"click", removeShop);
        state.views = {};
        var nav = root + ".sub-tab-navigation";
        var content = root + ".sub-tab-content";
        var containers = {
            root: state,
            navigation: queryEl(nav),
            content: queryEl(content)
        };
        Utils.addView(containers, "shop-profile", ShopProfile,{mainPage:true});
        Utils.addView(containers, "shop-passwords", ShopPasswords);
//        Utils.addView(containers, "shop-view", ShopView);
//        Utils.addView(containers, "shop-binding", ShopBinding);
//    
//        listen(queryEl(root + ".create-entity-button"), "click", createProfile());
//        listen(queryEl(root + ".rename-entity-button"), "click", renameProfile());
//        listen(queryEl(root + ".remove-entity-button"), "click", removeProfile());
//        
//        $("#shopSelector").select2().on("change", onShopSelectorChangeDelegate);

        exports.content = queryEl(root);
    };
    
    exports.refresh = function () {
        PermissionInformer.getEntityNamesArray('shop', true, function(err, entityNames){
            if(err) {Utils.handleError(err); return;}
            rebuildInterface(entityNames);
            state.currentView.refresh();
        });
    };
    
    var rebuildInterface = function (names) {
        var data = getSelect2Data(names);
        
        clearEl(queryEl(root + ".change-password-user-select"));
        $(root + ".change-password-user-select").select2(data);
        
        clearEl(queryEl(root + ".remove-user-select"));
        $(root + ".remove-user-select").select2(data);
    };
    
    var createShop = function () {
        var userNameInput = queryEl(root + ".create-user-name-input");
        var userPasswordInput = queryEl(root + ".create-user-password-input");
        DBMS.createShop(userNameInput.value.trim(), userPasswordInput.value, Utils.processError(function(){
            userNameInput.value = '';
            userPasswordInput.value = '';
            exports.refresh();
        }));
    };
    
    
    var changeShopPassword = function () {
        var userName = queryEl(root + ".change-password-user-select").value.trim();
        var passwordInput = queryEl(root + ".change-password-password-input");
        DBMS.changeShopPassword(userName, passwordInput.value, Utils.processError(function(){
            queryEl(root + ".change-password-password-input").value = '';
            exports.refresh();
        }));
    };
    
    var removeShop = function () {
        var name = queryEl(root + ".remove-user-select").value.trim();
        Utils.confirm(strFormat(getL10n('shop-confirm-shop-remove'), [name]), () => {
            DBMS.removeShop(name, Utils.processError(exports.refresh));
        });
    };
    
//    exports.getCurrentShop = () => currentShop;
    
//    var onShopSelectorChangeDelegate = (event) =>{
//        currentShop = event.target.value;
//        state.currentView.refresh();
////        exports.refresh();
//    };
    

//    
//    var createProfile = function () {
//        return function(){
//            var input = queryEl(root + ".create-entity-input");
//            var name = input.value.trim();
//            
//            DBMS.createShop(name, function(err){
//                if(err) {Utils.handleError(err); return;}
//                PermissionInformer.refresh(function(err){
//                    if(err) {Utils.handleError(err); return;}
////                    if(state.currentView.updateSettings){
////                        state.currentView.updateSettings(name);
////                    }
//                    input.value = '';
//                    exports.refresh();
//                });
//            });
//        }
//    };
//    
//    var renameProfile = function () {
//        return function(){
//            var toInput = queryEl(root + ".rename-entity-input");
//            var fromName = queryEl(root + ".rename-entity-select").value.trim();
//            var toName = toInput.value.trim();
//        
//            DBMS.renameShop(fromName, toName, function(err){
//                if(err) {Utils.handleError(err); return;}
//                PermissionInformer.refresh(function(err){
//                    if(err) {Utils.handleError(err); return;}
//                    toInput.value = '';
////                    if(state.currentView.updateSettings){
////                        state.currentView.updateSettings(type, toName);
////                    }
//                    exports.refresh();
//                });
//            });
//        }
//    };
//    
//    var removeProfile = function () {
//        return function(){
//            var name = queryEl(root + ".remove-entity-select").value.trim();
//        
//            Utils.confirm(strFormat(getL10n("profiles-are-you-sure-about-character-removing"),[name]), () => {
//                DBMS.removeShop(name, function(err){
//                    if(err) {Utils.handleError(err); return;}
//                    PermissionInformer.refresh(function(err){
//                        if(err) {Utils.handleError(err); return;}
//                        exports.refresh();
//                    });
//                });
//            });
//        }
//    };

})(this['Shops2']={});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

(function(exports){
    
    var root = '.shop-window-tab ';
    var state = {};
    var l10n = L10n.get('shop');

    exports.init = function() {
//        listen(queryEl(root + '.refreshButton'), 'click', exports.refresh);
//        queryEls(root + '.discount-button').map(listen(R.__, 'click', (event)=>{
////            state.discount = Number(getAttr(event.target, 'value'));
//            updateFinalCost();
//        }));
        checkForQR();
        listen(queryEl(root + ".amount-input"), 'change', onAmountChange);
        listen(queryEl(root + ".buy-button"), 'click', onBuy);
        listen(queryEl(root + ".start-qr-read"), 'click', readQR);
        
        exports.content = queryEl(root);
    };
    
    exports.refresh = function() {
        var shopName = ShopManagement.getCurrentShopName();
        DBMS.getShop(shopName, function(err, shopData){
            if(err) {Utils.handleError(err); return;}
            state.shopData = shopData;
            var categoryList  = R.keys(state.shopData.categories).sort(CommonUtils.charOrdA);
            
            var catSelect = clearEl(queryEl(root + ".category-select"));
            clearEl(queryEl(root + ".asset-select"));
            
            
            var catBtns = categoryList.map( name => {
                var btn = addEl(makeEl('button'), makeText(name));
                addClass(btn, 'select-button');
                btn.catName = name;
                listen(btn, "click", onCategorySelect);
                return btn;
            });
            addEls(catSelect, catBtns);
            if(catBtns.length > 0) onCategorySelect({target:catBtns[0]});
        });
    };

    var makeBtn = R.curry((catName, el) => {
        var btn = addEl(makeEl('button'), makeText(el.dispName));
        addClass(btn, 'select-button');
        btn.name = el.name;
        btn.catName = catName;
        btn.assetType = el.type;
        listen(btn, "click", onAssetSelect);
        return btn;
    });
    
    var onCategorySelect = (event) => {
        queryEls(root + ".category-select > button").map(removeClass(R.__, 'active'));
        addClass(event.target, 'active');
        var catName = event.target.catName;
        var category = state.shopData.categories[catName];
        
        clearEl(queryEl(root + ".asset-info"));
        addClass(queryEl(root + ".buy-controls"), 'hidden');
        var assetSelect = clearEl(queryEl(root + ".asset-select"));
        
        var arr = R.keys(category.globals).map(R.pair(R.__, 'global'));
        arr = R.concat(arr, R.keys(category.locals).map(R.pair(R.__, 'local')));

        DBMS.getGlobalAssetDisplayNames( (err, globalDisplayNames) => {
            if(err) {Utils.handleError(err); return;}
            
            arr = arr.map(el => {
                if(el[1] === 'global'){
                    var dispName = globalDisplayNames[el[0]].displayString;
                } else {
                    var dispName = state.shopData.localAssets[el[0]].displayString;
                }
                return {
                    name: el[0],
                    type: el[1],
                    dispName: dispName.trim() === '' ? el[0] : dispName
                }
            }).sort(CommonUtils.charOrdAFactory(R.prop('dispName')));
            
            addEls(assetSelect, arr.map(makeBtn(catName)))
        });
    };
    
    var onAssetSelect = (event) => {
        queryEls(root + ".asset-select > button").map(removeClass(R.__, 'active'));
        addClass(event.target, 'active');
        removeClass(queryEl(root + ".buy-controls"), 'hidden');
        queryEl('.customer-login').value = '';
        queryEl('.customer-password').value = '';
        state.curAsset = {
            name : event.target.name ,
            catName : event.target.catName ,
            assetType : event.target.assetType 
        };
        showAssetInfo();
    };
    
    var showAssetInfo = () => {
        var set = state.curAsset.assetType === 'local' ? 'locals' : 'globals';
        var cost = state.shopData.categories[state.curAsset.catName][set][state.curAsset.name].cost;
        state.cost = cost;
        queryEl(root + ".final-cost-input").value = cost;
//        state.discount = 0;
        if(state.curAsset.assetType === 'local'){
            state.assetData = state.shopData.localAssets[state.curAsset.name];
            renderAssetInfo();
        } else {
            DBMS.getAsset(state.curAsset.name, (err, assetData) => {
                if(err) {Utils.handleError(err); return;}
                state.assetData = assetData;
                renderAssetInfo();
            });
        }
    };
    
    var renderAssetInfo = () => {
        var info = clearEl(queryEl(root + ".asset-info"));
        var displayName = state.assetData.displayString.trim() !== '' ? state.assetData.displayString : state.curAsset.name;
        addEl(info, addEl(makeEl('h2'), makeText(displayName)));
        addEl(info, addEl(makeEl('span'), makeText(state.assetData.description)));
        addEl(clearEl(queryEl(root + ".initial-cost-value")), makeText(state.cost));

        setClassByCondition(queryEl(root + ".activation-codes-container"), 'hidden', !state.assetData.isPhysical);
        setClassByCondition(queryEl(root + ".qr-reader"), 'hidden', !(state.assetData.isPhysical && state.isCanvasOk));
        var amount = clearEl(queryEl(root + ".amount-input"));
        amount.value = 1;
        if(state.assetData.isPhysical){
            delAttr(amount, 'disabled');
        } else {
            setAttr(amount, 'disabled', 'disabled');
        }
        onAmountChange({target: amount});
    };
    
    var onAmountChange = (event) => {
        var num = Number(event.target.value);
        var el = clearEl(queryEl(root + ".activation-codes"));
        if(num < 1) num = 1;
        if(num > 10) num = 10;
        addEls(el, R.repeat(1, num).map(val => {
//            return setAttr(makeEl('input'), 'type', 'number');
            return addClasses(makeEl('input'), ['form-control','qr-code-input']);
        }));
    };
    
    var onBuy = () => {
        var shopName = ShopManagement.getCurrentShopName();
        var cost = Number(queryEl(root + ".final-cost-input").value);
        var customerLogin = queryEl('.customer-login').value;
        var customerPassword = queryEl('.customer-password').value;
        var opts = {
            amount: Number(queryEl(root + ".amount-input").value)
        };
        if(state.assetData.isPhysical){
            var values = queryEls(root + ".activation-codes input").map(R.compose(R.trim, R.prop('value')));
            if(values.some(R.isEmpty)){
                Utils.alert(l10n('not-all-activation-codes-are-full'));
                return;
            }
            opts.codes = values;
        }
        DBMS.buyAsset(shopName, state.curAsset.name, state.curAsset.assetType, cost, customerLogin, customerPassword, opts, function(err){
            if(err) {Utils.handleError(err); return;}
            queryEl('.customer-login').value = '';
            queryEl('.customer-password').value = '';
            Utils.alert(l10n('on-purchase-success'));
        });
    };
    
    var checkForQR = () => {
        function isCanvasSupported(){
          var elem = document.createElement('canvas');
          return !!(elem.getContext && elem.getContext('2d'));
        }
        state.isCanvasOk = isCanvasSupported() && window.File && window.FileReader;
    };
    
    var readQR = () => {
        qrcode.callback = read;
        qrcode.customCanvas = queryEl(root + ".qr-canvas");
        var video = setAttr(makeEl('video'), 'autoplay','autoplay');
        addEl(clearEl(queryEl(root + ".video")), video);
        qrcode.setWebcam(video);
    };
    
    var read = (a) => {
        console.log('read called');
        console.log(a);
        queryEl(root + ".video video").pause();
        clearEl(queryEl(root + ".video"));
        
        var request = $.ajax({
//            url : 'http://dev.alice.digital:8159/decode?content=' + a,
            url : 'https://alice.digital/app/qr/decode?content=' + a,
            dataType : "text",
            method : "GET",
            contentType : "application/json;charset=utf-8",
            cache: false,
            timeout: Constants.httpTimeout,
        });
        
        request.done(function(data) {
            data = JSON.parse(data);
            var length = data.payload.length;
            var payload = data.payload.substring(length-6, length);
            var values = queryEls(root + ".activation-codes input").map(R.compose(R.trim, R.prop('value')));
            if(R.contains(payload, values)){
                Utils.alert(l10n('this-qr-code-already-used-in-inputs'));
                return;
            }
            var inputs = queryEls(root + ".activation-codes input").filter(R.compose(R.isEmpty, R.trim, R.prop('value')));
            if(inputs.length > 0){
                inputs[0].value = data.payload.substring(length-6, length);
            } else {
                Utils.alert(l10n('all-activation-codes-are-full'));
            }
        });
        
        request.fail(function(errorInfo, textStatus, errorThrown) {
            Utils.alert(errorInfo.responseText || textStatus || 'error');
        });
    };
    

})(this['ShopWindow']={});
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

var About = {};

About.init = function() {
    "use strict";

    About.content = getEl('aboutDiv');
};

About.refresh = function() {
};

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 Utils, DBMS
 */

"use strict";

var LogViewer = {};

LogViewer.init = function() {
    "use strict";
    listen(getEl('logPageSelector'), 'change', function(event){
        DBMS.getLog(Number(event.target.value), LogViewer.dataRecieved);
    });

    LogViewer.content = getEl('logViewerDiv');
};

LogViewer.refresh = function() {
    "use strict";
    getEl('logPageSelector').selectedIndex = 0;
    DBMS.getLog(0, LogViewer.dataRecieved);
};

LogViewer.dataRecieved = function(err, data) {
    "use strict";
    if(err) {Utils.handleError(err); return;}
    
    var sel = getEl('logPageSelector');
    var selectedIndex = sel.selectedIndex;
    clearEl(sel);

    var selData = [];
    for (var i = 0; i < data.logSize; i++) {
        selData.push({ name: i+1, value: String(i), selected: selectedIndex == i });
    }
    fillSelector(sel, selData);
    
    var container = clearEl(getEl('logData'));
    
    R.ap([addEl(container)], data.requestedLog.map(LogViewer.makeRow));
};

LogViewer.makeRow = function(rowData){
    "use strict";
    var tr = makeEl('tr');
    var addText = function(text){
        addEl(tr, addEl(makeEl('td'), addEl(makeEl('span'),makeText(text))));
    }
    addText(rowData[0]);
    addText(new Date(rowData[2]).format("yyyy/mm/dd HH:MM:ss"));
    addText(rowData[1]);
    addText(rowData[3]);
    addText(rowData[4]);
    return tr;
};
/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
   limitations under the License. */

/*global
 */

"use strict";

var LogViewer2 = {};

LogViewer2.init = function () {
    var root = LogViewer2;
    root.views = {};
    var nav = ".log-viewer2-tab .sub-tab-navigation";
    var content = ".log-viewer2-tab .sub-tab-content";
    var containers = {
        root: root,
        navigation: queryEl(nav),
        content: queryEl(content)
    };
    Utils.addView(containers, "logViewer", LogViewer,{mainPage:true});
    Utils.addView(containers, "about", About);

    LogViewer2.content = queryEl(".log-viewer2-tab");
};

LogViewer2.refresh = function () {
    LogViewer2.currentView.refresh();
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzL3BhZ2VzL2VudGVyLmpzIiwianMvcGFnZXMvdGVtcGxhdGUuanMiLCJqcy9wYWdlcy9kZXVzZXgvYXBpQ2hlY2suanMiLCJqcy9wYWdlcy9kZXVzZXgvYXNzZXRQcmVzZW5jZS5qcyIsImpzL3BhZ2VzL2RldXNleC9hc3NldFByb2ZpbGUuanMiLCJqcy9wYWdlcy9kZXVzZXgvYXNzZXRzLmpzIiwianMvcGFnZXMvZGV1c2V4L2NhdGVnb3J5Q29udGVudE1hbmFnZW1lbnQuanMiLCJqcy9wYWdlcy9kZXVzZXgvc2hvcEFib3V0LmpzIiwianMvcGFnZXMvZGV1c2V4L3Nob3BNYW5hZ2VtZW50LmpzIiwianMvcGFnZXMvZGV1c2V4L3Nob3BQYXNzd29yZHMuanMiLCJqcy9wYWdlcy9kZXVzZXgvc2hvcFByb2ZpbGUuanMiLCJqcy9wYWdlcy9kZXVzZXgvc2hvcHMyLmpzIiwianMvcGFnZXMvZGV1c2V4L3Nob3BXaW5kb3cuanMiLCJqcy9wYWdlcy9sb2dzL2Fib3V0LmpzIiwianMvcGFnZXMvbG9ncy9sb2dWaWV3ZXIuanMiLCJqcy9wYWdlcy9sb2dzL2xvZ1ZpZXdlcjIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQy9FQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2pDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3pEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDNUhBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3pMQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdEtBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN2UEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzNDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2pMQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzdDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN6RkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNsS0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3ZQQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzlCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNwRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoicGFnZXMubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypDb3B5cmlnaHQgMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuLypnbG9iYWxcclxuIFV0aWxzLCBEQk1TXHJcbiAqL1xyXG5cclxuXHJcblwidXNlIHN0cmljdFwiO1xyXG5cclxuKGZ1bmN0aW9uKGV4cG9ydHMpe1xyXG4gICAgXHJcbiAgICB2YXIgcm9vdCA9IFwiLmVudGVyLXRhYiBcIjtcclxuICAgIHZhciB1cmwgPSB3aW5kb3cubG9jYXRpb24uaHJlZi5zdWJzdHJpbmcoMCwgd2luZG93LmxvY2F0aW9uLmhyZWYubGFzdEluZGV4T2YoJy8nKSsxKTtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5pbml0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICQoZG9jdW1lbnQuZm9ybXNbJ2xvZ2luLWZvcm0nXSkub24oJ3N1Ym1pdCcsIHN1Ym1pdCk7XHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMucmVmcmVzaCA9IGZ1bmN0aW9uKCkge1xyXG5cclxuICAgIH07XHJcbiAgICAgICAgICAgIFxyXG4gICAgdmFyIHN1Ym1pdCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHZhciBmb3JtID0gJCh0aGlzKTtcclxuXHJcbiAgICAgICAgJCgnLmVycm9yJywgZm9ybSkuaHRtbCgnJyk7XHJcbi8vICAgICAgICAkKFwiOnN1Ym1pdFwiLCBmb3JtKS5idXR0b24oXCJsb2FkaW5nXCIpO1xyXG5cclxuICAgICAgICB2YXIgcmVxdWVzdCA9ICQuYWpheCh7XHJcbiAgICAgICAgICAgIHVybCA6IHVybCArIFwibG9naW5cIixcclxuICAgICAgICAgICAgbWV0aG9kIDogXCJQT1NUXCIsXHJcbiAgICAgICAgICAgIGRhdGEgOiBmb3JtLnNlcmlhbGl6ZSgpLFxyXG4gICAgICAgICAgICBjb21wbGV0ZSA6IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgJChcIjpzdWJtaXRcIiwgZm9ybSkuYnV0dG9uKFwicmVzZXRcIik7XHJcbiAgICAgICAgICAgIH0sXHJcbi8vICAgICAgICAgICAgIHN0YXR1c0NvZGUgOiB7XHJcbi8vICAgICAgICAgICAgICAgICAyMDAgOiBmdW5jdGlvbigpIHtcclxuLy8gICAgICAgICAgICAgICAgIH0sXHJcbi8vICAgICAgICAgICAgICAgICA0MDMgOiBmdW5jdGlvbihqcVhIUikge1xyXG4vLyAgICAgICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IEpTT04ucGFyc2UoanFYSFIucmVzcG9uc2VUZXh0KTtcclxuLy8gICAgICAgICAgICAgICAgICAgICAkKCcuZXJyb3InLCBmb3JtKS5odG1sKGVycm9yLm1lc3NhZ2UpO1xyXG4vLyAgICAgICAgICAgICAgICAgfVxyXG4vLyAgICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmVxdWVzdC5kb25lKGZ1bmN0aW9uKGRhdGEpIHtcclxuLy8gICAgICAgICAgICAgLy93aW5kb3cubG9jYXRpb24uaHJlZiA9IFwiL2NoYXRcIjtcclxuLy8gICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBcIi9uaW1zLmh0bWxcIjtcclxuICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSB1cmwgKyBcInBhZ2UuaHRtbFwiO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHJlcXVlc3QuZmFpbChmdW5jdGlvbihlcnJvckluZm8sIHRleHRTdGF0dXMsIGVycm9yVGhyb3duKSB7XHJcbiAgICAgICAgICAgIHZhciBtc2c7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBtc2cgPSBVdGlscy5oYW5kbGVFcnJvck1zZyhKU09OLnBhcnNlKGVycm9ySW5mby5yZXNwb25zZVRleHQpKTtcclxuICAgICAgICAgICAgfSBjYXRjaChlcnIpe1xyXG4gICAgICAgICAgICAgICAgbXNnID0gVXRpbHMuaGFuZGxlRXJyb3JNc2coZXJyb3JJbmZvLnJlc3BvbnNlVGV4dCB8fCB0ZXh0U3RhdHVzIHx8ICdlcnJvcicpO1xyXG4gICAgICAgICAgICB9XHJcbi8vICAgICAgICAgICAgIHZhciBlcnJvciA9IEpTT04ucGFyc2UoanFYSFIucmVzcG9uc2VUZXh0KTtcclxuLy8gICAgICAgICAgICAgJCgnLmVycm9yJywgZm9ybSkuaHRtbChlcnJvci5tZXNzYWdlKTsgXHJcbi8vICAgICAgICAgICAgJCgnLmVycm9yJywgZm9ybSkuaHRtbCh0ZXh0U3RhdHVzKTsgXHJcbiAgICAgICAgICAgICQoJy5lcnJvcicsIGZvcm0pLmh0bWwobXNnKTsgXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfTtcclxuICAgIFxyXG59KSh0aGlzWydFbnRlciddPXt9KTsiLCIvKkNvcHlyaWdodCAyMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG5cInVzZSBzdHJpY3RcIjtcclxuXHJcbihmdW5jdGlvbihleHBvcnRzKXtcclxuICAgIFxyXG4gICAgdmFyIHJvb3QgPSAnLi10YWIgJztcclxuICAgIHZhciBzdGF0ZSA9IHt9O1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSBmdW5jdGlvbigpIHtcclxuICAgIFxyXG4gICAgfTtcclxuXHJcbn0pKHRoaXNbJ1RlbXBsYXRlJ109e30pOyIsIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcblwidXNlIHN0cmljdFwiO1xyXG5cclxuKGZ1bmN0aW9uKGV4cG9ydHMpe1xyXG4gICAgXHJcbiAgICB2YXIgcm9vdCA9ICcuYXBpLWNoZWNrLXRhYiAnO1xyXG4gICAgdmFyIHN0YXRlID0ge307XHJcbiAgICB2YXIgbDEwbiA9IEwxMG4uZ2V0KCdhcGktY2hlY2snKTtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChyb290ICsgJy5zaG9wLWNoZWNrLWJ1dHRvbicpLCAnY2xpY2snLCBjaGVja0FQSSgnLnNob3AtY2hlY2stYXJlYScsICdnZXRTaG9wc0FQSUNoZWNrJykpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKHJvb3QgKyAnLmltcGxhbnQtY2hlY2stYnV0dG9uJyksICdjbGljaycsIGNoZWNrQVBJKCcuaW1wbGFudC1jaGVjay1hcmVhJywgJ2dldEltcGxhbnRzQVBJQ2hlY2snKSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwocm9vdCArICcucGlsbHMtY2hlY2stYnV0dG9uJyksICdjbGljaycsIGNoZWNrQVBJKCcucGlsbHMtY2hlY2stYXJlYScsICdnZXRQaWxsc0FQSUNoZWNrJykpO1xyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSBmdW5jdGlvbigpIHtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBjaGVja0FQSSA9IFIuY3VycnkoKGNsYXp6LGRiQ2FsbCkgPT4ge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNsZWFyRWwocXVlcnlFbChyb290ICsgY2xhenogKyAnIC5jb250YWluZXInKSk7XHJcbiAgICAgICAgICAgIERCTVNbZGJDYWxsXShmdW5jdGlvbihlcnIsIGFycil7XHJcbiAgICAgICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICAgICAgYXJyLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEFGYWN0b3J5KFIucHJvcCgnbmFtZScpKSlcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGFycik7XHJcbiAgICAgICAgICAgICAgICB2YXIgY29udGFpbmVyID0gY2xlYXJFbChxdWVyeUVsKHJvb3QgKyBjbGF6eiArICcgLmNvbnRhaW5lcicpKTtcclxuICAgICAgICAgICAgICAgIGFkZEVscyhjb250YWluZXIsIGFyci5tYXAobWFrZVN0cikpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIFxyXG4gICAgdmFyIG1ha2VTdHIgPSAoZWwpID0+IHtcclxuICAgICAgICByZXR1cm4gYWRkRWxzKHNldENsYXNzQnlDb25kaXRpb24obWFrZUVsKCd0cicpLCAncmVkLXJvdycsICEoMjAwIDw9IGVsLnN0YXR1c0NvZGUgJiYgZWwuc3RhdHVzQ29kZSA8IDMwMCkpLCBbXHJcbiAgICAgICAgICAgIGFkZEVsKG1ha2VFbCgndGQnKSwgbWFrZVRleHQoZWwubmFtZSkgICAgICAgICAgICAgICAgICAgICApLFxyXG4gICAgICAgICAgICBhZGRFbChtYWtlRWwoJ3RkJyksIG1ha2VUZXh0KGVsLnN0YXR1c0NvZGUpICAgICAgICAgICAgICAgKSxcclxuICAgICAgICAgICAgYWRkRWwobWFrZUVsKCd0ZCcpLCBtYWtlVGV4dChsMTBuKFN0cmluZyhlbC5zdGF0dXNDb2RlKSkpIClcclxuICAgICAgICBdKTtcclxuICAgIH07XHJcblxyXG59KSh0aGlzWydBcGlDaGVjayddPXt9KTsiLCIvKkNvcHlyaWdodCAyMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG5cInVzZSBzdHJpY3RcIjtcclxuXHJcbihmdW5jdGlvbihleHBvcnRzKXtcclxuICAgIFxyXG4gICAgdmFyIHJvb3QgPSAnLmFzc2V0LXByZXNlbmNlLXRhYiAnO1xyXG4gICAgdmFyIGFzc2V0U2VsZWN0Q29udGFpbmVyID0gcm9vdCArJy5hc3NldC1zZWxlY3QtY29udGFpbmVyICc7XHJcbiAgICB2YXIgc2hvcFNlbGVjdENvbnRhaW5lciA9IHJvb3QgKycuc2hvcC1zZWxlY3QtY29udGFpbmVyICc7XHJcbiAgICB2YXIgc3RhdGUgPSB7fTtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChyb290ICsgJy5zaG93LWFzc2V0LXNlbGVjdCcpLCBcImNoYW5nZVwiLCBVSS5zaG93U2VsZWN0ZWRFbHMoXCItcm93LWRlcGVuZGVudFwiKSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYXNzZXRTZWxlY3RDb250YWluZXIgKyAnLnNlbGVjdC1hbGwtYnV0dG9uJyksIFwiY2xpY2tcIiwgbWFrZVNlbGVjdEFsbEZ1bihyb290ICsgJy5zaG93LWFzc2V0LXNlbGVjdCcsIFVJLnNob3dTZWxlY3RlZEVscyhcIi1yb3ctZGVwZW5kZW50XCIpLCB0cnVlKSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoYXNzZXRTZWxlY3RDb250YWluZXIgKyAnLmRlc2VsZWN0LWFsbC1idXR0b24nKSwgXCJjbGlja1wiLCBtYWtlU2VsZWN0QWxsRnVuKHJvb3QgKyAnLnNob3ctYXNzZXQtc2VsZWN0JywgVUkuc2hvd1NlbGVjdGVkRWxzKFwiLXJvdy1kZXBlbmRlbnRcIiksIGZhbHNlKSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwocm9vdCArICcuc2hvdy1zaG9wLXNlbGVjdCcpLCBcImNoYW5nZVwiLCBVSS5zaG93U2VsZWN0ZWRFbHMoXCItY29sLWRlcGVuZGVudFwiKSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoc2hvcFNlbGVjdENvbnRhaW5lciArICcuc2VsZWN0LWFsbC1idXR0b24nKSwgXCJjbGlja1wiLCBtYWtlU2VsZWN0QWxsRnVuKHJvb3QgKyAnLnNob3ctc2hvcC1zZWxlY3QnLCBVSS5zaG93U2VsZWN0ZWRFbHMoXCItY29sLWRlcGVuZGVudFwiKSwgdHJ1ZSkpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKHNob3BTZWxlY3RDb250YWluZXIgKyAnLmRlc2VsZWN0LWFsbC1idXR0b24nKSwgXCJjbGlja1wiLCBtYWtlU2VsZWN0QWxsRnVuKHJvb3QgKyAnLnNob3ctc2hvcC1zZWxlY3QnLCBVSS5zaG93U2VsZWN0ZWRFbHMoXCItY29sLWRlcGVuZGVudFwiKSwgZmFsc2UpKTtcclxuICAgICAgICBcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIG1ha2VTZWxlY3RBbGxGdW4gPSAoc2VsZWN0b3IsIGNhbGxiYWNrLCB2YWx1ZSkgPT4ge1xyXG4gICAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgICAgIG5sMmFycmF5KHF1ZXJ5RWwoc2VsZWN0b3IpLm9wdGlvbnMpLmZpbHRlcihvcHQgPT4gIWhhc0NsYXNzKG9wdCwnaGlkZGVuJykpLmZvckVhY2goIG9wdGlvbiA9PiBvcHRpb24uc2VsZWN0ZWQgPSB2YWx1ZSk7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKHt0YXJnZXQ6cXVlcnlFbChzZWxlY3Rvcil9KTtcclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ2Fzc2V0JywgdHJ1ZSwgZnVuY3Rpb24oZXJyLCBhc3NldE5hbWVzKXtcclxuICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgICAgICAgICAgREJNUy5nZXRTaG9wQXNzZXRzKGZ1bmN0aW9uKGVyciwgc2hvcEFzc2V0cyl7XHJcbiAgICAgICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgXHJcbi8vICAgICAgICAgICAgICAgIGZpbGxTZWxlY3RvcihjbGVhckVsKHF1ZXJ5RWwocm9vdCArIFwiLnNob3ctYXNzZXQtc2VsZWN0XCIpKSwgYXNzZXROYW1lcy5tYXAocmVtYXBQcm9wczRTZWxlY3QpKTtcclxuICAgICAgICAgICAgICAgIGZpbGxTZWxlY3RvcihjbGVhckVsKHF1ZXJ5RWwocm9vdCArIFwiLnNob3ctYXNzZXQtc2VsZWN0XCIpKSwgYXNzZXROYW1lcy5tYXAoYXNzZXQgPT4gUi56aXBPYmooWyduYW1lJywnc2VsZWN0ZWQnXSwgW2Fzc2V0LnZhbHVlLCB0cnVlXSkpKTtcclxuICAgICAgICAgICAgICAgIGZpbGxTZWxlY3RvcihjbGVhckVsKHF1ZXJ5RWwocm9vdCArIFwiLnNob3ctc2hvcC1zZWxlY3RcIikpLCBzaG9wQXNzZXRzLm1hcChzaG9wID0+IFIuemlwT2JqKFsnbmFtZScsJ3NlbGVjdGVkJ10sIFtzaG9wLm5hbWUsIHRydWVdKSkpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBzZXRBdHRyKHF1ZXJ5RWwocm9vdCArIFwiLnNob3ctYXNzZXQtc2VsZWN0XCIpLCAnc2l6ZScsIGFzc2V0TmFtZXMubGVuZ3RoID4gMTUgPyAxNSA6IGFzc2V0TmFtZXMubGVuZ3RoKTsgIFxyXG4gICAgICAgICAgICAgICAgc2V0QXR0cihxdWVyeUVsKHJvb3QgKyBcIi5zaG93LXNob3Atc2VsZWN0XCIpLCAnc2l6ZScsIHNob3BBc3NldHMubGVuZ3RoID4gMTUgPyAxNSA6IHNob3BBc3NldHMubGVuZ3RoKTsgIFxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICB2YXIgaGVhZCA9IGNsZWFyRWwocXVlcnlFbChyb290ICsgXCIuYXNzZXQtcHJlc2VuY2UtdGFibGUtaGVhZFwiKSk7XHJcbiAgICAgICAgICAgICAgICB2YXIgYm9keSA9IGNsZWFyRWwocXVlcnlFbChyb290ICsgXCIuYXNzZXQtcHJlc2VuY2UtdGFibGUtYm9keVwiKSk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGFkZEVsKGhlYWQsIG1ha2VUYWJsZUhlYWQoc2hvcEFzc2V0cykpO1xyXG4gICAgICAgICAgICAgICAgYWRkRWxzKGJvZHksIGFzc2V0TmFtZXMubWFwKCAoYXNzZXQsIGkpID0+IG1ha2VUYWJsZUlucHV0KGFzc2V0LCBpLCBzaG9wQXNzZXRzKSkpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBtYWtlVGFibGVIZWFkID0gZnVuY3Rpb24gKHNob3BBc3NldHMpIHtcclxuICAgICAgICB2YXIgZWxzID0gc2hvcEFzc2V0cy5tYXAoKGl0ZW0sIGkpID0+IGFkZENsYXNzKGFkZEVsKG1ha2VFbChcInRoXCIpLG1ha2VUZXh0KGl0ZW0ubmFtZSkpLCBpICsgXCItY29sLWRlcGVuZGVudFwiKSk7XHJcbiAgICAgICAgcmV0dXJuIGFkZEVscyhtYWtlRWwoXCJ0clwiKSwgW21ha2VFbChcInRoXCIpXS5jb25jYXQoZWxzKSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgbWFrZVRhYmxlSW5wdXQgPSBmdW5jdGlvbiAoYXNzZXQsIGksIHNob3BBc3NldHMpIHtcclxuICAgICAgICB2YXIgdHIgPSBtYWtlRWwoXCJ0clwiKTtcclxuICAgICAgICB2YXIgdGQgPSBtYWtlRWwoXCJ0ZFwiKTtcclxuICAgICAgICB0ZC5hcHBlbmRDaGlsZChtYWtlVGV4dChhc3NldC52YWx1ZSkpO1xyXG4gICAgICAgIHRyLmFwcGVuZENoaWxkKHRkKTtcclxuICAgICAgICBhZGRDbGFzcyh0ciwgaSArIFwiLXJvdy1kZXBlbmRlbnRcIik7XHJcblxyXG4gICAgICAgIHNob3BBc3NldHMuZm9yRWFjaCggKHNob3BBc3NldERhdGEsIGopID0+IHtcclxuICAgICAgICAgICAgdGQgPSBhZGRDbGFzcyhtYWtlRWwoXCJ0ZFwiKSwndmVydGljYWwtYWxpZ25lZC10ZCcpO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyh0ZCwgaiArIFwiLWNvbC1kZXBlbmRlbnRcIik7XHJcbiAgICAgICAgICAgIHZhciBpbnB1dCA9IG1ha2VFbChcImlucHV0XCIpO1xyXG4vLyAgICAgICAgICAgIGFkZENsYXNzKGlucHV0LCBcImlzU3RvcnlFZGl0YWJsZVwiKTtcclxuICAgICAgICAgICAgaW5wdXQudHlwZSA9IFwiY2hlY2tib3hcIjtcclxuICAgICAgICAgICAgaWYgKHNob3BBc3NldERhdGEuYXNzZXRzW2Fzc2V0LnZhbHVlXSkge1xyXG4gICAgICAgICAgICAgICAgaW5wdXQuY2hlY2tlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuLy8gICAgICAgICAgICBpbnB1dC5ldmVudEluZGV4ID0gaTtcclxuLy8gICAgICAgICAgICBpbnB1dC5ldmVudE5hbWUgPSBldmVudC5uYW1lO1xyXG4gICAgICAgICAgICBpbnB1dC5hc3NldE5hbWUgPSBhc3NldC52YWx1ZTtcclxuICAgICAgICAgICAgaW5wdXQuc2hvcE5hbWUgPSBzaG9wQXNzZXREYXRhLm5hbWU7XHJcbi8vICAgICAgICAgICAgaW5wdXQuaGFzVGV4dCA9IGV2ZW50LmNoYXJhY3RlcnNbY2hhcmFjdGVyXSAhPSBudWxsICYmIGV2ZW50LmNoYXJhY3RlcnNbY2hhcmFjdGVyXS50ZXh0ICE9IFwiXCI7XHJcbiAgICAgICAgICAgIGxpc3RlbihpbnB1dCwgXCJjaGFuZ2VcIiwgb25DaGFuZ2VDaGFyYWN0ZXJDaGVja2JveCk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB2YXIgaWQgPSBpK3Nob3BBc3NldERhdGEubmFtZTtcclxuICAgICAgICAgICAgc2V0QXR0cihpbnB1dCwgJ2lkJywgaWQpO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhpbnB1dCwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICBhZGRFbCh0ZCwgaW5wdXQpO1xyXG4gICAgICAgICAgICB2YXIgbGFiZWwgPSBhZGRDbGFzcyhtYWtlRWwoJ2xhYmVsJyksJ2NoZWNrYm94LWxhYmVsJyk7XHJcbiAgICAgICAgICAgIHNldEF0dHIobGFiZWwsICdmb3InLCBpZCk7XHJcbiAgICAgICAgICAgIGFkZEVsKHRkLCBsYWJlbCk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB0ci5hcHBlbmRDaGlsZCh0ZCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmV0dXJuIHRyO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIG9uQ2hhbmdlQ2hhcmFjdGVyQ2hlY2tib3ggPSAoZXZlbnQpPT57XHJcbiAgICAgICAgdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldDtcclxuICAgICAgICBpZiAodGFyZ2V0LmNoZWNrZWQpIHtcclxuLy8gICAgICAgICAgICBVdGlscy5jb25maXJtKHN0ckZvcm1hdChnZXRMMTBuKCdhc3NldC1jb25maXJtLWFkZGluZy1hc3NldCcpLCBbdGFyZ2V0LmFzc2V0TmFtZSwgdGFyZ2V0LnNob3BOYW1lXSksICgpID0+IHsgIFxyXG4gICAgICAgICAgICAgICAgREJNUy5hZGRBc3NldFRvU2hvcCh0YXJnZXQuYXNzZXROYW1lLCB0YXJnZXQuc2hvcE5hbWUsIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuLy8gICAgICAgICAgICB9LCAoKSA9PiB0YXJnZXQuY2hlY2tlZCA9ICF0YXJnZXQuY2hlY2tlZCk7IFxyXG4gICAgICAgIH0gZWxzZSB7XHJcbi8vICAgICAgICAgICAgVXRpbHMuY29uZmlybShzdHJGb3JtYXQoZ2V0TDEwbignYXNzZXQtY29uZmlybS1yZW1vdmluZy1hc3NldCcpLCBbdGFyZ2V0LmFzc2V0TmFtZSwgdGFyZ2V0LnNob3BOYW1lXSksICgpID0+IHsgIFxyXG4gICAgICAgICAgICAgICAgREJNUy5yZW1vdmVBc3NldEZyb21TaG9wKHRhcmdldC5hc3NldE5hbWUsIHRhcmdldC5zaG9wTmFtZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4vLyAgICAgICAgICAgIH0sICgpID0+IHRhcmdldC5jaGVja2VkID0gIXRhcmdldC5jaGVja2VkKTsgXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxufSkodGhpc1snQXNzZXRQcmVzZW5jZSddPXt9KTsiLCIvKkNvcHlyaWdodCAyMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG5cInVzZSBzdHJpY3RcIjtcclxuXHJcbnZhciBBc3NldFByb2ZpbGVUbXBsID0gKGZ1bmN0aW9uKGV4cG9ydHMsIHJvb3QsIGFzc2V0UHJvZmlsZVN0cnVjdHVyZSwgaXNFZGl0YWJsZSwgZ2V0QXNzZXROYW1lcywgdXBkYXRlQXNzZXRGaWVsZCwgZ2V0QXNzZXQpe1xyXG4gICAgXHJcbiAgICB2YXIgc3RhdGUgPSB7fTtcclxuICAgIHZhciBsMTBuID0gTDEwbi5nZXQoJ2Fzc2V0Jyk7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwocm9vdCArXCIuZW50aXR5LXNlbGVjdG9yXCIpLCBcImNoYW5nZVwiLCBzaG93UHJvZmlsZUluZm9EZWxlZ2F0ZSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgdmFyIHRib2R5ID0gY2xlYXJFbChxdWVyeUVsKHJvb3QgKyBcIi5lbnRpdHktcHJvZmlsZVwiKSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgc3RhdGUuaW5wdXRJdGVtcyA9IHt9O1xyXG4gICAgICAgIFxyXG4gICAgICAgIENvbnN0YW50c1thc3NldFByb2ZpbGVTdHJ1Y3R1cmVdLmZvckVhY2goZnVuY3Rpb24gKHByb2ZpbGVTZXR0aW5ncykge1xyXG4gICAgICAgICAgICBwcm9maWxlU2V0dGluZ3MuZGlzcGxheU5hbWUgPSBsMTBuKHByb2ZpbGVTZXR0aW5ncy5uYW1lKTtcclxuICAgICAgICAgICAgYWRkRWwodGJvZHksIG1ha2VJbnB1dChwcm9maWxlU2V0dGluZ3MpKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgZ2V0QXNzZXROYW1lcyhmdW5jdGlvbihlcnIsIG5hbWVzKXtcclxuICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgICAgICAgICAgdmFyIHNlbCA9IGNsZWFyRWwocXVlcnlFbChyb290ICsgXCIuZW50aXR5LXNlbGVjdG9yXCIpKTtcclxuICAgICAgICAgICAgZmlsbFNlbGVjdG9yKHNlbCwgbmFtZXMubWFwKHJlbWFwUHJvcHM0U2VsZWN0KSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgbWFrZUlucHV0ID0gZnVuY3Rpb24gKHByb2ZpbGVJdGVtQ29uZmlnKSB7XHJcbiAgICAgICAgdmFyIHNwYW4gPSBzZXRBdHRyKG1ha2VFbCgnc3BhbicpLCBcImwxMG4taWRcIiwgXCJhc3NldC1cIiArIHByb2ZpbGVJdGVtQ29uZmlnLm5hbWUpO1xyXG4gICAgICAgIHZhciB0ciA9IGFkZEVsKG1ha2VFbChcInRyXCIpLCBhZGRFbChtYWtlRWwoJ3RkJyksIGFkZEVsKHNwYW4sIG1ha2VUZXh0KHByb2ZpbGVJdGVtQ29uZmlnLmRpc3BsYXlOYW1lKSkpKVxyXG4gICAgICAgIHZhciBpbnB1dDtcclxuICAgICAgICBzd2l0Y2ggKHByb2ZpbGVJdGVtQ29uZmlnLnR5cGUpIHtcclxuICAgICAgICBjYXNlIFwidGV4dFwiOlxyXG4gICAgICAgICAgICBpbnB1dCA9IG1ha2VFbChcInRleHRhcmVhXCIpO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhpbnB1dCwgXCJwcm9maWxlVGV4dElucHV0XCIpO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhpbnB1dCwnZm9ybS1jb250cm9sJyk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgXCJzdHJpbmdcIjpcclxuICAgICAgICAgICAgaW5wdXQgPSBtYWtlRWwoXCJpbnB1dFwiKTtcclxuICAgICAgICAgICAgYWRkQ2xhc3MoaW5wdXQsIFwicHJvZmlsZVN0cmluZ0lucHV0XCIpO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhpbnB1dCwnZm9ybS1jb250cm9sJyk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgXCJudW1iZXJcIjpcclxuICAgICAgICAgICAgaW5wdXQgPSBtYWtlRWwoXCJpbnB1dFwiKTtcclxuICAgICAgICAgICAgaW5wdXQudHlwZSA9IFwibnVtYmVyXCI7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKGlucHV0LCdmb3JtLWNvbnRyb2wnKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBcImNoZWNrYm94XCI6XHJcbiAgICAgICAgICAgIGlucHV0ID0gbWFrZUVsKFwiaW5wdXRcIik7XHJcbiAgICAgICAgICAgIGlucHV0LnR5cGUgPSBcImNoZWNrYm94XCI7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5leHBlY3RlZCB0eXBlICcgKyBwcm9maWxlSXRlbUNvbmZpZy50eXBlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaW5wdXQuc2VsZk5hbWUgPSBwcm9maWxlSXRlbUNvbmZpZy5uYW1lO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmKCFpc0VkaXRhYmxlKXtcclxuICAgICAgICAgICAgc2V0QXR0cihpbnB1dCwgJ2Rpc2FibGVkJywgJ3RydWUnKTtcclxuICAgICAgICB9XHJcbi8vICAgICAgICBhZGRDbGFzcyhpbnB1dCxcImlzR3JvdXBFZGl0YWJsZVwiKTtcclxuICAgICAgICBzdGF0ZS5pbnB1dEl0ZW1zW3Byb2ZpbGVJdGVtQ29uZmlnLm5hbWVdID0gaW5wdXQ7XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGlzdGVuKGlucHV0LCBcImNoYW5nZVwiLCB1cGRhdGVGaWVsZFZhbHVlKHByb2ZpbGVJdGVtQ29uZmlnLnR5cGUpKTtcclxuICAgIFxyXG4gICAgICAgIHJldHVybiBhZGRFbCh0ciwgYWRkRWwobWFrZUVsKCd0ZCcpLCBpbnB1dCkpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIHVwZGF0ZUZpZWxkVmFsdWUgPSBmdW5jdGlvbih0eXBlKXtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24oZXZlbnQpe1xyXG4gICAgICAgICAgICB2YXIgZmllbGROYW1lID0gZXZlbnQudGFyZ2V0LnNlbGZOYW1lO1xyXG4gICAgICAgICAgICB2YXIgYXNzZXROYW1lID0gc3RhdGUubmFtZTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHZhciB2YWx1ZTtcclxuICAgICAgICAgICAgc3dpdGNoKHR5cGUpe1xyXG4gICAgICAgICAgICBjYXNlIFwidGV4dFwiOlxyXG4gICAgICAgICAgICBjYXNlIFwic3RyaW5nXCI6XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFwibnVtYmVyXCI6XHJcbiAgICAgICAgICAgICAgICBpZiAoaXNOYU4oZXZlbnQudGFyZ2V0LnZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oXCJwcm9maWxlcy1ub3QtYS1udW1iZXJcIikpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC52YWx1ZSA9IGV2ZW50LnRhcmdldC5vbGRWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IE51bWJlcihldmVudC50YXJnZXQudmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgXCJjaGVja2JveFwiOlxyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSBldmVudC50YXJnZXQuY2hlY2tlZDtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmV4cGVjdGVkIHR5cGUgJyArIHR5cGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHVwZGF0ZUFzc2V0RmllbGQoYXNzZXROYW1lLCBmaWVsZE5hbWUsIHZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIHNob3dQcm9maWxlSW5mb0RlbGVnYXRlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIG5hbWUgPSBldmVudC50YXJnZXQudmFsdWUudHJpbSgpO1xyXG4gICAgICAgIGdldEFzc2V0KG5hbWUsIHNob3dQcm9maWxlSW5mb0NhbGxiYWNrKTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBzaG93UHJvZmlsZUluZm9DYWxsYmFjayA9IGZ1bmN0aW9uIChlcnIsIGFzc2V0KSB7XHJcbiAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgICAgICB2YXIgbmFtZSA9IGFzc2V0Lm5hbWU7XHJcbiAgICAgICAgc3RhdGUubmFtZSA9IG5hbWU7XHJcbiAgICAgICAgdmFyIGlucHV0SXRlbXMgPSBzdGF0ZS5pbnB1dEl0ZW1zO1xyXG4gICAgICAgIE9iamVjdC5rZXlzKGlucHV0SXRlbXMpLmZvckVhY2goZnVuY3Rpb24gKGlucHV0TmFtZSkge1xyXG4gICAgICAgICAgICBpZiAoaW5wdXRJdGVtc1tpbnB1dE5hbWVdLnR5cGUgPT09IFwiY2hlY2tib3hcIikge1xyXG4gICAgICAgICAgICAgICAgaW5wdXRJdGVtc1tpbnB1dE5hbWVdLmNoZWNrZWQgPSBhc3NldFtpbnB1dE5hbWVdO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaW5wdXRJdGVtc1tpbnB1dE5hbWVdLnZhbHVlID0gYXNzZXRbaW5wdXROYW1lXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpbnB1dEl0ZW1zW2lucHV0TmFtZV0ub2xkVmFsdWUgPSBhc3NldFtpbnB1dE5hbWVdO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFxyXG59KTtcclxuXHJcbkFzc2V0UHJvZmlsZVRtcGwodGhpc1snQXNzZXRQcm9maWxlJ109e30sICcuYXNzZXQtcHJvZmlsZS10YWIgJywgJ2Fzc2V0UHJvZmlsZVN0cnVjdHVyZScsIHRydWUsIChjYWxsYmFjaykgPT4ge1xyXG4gICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ2Fzc2V0JywgZmFsc2UsIGNhbGxiYWNrKTtcclxufSwgKGFzc2V0TmFtZSwgZmllbGROYW1lLCB2YWx1ZSwgY2FsbGJhY2spID0+IHtcclxuICAgIERCTVMudXBkYXRlQXNzZXRGaWVsZChhc3NldE5hbWUsIGZpZWxkTmFtZSwgdmFsdWUsIGNhbGxiYWNrKTtcclxufSwgKG5hbWUsIGNhbGxiYWNrKSA9PiB7XHJcbiAgICBEQk1TLmdldEFzc2V0KG5hbWUsIGNhbGxiYWNrKTtcclxufSk7XHJcblxyXG5Bc3NldFByb2ZpbGVUbXBsKHRoaXNbJ0dsb2JhbEFzc2V0UHJvZmlsZSddPXt9LCAnLmdsb2JhbC1hc3NldC1wcm9maWxlLXRhYiAnLCAnYXNzZXRQcm9maWxlU3RydWN0dXJlJywgZmFsc2UsIChjYWxsYmFjaykgPT4ge1xyXG4gICAgdmFyIHNob3BOYW1lID0gU2hvcE1hbmFnZW1lbnQuZ2V0Q3VycmVudFNob3BOYW1lKCk7XHJcbiAgICBEQk1TLmdldFNob3Aoc2hvcE5hbWUsIGZ1bmN0aW9uKGVyciwgc2hvcERhdGEpe1xyXG4gICAgICAgIGlmKGVycikge2NhbGxiYWNrKGVycik7IHJldHVybjt9XHJcbiAgICAgICAgdmFyIGFzc2V0cyA9IFIua2V5cyhzaG9wRGF0YS5hc3NldHMpLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEpLm1hcChuYW1lID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIGRpc3BsYXlOYW1lOiBuYW1lLFxyXG4gICAgICAgICAgICAgICAgdmFsdWU6IG5hbWVcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsYXNzZXRzKTtcclxuICAgIH0pO1xyXG59LCAoYXNzZXROYW1lLCBmaWVsZE5hbWUsIHZhbHVlLCBjYWxsYmFjaykgPT4ge1xyXG4gICAgVXRpbHMuYWxlcnQoZ2V0TDEwbignZXJyb3JzLXVuc3VwcG9ydGVkLW9wZXJhdGlvbicpKTtcclxufSwgKG5hbWUsIGNhbGxiYWNrKSA9PiB7XHJcbiAgICBEQk1TLmdldEFzc2V0KG5hbWUsIGNhbGxiYWNrKTtcclxufSk7XHJcblxyXG5Bc3NldFByb2ZpbGVUbXBsKHRoaXNbJ0xvY2FsQXNzZXRQcm9maWxlJ109e30sICcubG9jYWwtYXNzZXQtcHJvZmlsZS10YWIgJywgJ2xvY2FsQXNzZXRQcm9maWxlU3RydWN0dXJlJywgdHJ1ZSwgKGNhbGxiYWNrKSA9PiB7XHJcbiAgICB2YXIgc2hvcE5hbWUgPSBTaG9wTWFuYWdlbWVudC5nZXRDdXJyZW50U2hvcE5hbWUoKTtcclxuICAgIERCTVMuZ2V0U2hvcChzaG9wTmFtZSwgZnVuY3Rpb24oZXJyLCBzaG9wRGF0YSl7XHJcbiAgICAgICAgaWYoZXJyKSB7Y2FsbGJhY2soZXJyKTsgcmV0dXJuO31cclxuICAgICAgICB2YXIgbG9jYWxBc3NldHMgPSBSLmtleXMoc2hvcERhdGEubG9jYWxBc3NldHMpLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEpLm1hcChuYW1lID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIGRpc3BsYXlOYW1lOiBuYW1lLFxyXG4gICAgICAgICAgICAgICAgdmFsdWU6IG5hbWVcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsbG9jYWxBc3NldHMpO1xyXG4gICAgfSk7XHJcbn0sIChhc3NldE5hbWUsIGZpZWxkTmFtZSwgdmFsdWUsIGNhbGxiYWNrKSA9PiB7XHJcbiAgICBEQk1TLnVwZGF0ZUxvY2FsQXNzZXRGaWVsZChTaG9wTWFuYWdlbWVudC5nZXRDdXJyZW50U2hvcE5hbWUoKSwgYXNzZXROYW1lLCBmaWVsZE5hbWUsIHZhbHVlLCBjYWxsYmFjayk7XHJcbn0sIChuYW1lLCBjYWxsYmFjaykgPT4ge1xyXG4gICAgREJNUy5nZXRMb2NhbEFzc2V0KFNob3BNYW5hZ2VtZW50LmdldEN1cnJlbnRTaG9wTmFtZSgpLCBuYW1lLCAoZXJyLCBhc3NldCkgPT4ge1xyXG4gICAgICAgIGlmKGVycikge2NhbGxiYWNrKGVycik7IHJldHVybjt9XHJcbiAgICAgICAgYXNzZXQubmFtZSA9IG5hbWU7XHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgYXNzZXQpO1xyXG4gICAgfSk7XHJcbn0pOyIsIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcblwidXNlIHN0cmljdFwiO1xyXG5cclxuKGZ1bmN0aW9uKGV4cG9ydHMpe1xyXG5cclxuICAgIHZhciBzdGF0ZSA9IHt9O1xyXG4gICAgdmFyIHJvb3QgPSAnLmFzc2V0cy10YWIgJztcclxuICAgIHZhciBjdXJyZW50U2hvcCA9IHVuZGVmaW5lZDtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5pbml0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHN0YXRlLnZpZXdzID0ge307XHJcbiAgICAgICAgdmFyIG5hdiA9IHJvb3QgKyBcIi5zdWItdGFiLW5hdmlnYXRpb25cIjtcclxuICAgICAgICB2YXIgY29udGVudCA9IHJvb3QgKyBcIi5zdWItdGFiLWNvbnRlbnRcIjtcclxuICAgICAgICB2YXIgY29udGFpbmVycyA9IHtcclxuICAgICAgICAgICAgcm9vdDogc3RhdGUsXHJcbiAgICAgICAgICAgIG5hdmlnYXRpb246IHF1ZXJ5RWwobmF2KSxcclxuICAgICAgICAgICAgY29udGVudDogcXVlcnlFbChjb250ZW50KVxyXG4gICAgICAgIH07XHJcbi8vICAgICAgICBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsIFwic2hvcC1lZGl0b3JcIiwgU2hvcEVkaXRvcix7bWFpblBhZ2U6dHJ1ZX0pO1xyXG4vLyAgICAgICAgVXRpbHMuYWRkVmlldyhjb250YWluZXJzLCBcInNob3Atdmlld1wiLCBTaG9wVmlldyk7XHJcbi8vICAgICAgICBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsIFwic2hvcC1iaW5kaW5nXCIsIFNob3BCaW5kaW5nKTtcclxuICAgICAgICBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsIFwiYXNzZXQtcHJvZmlsZVwiLCBBc3NldFByb2ZpbGUsIHttYWluUGFnZTp0cnVlfSk7XHJcbiAgICAgICAgVXRpbHMuYWRkVmlldyhjb250YWluZXJzLCBcImFzc2V0LXByZXNlbmNlXCIsIEFzc2V0UHJlc2VuY2UpO1xyXG4gICAgXHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwocm9vdCArIFwiLmNyZWF0ZS1lbnRpdHktYnV0dG9uXCIpLCBcImNsaWNrXCIsIGNyZWF0ZVByb2ZpbGUoKSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwocm9vdCArIFwiLnJlbmFtZS1lbnRpdHktYnV0dG9uXCIpLCBcImNsaWNrXCIsIHJlbmFtZVByb2ZpbGUoKSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwocm9vdCArIFwiLnJlbW92ZS1lbnRpdHktYnV0dG9uXCIpLCBcImNsaWNrXCIsIHJlbW92ZVByb2ZpbGUoKSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwocm9vdCArIFwiLmltcG9ydC1pbXBsYW50cy1idXR0b25cIiksIFwiY2xpY2tcIiwgaW1wb3J0SW1wbGFudHMpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKHJvb3QgKyBcIi5pbXBvcnQtcGlsbHMtYnV0dG9uXCIpLCBcImNsaWNrXCIsIGltcG9ydFBpbGxzKTtcclxuLy8gICAgICAgICQoXCIjYXNzZXRTZWxlY3RvclwiKS5zZWxlY3QyKCkub24oXCJjaGFuZ2VcIiwgb25TaG9wU2VsZWN0b3JDaGFuZ2VEZWxlZ2F0ZSk7XHJcblxyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLmdldEVudGl0eU5hbWVzQXJyYXkoJ2Fzc2V0JywgdHJ1ZSwgZnVuY3Rpb24oZXJyLCBlbnRpdHlOYW1lcyl7XHJcbiAgICAgICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XHJcbiAgICAgICAgICAgIHJlYnVpbGRJbnRlcmZhY2UoZW50aXR5TmFtZXMpO1xyXG4gICAgICAgICAgICBzdGF0ZS5jdXJyZW50Vmlldy5yZWZyZXNoKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnRzLmdldEN1cnJlbnRTaG9wID0gKCkgPT4gY3VycmVudFNob3A7XHJcbiAgICBcclxuICAgIHZhciBvblNob3BTZWxlY3RvckNoYW5nZURlbGVnYXRlID0gKGV2ZW50KSA9PntcclxuICAgICAgICBjdXJyZW50U2hvcCA9IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuLy8gICAgICAgIHN0YXRlLmN1cnJlbnRWaWV3LnJlZnJlc2goKTtcclxuLy8gICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIHJlYnVpbGRJbnRlcmZhY2UgPSBmdW5jdGlvbiAobmFtZXMpIHtcclxuLy8gICAgICAgIGlmKG5hbWVzLmxlbmd0aCA9PT0gMCl7XHJcbi8vICAgICAgICAgICAgY3VycmVudFNob3AgPSB1bmRlZmluZWQ7XHJcbi8vICAgICAgICB9IGVsc2Uge1xyXG4vLyAgICAgICAgICAgIGlmKGN1cnJlbnRTaG9wICE9PSB1bmRlZmluZWQpe1xyXG4vLyAgICAgICAgICAgICAgICBpZihSLmZpbmQoUi5lcXVhbHMoY3VycmVudFNob3ApLCBuYW1lcy5tYXAoUi5wcm9wKCd2YWx1ZScpKSkgPT09IHVuZGVmaW5lZCl7XHJcbi8vICAgICAgICAgICAgICAgICAgICBjdXJyZW50U2hvcCA9IG5hbWVzWzBdLnZhbHVlO1xyXG4vLyAgICAgICAgICAgICAgICB9XHJcbi8vICAgICAgICAgICAgfSBlbHNlIHtcclxuLy8gICAgICAgICAgICAgICAgY3VycmVudFNob3AgPSBuYW1lc1swXS52YWx1ZTtcclxuLy8gICAgICAgICAgICB9XHJcbi8vICAgICAgICB9XHJcbiAgICAgICAgdmFyIGRhdGEgPSBnZXRTZWxlY3QyRGF0YShuYW1lcyk7XHJcbi8vICAgICAgICBcclxuLy8gICAgICAgIGNsZWFyRWwocXVlcnlFbCggXCIjYXNzZXRTZWxlY3RvclwiKSk7XHJcbi8vICAgICAgICBpZihjdXJyZW50U2hvcCA9PT0gdW5kZWZpbmVkKXtcclxuLy8gICAgICAgICAgICAkKFwiI2Fzc2V0U2VsZWN0b3JcIikuc2VsZWN0MihkYXRhKTtcclxuLy8gICAgICAgIH0gZWxzZSB7XHJcbi8vICAgICAgICAgICAgJChcIiNhc3NldFNlbGVjdG9yXCIpLnNlbGVjdDIoZGF0YSkudmFsKGN1cnJlbnRTaG9wKS50cmlnZ2VyKCdjaGFuZ2UnKTtcclxuLy8vLyAgICAgICAgICAgICQoXCIjc2hvcFNlbGVjdG9yXCIpLnNlbGVjdDIoZGF0YSkudmFsKGN1cnJlbnRTaG9wKTtcclxuLy8gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBjbGVhckVsKHF1ZXJ5RWwocm9vdCArIFwiLnJlbmFtZS1lbnRpdHktc2VsZWN0XCIpKTtcclxuICAgICAgICAkKHJvb3QgKyBcIi5yZW5hbWUtZW50aXR5LXNlbGVjdFwiKS5zZWxlY3QyKGRhdGEpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNsZWFyRWwocXVlcnlFbChyb290ICsgXCIucmVtb3ZlLWVudGl0eS1zZWxlY3RcIikpO1xyXG4gICAgICAgICQocm9vdCArIFwiLnJlbW92ZS1lbnRpdHktc2VsZWN0XCIpLnNlbGVjdDIoZGF0YSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgaW1wb3J0SW1wbGFudHMgPSAoKSA9PiB7XHJcbiAgICAgICAgREJNUy5pbXBvcnRJbXBsYW50cyhmdW5jdGlvbihlcnIpe1xyXG4gICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBpbXBvcnRQaWxscyA9ICgpID0+IHtcclxuICAgICAgICBEQk1TLmltcG9ydFBpbGxzKGZ1bmN0aW9uKGVycil7XHJcbiAgICAgICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XHJcbiAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIGNyZWF0ZVByb2ZpbGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgIHZhciBpbnB1dCA9IHF1ZXJ5RWwocm9vdCArIFwiLmNyZWF0ZS1lbnRpdHktaW5wdXRcIik7XHJcbiAgICAgICAgICAgIHZhciBuYW1lID0gaW5wdXQudmFsdWUudHJpbSgpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgREJNUy5jcmVhdGVBc3NldChuYW1lLCBmdW5jdGlvbihlcnIpe1xyXG4gICAgICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5yZWZyZXNoKGZ1bmN0aW9uKGVycil7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuLy8gICAgICAgICAgICAgICAgICAgIGlmKHN0YXRlLmN1cnJlbnRWaWV3LnVwZGF0ZVNldHRpbmdzKXtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5jdXJyZW50Vmlldy51cGRhdGVTZXR0aW5ncyhuYW1lKTtcclxuLy8gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciByZW5hbWVQcm9maWxlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiBmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICB2YXIgdG9JbnB1dCA9IHF1ZXJ5RWwocm9vdCArIFwiLnJlbmFtZS1lbnRpdHktaW5wdXRcIik7XHJcbiAgICAgICAgICAgIHZhciBmcm9tTmFtZSA9IHF1ZXJ5RWwocm9vdCArIFwiLnJlbmFtZS1lbnRpdHktc2VsZWN0XCIpLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICAgICAgdmFyIHRvTmFtZSA9IHRvSW5wdXQudmFsdWUudHJpbSgpO1xyXG4gICAgICAgIFxyXG4gICAgICAgICAgICBEQk1TLnJlbmFtZUFzc2V0KGZyb21OYW1lLCB0b05hbWUsIGZ1bmN0aW9uKGVycil7XHJcbiAgICAgICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLnJlZnJlc2goZnVuY3Rpb24oZXJyKXtcclxuICAgICAgICAgICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICAgICAgICAgIHRvSW5wdXQudmFsdWUgPSAnJztcclxuLy8gICAgICAgICAgICAgICAgICAgIGlmKHN0YXRlLmN1cnJlbnRWaWV3LnVwZGF0ZVNldHRpbmdzKXtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5jdXJyZW50Vmlldy51cGRhdGVTZXR0aW5ncyh0eXBlLCB0b05hbWUpO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciByZW1vdmVQcm9maWxlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiBmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICB2YXIgbmFtZSA9IHF1ZXJ5RWwocm9vdCArIFwiLnJlbW92ZS1lbnRpdHktc2VsZWN0XCIpLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICBcclxuICAgICAgICAgICAgVXRpbHMuY29uZmlybShzdHJGb3JtYXQoZ2V0TDEwbihcImFzc2V0LWFyZS15b3Utc3VyZS1hYm91dC1hc3NldC1yZW1vdmluZ1wiKSxbbmFtZV0pLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBEQk1TLnJlbW92ZUFzc2V0KG5hbWUsIGZ1bmN0aW9uKGVycil7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgICAgICAgICAgICAgICAgICBQZXJtaXNzaW9uSW5mb3JtZXIucmVmcmVzaChmdW5jdGlvbihlcnIpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxufSkodGhpc1snQXNzZXRzJ109e30pOyIsIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcblwidXNlIHN0cmljdFwiO1xyXG5cclxuKGZ1bmN0aW9uKGV4cG9ydHMpe1xyXG4gICAgXHJcbiAgICB2YXIgcm9vdCA9ICcuY2F0ZWdvcnktY29udGVudC1tYW5hZ2VtZW50LXRhYiAnO1xyXG4gICAgdmFyIGNhdGVnb3J5Q29udGVudFJvb3QgPSByb290ICsgJy5jYXRlZ29yeS1jb250ZW50LW1hbmFnZW1lbnQgJztcclxuICAgIHZhciBzdGF0ZSA9IHt9O1xyXG4gICAgc3RhdGUuc29ydEtleSA9IDA7XHJcbiAgICBzdGF0ZS5zb3J0RGlyID0gXCJhc2NcIjtcclxuXHJcbiAgICB2YXIgaGVhZEFyciA9IFsgJ2NhdGVnb3J5TmFtZScsXHJcbiAgICAgICAgJ2Fzc2V0TmFtZScsXHJcbiAgICAgICAgJ2Rpc3BsYXlTdHJpbmcnLFxyXG4gICAgICAgICdjb3N0JyxcclxuICAgICAgICAndHlwZScsXHJcbiAgICAgICAgJ3Jlc291cmNlQ29zdCcsXHJcbiAgICAgICAgJ2lzUGh5c2ljYWwnLFxyXG4gICAgICAgICdkZXNjcmlwdGlvbicgXTtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChjYXRlZ29yeUNvbnRlbnRSb290ICsgXCIuYWRkLWVudGl0eS1idXR0b24tMVwiKSxcImNsaWNrXCIsIGFkZEdsb2JhbEFzc2V0VG9DYXRlZ29yeSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwiLmFkZC1lbnRpdHktYnV0dG9uLTJcIiksXCJjbGlja1wiLCBhZGRMb2NhbEFzc2V0VG9DYXRlZ29yeSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwiLnJlbW92ZS1lbnRpdHktYnV0dG9uLTFcIiksXCJjbGlja1wiLCByZW1vdmVHbG9iYWxBc3NldEZyb21DYXRlZ29yeSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwiLnJlbW92ZS1lbnRpdHktYnV0dG9uLTJcIiksXCJjbGlja1wiLCByZW1vdmVMb2NhbEFzc2V0RnJvbUNhdGVnb3J5KTtcclxuICAgICAgICBcclxuICAgICAgICBpbml0U29ydEljb25zKCk7XHJcbiAgICAgICAgcXVlcnlFbHMoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwidGhlYWQgdHIgaW5wdXRcIikubWFwKGxpc3RlbihSLl9fLCAnaW5wdXQnLCBleHBvcnRzLnJlZnJlc2gpKTtcclxuICAgICAgICBcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgdmFyIHNob3BOYW1lID0gU2hvcE1hbmFnZW1lbnQuZ2V0Q3VycmVudFNob3BOYW1lKCk7XHJcbiAgICAgICAgREJNUy5nZXRTaG9wKHNob3BOYW1lLCBmdW5jdGlvbihlcnIsIHNob3BEYXRhKXtcclxuICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHZhciBkYXRhID0gYXJyMlNlbGVjdDIoUi5rZXlzKHNob3BEYXRhLmNhdGVnb3JpZXMpLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGNsZWFyRWwocXVlcnlFbChjYXRlZ29yeUNvbnRlbnRSb290ICsgXCIuYWRkLWVudGl0eS1zZWxlY3QtMTJcIikpO1xyXG4gICAgICAgICAgICAkKGNhdGVnb3J5Q29udGVudFJvb3QgKyBcIi5hZGQtZW50aXR5LXNlbGVjdC0xMlwiKS5zZWxlY3QyKGRhdGEpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY2xlYXJFbChxdWVyeUVsKGNhdGVnb3J5Q29udGVudFJvb3QgKyBcIi5hZGQtZW50aXR5LXNlbGVjdC0yMlwiKSk7XHJcbiAgICAgICAgICAgICQoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwiLmFkZC1lbnRpdHktc2VsZWN0LTIyXCIpLnNlbGVjdDIoZGF0YSk7XHJcblxyXG4gICAgICAgICAgICB2YXIgZ2xvYmFsQXNzZXRzID0gYXJyMlNlbGVjdDIoUi5rZXlzKHNob3BEYXRhLmFzc2V0cykpO1xyXG4vLyAgICAgICAgICAgIGdsb2JhbEFzc2V0cy5wbGFjZWhvbGRlciA9IFwiU2VsZWN0IGFuIG9wdGlvblwiO1xyXG4gICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwiLmFkZC1lbnRpdHktc2VsZWN0LTExXCIpKTtcclxuICAgICAgICAgICAgJChjYXRlZ29yeUNvbnRlbnRSb290ICsgXCIuYWRkLWVudGl0eS1zZWxlY3QtMTFcIikuc2VsZWN0MigoZ2xvYmFsQXNzZXRzKSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB2YXIgbG9jYWxBc3NldHMgPSBhcnIyU2VsZWN0MihSLmtleXMoc2hvcERhdGEubG9jYWxBc3NldHMpKTtcclxuICAgICAgICAgICAgY2xlYXJFbChxdWVyeUVsKGNhdGVnb3J5Q29udGVudFJvb3QgKyBcIi5hZGQtZW50aXR5LXNlbGVjdC0yMVwiKSk7XHJcbiAgICAgICAgICAgICQoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwiLmFkZC1lbnRpdHktc2VsZWN0LTIxXCIpLnNlbGVjdDIoKGxvY2FsQXNzZXRzKSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB2YXIgZ2V0TGlzdCA9IChjb250YWluZXIpID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBSLnVubmVzdChSLmtleXMoc2hvcERhdGEuY2F0ZWdvcmllcykubWFwKGNhdGVnb3J5TmFtZSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFIua2V5cyhzaG9wRGF0YS5jYXRlZ29yaWVzW2NhdGVnb3J5TmFtZV1bY29udGFpbmVyXSkubWFwKGFzc2V0TmFtZSA9PiBbY2F0ZWdvcnlOYW1lLCBhc3NldE5hbWVdKVxyXG4gICAgICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBhc3NldHMgPSBnZXRMaXN0KCdnbG9iYWxzJykubWFwKCBhcnIgPT4gUi56aXBPYmooWydkaXNwbGF5TmFtZScsJ3ZhbHVlJ10sIFthcnJbMF0gKyAnLycgKyBhcnJbMV0sIEpTT04uc3RyaW5naWZ5KGFycildKSk7XHJcbiAgICAgICAgICAgIGFzc2V0cy5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBRmFjdG9yeShSLnByb3AoJ2Rpc3BsYXlOYW1lJykpKVxyXG4gICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwiLnJlbW92ZS1lbnRpdHktc2VsZWN0LTFcIikpO1xyXG4gICAgICAgICAgICAkKGNhdGVnb3J5Q29udGVudFJvb3QgKyBcIi5yZW1vdmUtZW50aXR5LXNlbGVjdC0xXCIpLnNlbGVjdDIoZ2V0U2VsZWN0MkRhdGEoYXNzZXRzKSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB2YXIgYXNzZXRzID0gZ2V0TGlzdCgnbG9jYWxzJykubWFwKCBhcnIgPT4gUi56aXBPYmooWydkaXNwbGF5TmFtZScsJ3ZhbHVlJ10sIFthcnJbMF0gKyAnLycgKyBhcnJbMV0sIEpTT04uc3RyaW5naWZ5KGFycildKSk7XHJcbiAgICAgICAgICAgIGFzc2V0cy5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBRmFjdG9yeShSLnByb3AoJ2Rpc3BsYXlOYW1lJykpKVxyXG4gICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwiLnJlbW92ZS1lbnRpdHktc2VsZWN0LTJcIikpO1xyXG4gICAgICAgICAgICAkKGNhdGVnb3J5Q29udGVudFJvb3QgKyBcIi5yZW1vdmUtZW50aXR5LXNlbGVjdC0yXCIpLnNlbGVjdDIoZ2V0U2VsZWN0MkRhdGEoYXNzZXRzKSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBmaWxsU2hvcFRhYmxlKHNob3BEYXRhKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBpbml0U29ydEljb25zID0gKCkgPT4ge1xyXG4gICAgICAgIHZhciBpY29ucyA9IHF1ZXJ5RWxzKGNhdGVnb3J5Q29udGVudFJvb3QgKyBcInRoZWFkIHRyLmZpcnN0LXJvdyB0aFwiKTtcclxuICAgICAgICBpY29ucy5tYXAoKGljb24sIGkpID0+IHtcclxuICAgICAgICAgICAgaWNvbi5pbmRleCA9IGk7XHJcbiAgICAgICAgICAgIGxpc3RlbihpY29uLCBcImNsaWNrXCIsIG9uU29ydENoYW5nZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgb25Tb3J0Q2hhbmdlID0gZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldDtcclxuICAgICAgICBpZih0YXJnZXQudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSBcInNwYW5cIil7XHJcbiAgICAgICAgICAgIHRhcmdldCA9IHRhcmdldC5wYXJlbnRFbGVtZW50O1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBpZiAoc3RhdGUuc29ydEtleSA9PT0gdGFyZ2V0LmluZGV4KSB7XHJcbiAgICAgICAgICAgIHN0YXRlLnNvcnREaXIgPSBzdGF0ZS5zb3J0RGlyID09PSBcImFzY1wiID8gXCJkZXNjXCIgOiBcImFzY1wiO1xyXG4gICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKHRhcmdldCwgJ3NvcnREZXNjJywgc3RhdGUuc29ydERpciA9PT0gJ2Rlc2MnKTtcclxuICAgICAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbih0YXJnZXQsICdzb3J0QXNjJywgc3RhdGUuc29ydERpciA9PT0gJ2FzYycpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHZhciBmaWx0ZXJIZWFkID0gcXVlcnlFbChjYXRlZ29yeUNvbnRlbnRSb290ICsgXCJ0aGVhZFwiKTtcclxuICAgICAgICAgICAgbmwyYXJyYXkoZmlsdGVySGVhZC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKFwic29ydEFzY1wiKSkuZm9yRWFjaChyZW1vdmVDbGFzcyhSLl9fLCBcInNvcnRBc2NcIikpO1xyXG4gICAgICAgICAgICBubDJhcnJheShmaWx0ZXJIZWFkLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoXCJzb3J0RGVzY1wiKSkuZm9yRWFjaChyZW1vdmVDbGFzcyhSLl9fLCBcInNvcnREZXNjXCIpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHN0YXRlLnNvcnRLZXkgPSB0YXJnZXQuaW5kZXg7XHJcbiAgICAgICAgICAgIHN0YXRlLnNvcnREaXIgPSBcImFzY1wiO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyh0YXJnZXQsIFwic29ydEFzY1wiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgZGF0YTJzdHIgPSAoZGF0YSkgPT4ge1xyXG4gICAgICAgIGlmKGRhdGEuY29zdCAhPT0gLTEpe1xyXG4gICAgICAgICAgICB2YXIgaW5wdXQgPSBhZGRDbGFzcyhtYWtlRWwoJ2lucHV0JyksJ2Zvcm0tY29udHJvbCcpO1xyXG4gICAgICAgICAgICBzZXRBdHRyKGlucHV0LCAndHlwZScsICdudW1iZXInKTtcclxuICAgICAgICAgICAgc2V0QXR0cihpbnB1dCwgJ21pbicsICcwJyk7XHJcbiAgICAgICAgICAgIGlucHV0LnZhbHVlID0gZGF0YS5jb3N0O1xyXG4gICAgICAgICAgICBsaXN0ZW4oaW5wdXQsIFwiY2hhbmdlXCIsIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgREJNUy5zZXRBc3NldENvc3QoU2hvcE1hbmFnZW1lbnQuZ2V0Q3VycmVudFNob3BOYW1lKCksIGRhdGEudHlwZSwgZGF0YS5jYXRlZ29yeU5hbWUsIGRhdGEuYXNzZXROYW1lLCBOdW1iZXIoZXZlbnQudGFyZ2V0LnZhbHVlKSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpbnB1dCA9IG1ha2VUZXh0KCcnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGFkZEVscyhtYWtlRWwoJ3RyJyksIFthZGRFbChtYWtlRWwoJ3RkJyksIG1ha2VUZXh0KGRhdGEuY2F0ZWdvcnlOYW1lKSksXHJcbiAgICAgICAgICAgICAgICBhZGRFbChtYWtlRWwoJ3RkJyksIG1ha2VUZXh0KGRhdGEuYXNzZXROYW1lKSksXHJcbiAgICAgICAgICAgICAgICBhZGRFbChtYWtlRWwoJ3RkJyksIG1ha2VUZXh0KGRhdGEuZGlzcGxheVN0cmluZykpLFxyXG4gICAgICAgICAgICAgICAgYWRkRWwobWFrZUVsKCd0ZCcpLCBpbnB1dCksXHJcbi8vICAgICAgICAgICAgICAgIGFkZEVsKG1ha2VFbCgndGQnKSwgbWFrZVRleHQoZGF0YS5jb3N0KSksXHJcbiAgICAgICAgICAgICAgICBhZGRFbChtYWtlRWwoJ3RkJyksIG1ha2VUZXh0KGRhdGEudHlwZSkpLFxyXG4gICAgICAgICAgICAgICAgYWRkRWwobWFrZUVsKCd0ZCcpLCBtYWtlVGV4dChkYXRhLnJlc291cmNlQ29zdCkpLFxyXG4gICAgICAgICAgICAgICAgYWRkRWwobWFrZUVsKCd0ZCcpLCBtYWtlVGV4dChkYXRhLmlzUGh5c2ljYWwgPyBMMTBuLmdldCgnY29uc3RhbnQnLCAneWVzJykgOiAnJykpLFxyXG4gICAgICAgICAgICAgICAgYWRkRWwobWFrZUVsKCd0ZCcpLCBtYWtlVGV4dChkYXRhLmRlc2NyaXB0aW9uKSldKTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBmaWxsU2hvcFRhYmxlID0gKHNob3BEYXRhKSA9PiB7XHJcbiAgICAgICAgdmFyIHRhYmxlID0gY2xlYXJFbChxdWVyeUVsKGNhdGVnb3J5Q29udGVudFJvb3QgKyBcInRib2R5LnRhYmxlLWNvbnRlbnRcIikpO1xyXG4gICAgICAgIHZhciBkYXRhID0gUi51bm5lc3QoUi5rZXlzKHNob3BEYXRhLmNhdGVnb3JpZXMpLm1hcChjYXRlZ29yeU5hbWUgPT4ge1xyXG4gICAgICAgICAgICB2YXIgZ2xvYmFscyA9IHNob3BEYXRhLmNhdGVnb3JpZXNbY2F0ZWdvcnlOYW1lXS5nbG9iYWxzO1xyXG4gICAgICAgICAgICB2YXIgZGF0YSA9IFIua2V5cyhnbG9iYWxzKS5tYXAoZ2xvYmFsID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnlOYW1lOiBjYXRlZ29yeU5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgYXNzZXROYW1lOiBnbG9iYWwsXHJcbiAgICAgICAgICAgICAgICAgICAgZGlzcGxheVN0cmluZzogc2hvcERhdGEuZ2xvYmFsQXNzZXRzW2dsb2JhbF0uZGlzcGxheVN0cmluZyxcclxuICAgICAgICAgICAgICAgICAgICBjb3N0OiBnbG9iYWxzW2dsb2JhbF0uY29zdCxcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnZ2xvYmFsJyxcclxuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZUNvc3Q6IHNob3BEYXRhLmdsb2JhbEFzc2V0c1tnbG9iYWxdLnJlc291cmNlQ29zdCxcclxuICAgICAgICAgICAgICAgICAgICBpc1BoeXNpY2FsOiBzaG9wRGF0YS5nbG9iYWxBc3NldHNbZ2xvYmFsXS5pc1BoeXNpY2FsLFxyXG4gICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBzaG9wRGF0YS5nbG9iYWxBc3NldHNbZ2xvYmFsXS5kZXNjcmlwdGlvbixcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB2YXIgbG9jYWxzID0gc2hvcERhdGEuY2F0ZWdvcmllc1tjYXRlZ29yeU5hbWVdLmxvY2FscztcclxuICAgICAgICAgICAgZGF0YSA9IGRhdGEuY29uY2F0KFIua2V5cyhsb2NhbHMpLm1hcChsb2NhbCA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhdGVnb3J5TmFtZTogY2F0ZWdvcnlOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgIGFzc2V0TmFtZTogbG9jYWwsXHJcbiAgICAgICAgICAgICAgICAgICAgZGlzcGxheVN0cmluZzogc2hvcERhdGEubG9jYWxBc3NldHNbbG9jYWxdLmRpc3BsYXlTdHJpbmcsXHJcbiAgICAgICAgICAgICAgICAgICAgY29zdDogbG9jYWxzW2xvY2FsXS5jb3N0LFxyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdsb2NhbCcsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VDb3N0OiAwLFxyXG4gICAgICAgICAgICAgICAgICAgIGlzUGh5c2ljYWw6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBzaG9wRGF0YS5sb2NhbEFzc2V0c1tsb2NhbF0uZGVzY3JpcHRpb24sXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHJldHVybiBkYXRhO1xyXG4gICAgICAgIH0pKTtcclxuICAgICAgICB2YXIgdXNlZEdsb2JhbHMgPSBSLnVuaXEoUi5mbGF0dGVuKFIua2V5cyhzaG9wRGF0YS5jYXRlZ29yaWVzKS5tYXAoY2F0ZWdvcnlOYW1lID0+IFIua2V5cyhzaG9wRGF0YS5jYXRlZ29yaWVzW2NhdGVnb3J5TmFtZV0uZ2xvYmFscykpKSk7XHJcbiAgICAgICAgdmFyIHVzZWRMb2NhbHMgPSBSLnVuaXEoUi5mbGF0dGVuKFIua2V5cyhzaG9wRGF0YS5jYXRlZ29yaWVzKS5tYXAoY2F0ZWdvcnlOYW1lID0+IFIua2V5cyhzaG9wRGF0YS5jYXRlZ29yaWVzW2NhdGVnb3J5TmFtZV0ubG9jYWxzKSkpKTtcclxuICAgICAgICB2YXIgYWxsR2xvYmFscyA9IFIua2V5cyhzaG9wRGF0YS5hc3NldHMpO1xyXG4gICAgICAgIHZhciBhbGxMb2NhbHMgPSBSLmtleXMoc2hvcERhdGEubG9jYWxBc3NldHMpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGRhdGEgPSBSLmNvbmNhdChkYXRhLCBSLmRpZmZlcmVuY2UoYWxsR2xvYmFscywgdXNlZEdsb2JhbHMpLm1hcChnbG9iYWwgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgY2F0ZWdvcnlOYW1lOiBMMTBuLmdldCgnc2hvcCcsJ25vdC1pbi1jYXRlZ29yeScpLFxyXG4gICAgICAgICAgICAgICAgYXNzZXROYW1lOiBnbG9iYWwsXHJcbiAgICAgICAgICAgICAgICBkaXNwbGF5U3RyaW5nOiBzaG9wRGF0YS5nbG9iYWxBc3NldHNbZ2xvYmFsXS5kaXNwbGF5U3RyaW5nLFxyXG4gICAgICAgICAgICAgICAgY29zdDogLTEsXHJcbiAgICAgICAgICAgICAgICB0eXBlOiAnZ2xvYmFsJyxcclxuICAgICAgICAgICAgICAgIHJlc291cmNlQ29zdDogc2hvcERhdGEuZ2xvYmFsQXNzZXRzW2dsb2JhbF0ucmVzb3VyY2VDb3N0LFxyXG4gICAgICAgICAgICAgICAgaXNQaHlzaWNhbDogc2hvcERhdGEuZ2xvYmFsQXNzZXRzW2dsb2JhbF0uaXNQaHlzaWNhbCxcclxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBzaG9wRGF0YS5nbG9iYWxBc3NldHNbZ2xvYmFsXS5kZXNjcmlwdGlvbixcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pKTtcclxuICAgICAgICBkYXRhID0gUi5jb25jYXQoZGF0YSwgUi5kaWZmZXJlbmNlKGFsbExvY2FscywgdXNlZExvY2FscykubWFwKGxvY2FsID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIGNhdGVnb3J5TmFtZTogTDEwbi5nZXQoJ3Nob3AnLCdub3QtaW4tY2F0ZWdvcnknKSxcclxuICAgICAgICAgICAgICAgIGFzc2V0TmFtZTogbG9jYWwsXHJcbiAgICAgICAgICAgICAgICBkaXNwbGF5U3RyaW5nOiBzaG9wRGF0YS5sb2NhbEFzc2V0c1tsb2NhbF0uZGlzcGxheVN0cmluZyxcclxuICAgICAgICAgICAgICAgIGNvc3Q6IC0xLFxyXG4gICAgICAgICAgICAgICAgdHlwZTogJ2xvY2FsJyxcclxuICAgICAgICAgICAgICAgIHJlc291cmNlQ29zdDogMCxcclxuICAgICAgICAgICAgICAgIGlzUGh5c2ljYWw6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHNob3BEYXRhLmxvY2FsQXNzZXRzW2xvY2FsXS5kZXNjcmlwdGlvbixcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgdmFyIHNvcnRGdW5jID0gQ29tbW9uVXRpbHMuY2hhck9yZEFGYWN0b3J5QmFzZShzdGF0ZS5zb3J0RGlyLCBmdW5jdGlvbihhKXtcclxuICAgICAgICAgICAgdmFyIHZhbHVlID0gYVtoZWFkQXJyW3N0YXRlLnNvcnRLZXldXTsgXHJcbiAgICAgICAgICAgIGlmKFIuaXMoU3RyaW5nLCB2YWx1ZSkpe1xyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBhZGRFbHModGFibGUsIGRhdGEuZmlsdGVyKG1ha2VGaWx0ZXJGdW5jKCkpLnNvcnQoc29ydEZ1bmMpLm1hcChkYXRhMnN0cikpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIG1ha2VGaWx0ZXJGdW5jID0gKCkgPT4ge1xyXG4gICAgICAgIHZhciB2YWx1ZXMgPSBxdWVyeUVscyhjYXRlZ29yeUNvbnRlbnRSb290ICsgXCJ0aGVhZCB0ciBpbnB1dFwiKS5tYXAoUi5wcm9wKCd2YWx1ZScpKTtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24oZGF0YSl7XHJcbiAgICAgICAgICAgIHJldHVybiBoZWFkQXJyLmV2ZXJ5KChlbCwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmKHZhbHVlc1tpbmRleF0udHJpbSgpID09PSAnJyl7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKGRhdGFbaGVhZEFycltpbmRleF1dKS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoU3RyaW5nKHZhbHVlc1tpbmRleF0pLnRvTG93ZXJDYXNlKCkpICE9IC0xO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgYWRkR2xvYmFsQXNzZXRUb0NhdGVnb3J5ID0gKCk9PntcclxuICAgICAgICB2YXIgYXNzZXQgPSBxdWVyeUVsKGNhdGVnb3J5Q29udGVudFJvb3QgKyBcIi5hZGQtZW50aXR5LXNlbGVjdC0xMVwiKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgdmFyIGNhdGVnb3J5ID0gcXVlcnlFbChjYXRlZ29yeUNvbnRlbnRSb290ICsgXCIuYWRkLWVudGl0eS1zZWxlY3QtMTJcIikudmFsdWUudHJpbSgpO1xyXG4gICAgICAgIERCTVMuYWRkR2xvYmFsQXNzZXRUb0NhdGVnb3J5KFNob3BNYW5hZ2VtZW50LmdldEN1cnJlbnRTaG9wTmFtZSgpLCBjYXRlZ29yeSwgYXNzZXQsIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcclxuICAgIH07XHJcbiAgICB2YXIgYWRkTG9jYWxBc3NldFRvQ2F0ZWdvcnkgPSAoKT0+e1xyXG4gICAgICAgIHZhciBhc3NldCA9IHF1ZXJ5RWwoY2F0ZWdvcnlDb250ZW50Um9vdCArIFwiLmFkZC1lbnRpdHktc2VsZWN0LTIxXCIpLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICB2YXIgY2F0ZWdvcnkgPSBxdWVyeUVsKGNhdGVnb3J5Q29udGVudFJvb3QgKyBcIi5hZGQtZW50aXR5LXNlbGVjdC0yMlwiKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgREJNUy5hZGRMb2NhbEFzc2V0VG9DYXRlZ29yeShTaG9wTWFuYWdlbWVudC5nZXRDdXJyZW50U2hvcE5hbWUoKSwgY2F0ZWdvcnksIGFzc2V0LCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICB9O1xyXG4gICAgdmFyIHJlbW92ZUdsb2JhbEFzc2V0RnJvbUNhdGVnb3J5ID0gKCk9PntcclxuICAgICAgICB2YXIgYXJyID0gSlNPTi5wYXJzZShxdWVyeUVsKGNhdGVnb3J5Q29udGVudFJvb3QgKyBcIi5yZW1vdmUtZW50aXR5LXNlbGVjdC0xXCIpLnZhbHVlLnRyaW0oKSk7XHJcbiAgICAgICAgREJNUy5yZW1vdmVHbG9iYWxBc3NldEZyb21DYXRlZ29yeShTaG9wTWFuYWdlbWVudC5nZXRDdXJyZW50U2hvcE5hbWUoKSwgYXJyWzBdLCBhcnJbMV0sIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcclxuICAgIH07XHJcbiAgICB2YXIgcmVtb3ZlTG9jYWxBc3NldEZyb21DYXRlZ29yeSA9ICgpPT57XHJcbiAgICAgICAgdmFyIGFyciA9IEpTT04ucGFyc2UocXVlcnlFbChjYXRlZ29yeUNvbnRlbnRSb290ICsgXCIucmVtb3ZlLWVudGl0eS1zZWxlY3QtMlwiKS52YWx1ZS50cmltKCkpO1xyXG4gICAgICAgIERCTVMucmVtb3ZlTG9jYWxBc3NldEZyb21DYXRlZ29yeShTaG9wTWFuYWdlbWVudC5nZXRDdXJyZW50U2hvcE5hbWUoKSwgYXJyWzBdLCBhcnJbMV0sIFV0aWxzLnByb2Nlc3NFcnJvcihleHBvcnRzLnJlZnJlc2gpKTtcclxuICAgIH07XHJcblxyXG59KSh0aGlzWydDYXRlZ29yeUNvbnRlbnRNYW5hZ2VtZW50J109e30pOyIsIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcblwidXNlIHN0cmljdFwiO1xyXG5cclxuKGZ1bmN0aW9uKGV4cG9ydHMpe1xyXG4gICAgXHJcbiAgICB2YXIgcm9vdCA9ICcuc2hvcC1hYm91dC10YWIgJztcclxuICAgIHZhciBzdGF0ZSA9IHt9O1xyXG4gICAgdmFyIGwxMG4gPSBMMTBuLmdldCgnc2hvcCcpO1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIGV4cG9ydHMuY29udGVudCA9IHF1ZXJ5RWwocm9vdCk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnRzLnJlZnJlc2ggPSBmdW5jdGlvbigpIHtcclxuICAgICAgICB2YXIgc2hvcE5hbWUgPSBTaG9wTWFuYWdlbWVudC5nZXRDdXJyZW50U2hvcE5hbWUoKTtcclxuICAgICAgICBEQk1TLmdldFNob3Aoc2hvcE5hbWUsIGZ1bmN0aW9uKGVyciwgc2hvcERhdGEpe1xyXG4gICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICB2YXIgYm9keSA9IGNsZWFyRWwocXVlcnlFbChyb290ICsgJy5zaG9wLWluZm8tdGFibGUtYm9keScpKTtcclxuICAgICAgICAgICAgdmFyIGVsMSA9IGFkZEVscyhtYWtlRWwoJ3RyJyksIFsgYWRkRWwobWFrZUVsKCd0ZCcpLCBhZGRFbChtYWtlRWwoJ3NwYW4nKSwgbWFrZVRleHQobDEwbignY29ycG9yYXRpb24tbmFtZScpKSkpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRFbChtYWtlRWwoJ3RkJyksIGFkZEVsKG1ha2VFbCgnc3BhbicpLCBtYWtlVGV4dChzaG9wRGF0YS5jb3Jwb3JhdGlvbikpKV0pXHJcbiAgICAgICAgICAgIHZhciBlbDIgPSBhZGRFbHMobWFrZUVsKCd0cicpLCBbIGFkZEVsKG1ha2VFbCgndGQnKSwgYWRkRWwobWFrZUVsKCdzcGFuJyksIG1ha2VUZXh0KGwxMG4oJ2xlZ2FsLWJvZHknKSkpKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkRWwobWFrZUVsKCd0ZCcpLCBhZGRFbChtYWtlRWwoJ3NwYW4nKSwgbWFrZVRleHQoc2hvcERhdGEuc2VsbGVyTG9naW4pKSldKVxyXG4gICAgICAgICAgICBhZGRFbHMoYm9keSwgW2VsMSwgZWwyXSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxufSkodGhpc1snU2hvcEFib3V0J109e30pOyIsIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcblwidXNlIHN0cmljdFwiO1xyXG5cclxudmFyIFNob3BNYW5hZ2VtZW50ID0ge307XHJcblxyXG52YXIgU2hvcE1hbmFnZW1lbnRUbXBsID0gKGZ1bmN0aW9uKGV4cG9ydHMsIGVuYWJsZVNob3BTZWxlY3QsIHNob3BTaG9wV2luZG93KXtcclxuICAgIFxyXG4gICAgdmFyIHJvb3QgPSAnLnNob3AtbWFuYWdlbWVudC10YWIgJztcclxuICAgIHZhciBjYXRlZ29yeVJvb3QgPSByb290ICsgJy5jYXRlZ29yeS1tYW5hZ2VtZW50ICc7XHJcbiAgICB2YXIgbG9jYWxBc3NldFJvb3QgPSByb290ICsgJy5sb2NhbC1hc3NldC1tYW5hZ2VtZW50ICc7XHJcbiAgICB2YXIgY2F0ZWdvcnlDb250ZW50Um9vdCA9IHJvb3QgKyAnLmNhdGVnb3J5LWNvbnRlbnQtbWFuYWdlbWVudCAnO1xyXG4gICAgdmFyIHN0YXRlID0ge307XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgc3RhdGUudmlld3MgPSB7fTtcclxuICAgICAgICB2YXIgbmF2ID0gcm9vdCArIFwiLnN1Yi10YWItbmF2aWdhdGlvblwiO1xyXG4gICAgICAgIHZhciBjb250ZW50ID0gcm9vdCArIFwiLnN1Yi10YWItY29udGVudFwiO1xyXG4gICAgICAgIHZhciBjb250YWluZXJzID0ge1xyXG4gICAgICAgICAgICByb290OiBzdGF0ZSxcclxuICAgICAgICAgICAgbmF2aWdhdGlvbjogcXVlcnlFbChuYXYpLFxyXG4gICAgICAgICAgICBjb250ZW50OiBxdWVyeUVsKGNvbnRlbnQpXHJcbiAgICAgICAgfTtcclxuICAgICAgICBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsIFwiY2F0ZWdvcnktY29udGVudC1tYW5hZ2VtZW50XCIsIENhdGVnb3J5Q29udGVudE1hbmFnZW1lbnQsIHttYWluUGFnZTp0cnVlfSk7XHJcbiAgICAgICAgVXRpbHMuYWRkVmlldyhjb250YWluZXJzLCBcImxvY2FsLWFzc2V0LXByb2ZpbGVcIiwgTG9jYWxBc3NldFByb2ZpbGUpO1xyXG4gICAgICAgIFV0aWxzLmFkZFZpZXcoY29udGFpbmVycywgXCJnbG9iYWwtYXNzZXQtcHJvZmlsZVwiLCBHbG9iYWxBc3NldFByb2ZpbGUpO1xyXG4gICAgICAgIGlmKHNob3BTaG9wV2luZG93KXtcclxuICAgICAgICAgICAgVXRpbHMuYWRkVmlldyhjb250YWluZXJzLCBcInNob3Atd2luZG93XCIsIFNob3BXaW5kb3cpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChjYXRlZ29yeVJvb3QgKyBcIi5jcmVhdGUtZW50aXR5LWJ1dHRvblwiKSxcImNsaWNrXCIsIGNyZWF0ZUNhdGVnb3J5KTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChjYXRlZ29yeVJvb3QgKyBcIi5yZW5hbWUtZW50aXR5LWJ1dHRvblwiKSxcImNsaWNrXCIsIHJlbmFtZUNhdGVnb3J5KTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChjYXRlZ29yeVJvb3QgKyBcIi5yZW1vdmUtZW50aXR5LWJ1dHRvblwiKSxcImNsaWNrXCIsIHJlbW92ZUNhdGVnb3J5KTtcclxuICAgICAgICBcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChsb2NhbEFzc2V0Um9vdCArIFwiLmNyZWF0ZS1lbnRpdHktYnV0dG9uXCIpLFwiY2xpY2tcIiwgY3JlYXRlTG9jYWxBc3NldCk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwobG9jYWxBc3NldFJvb3QgKyBcIi5yZW5hbWUtZW50aXR5LWJ1dHRvblwiKSxcImNsaWNrXCIsIHJlbmFtZUxvY2FsQXNzZXQpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKGxvY2FsQXNzZXRSb290ICsgXCIucmVtb3ZlLWVudGl0eS1idXR0b25cIiksXCJjbGlja1wiLCByZW1vdmVMb2NhbEFzc2V0KTtcclxuICAgICAgICBcclxuICAgICAgICBTaG9wTWFuYWdlbWVudC5nZXRDdXJyZW50U2hvcE5hbWUgPSAoKSA9PiBzdGF0ZS5zaG9wTmFtZTtcclxuICAgICAgICBcclxuICAgICAgICBpZihlbmFibGVTaG9wU2VsZWN0KXtcclxuICAgICAgICAgICAgJChyb290ICsgXCIuc2hvcC1zZWxlY3RcIikuc2VsZWN0MigpLm9uKFwiY2hhbmdlXCIsIGJ1aWxkQ29udGVudERlbGVnYXRlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMucmVmcmVzaCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIGlmKGVuYWJsZVNob3BTZWxlY3Qpe1xyXG4gICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwocm9vdCArIFwiLnNob3Atc2VsZWN0XCIpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdzaG9wJywgdHJ1ZSwgZnVuY3Rpb24oZXJyLCBlbnRpdHlOYW1lcyl7XHJcbiAgICAgICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IGdldFNlbGVjdDJEYXRhKGVudGl0eU5hbWVzKTtcclxuICAgICAgICAgICAgICAgIGlmKGVudGl0eU5hbWVzLmxlbmd0aCA+IDApe1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKHN0YXRlLnNob3BOYW1lICE9IHVuZGVmaW5lZCAmJiBSLmNvbnRhaW5zKHN0YXRlLnNob3BOYW1lLCBlbnRpdHlOYW1lcy5tYXAoUi5wcm9wKCd2YWx1ZScpKSkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkKHJvb3QgKyBcIi5zaG9wLXNlbGVjdFwiKS5zZWxlY3QyKGRhdGEpLnZhbChzdGF0ZS5zaG9wTmFtZSkudHJpZ2dlcignY2hhbmdlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJChyb290ICsgXCIuc2hvcC1zZWxlY3RcIikuc2VsZWN0MihkYXRhKS52YWwoZW50aXR5TmFtZXNbMF0udmFsdWUpLnRyaWdnZXIoJ2NoYW5nZScpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJChyb290ICsgXCIuc2hvcC1zZWxlY3RcIikuc2VsZWN0MihkYXRhKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgREJNUy5nZXRTaG9wTmFtZShmdW5jdGlvbihlcnIsIHNob3BOYW1lKXtcclxuICAgICAgICAgICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XHJcbiAgICAgICAgICAgICAgICBzdGF0ZS5zaG9wTmFtZSA9IHNob3BOYW1lO1xyXG4gICAgICAgICAgICAgICAgYnVpbGRDb250ZW50KHNob3BOYW1lKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIGJ1aWxkQ29udGVudERlbGVnYXRlID0gKGV2ZW50KSA9PiBidWlsZENvbnRlbnQoZXZlbnQudGFyZ2V0LnZhbHVlKTtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5nZXRDdXJyZW50U2hvcE5hbWUgPSAoKSA9PiBzdGF0ZS5zaG9wTmFtZTtcclxuICAgIFxyXG4gICAgdmFyIGJ1aWxkQ29udGVudCA9IChzaG9wTmFtZSkgPT4ge1xyXG4gICAgICAgIHN0YXRlLnNob3BOYW1lID0gc2hvcE5hbWU7XHJcbiAgICAgICAgREJNUy5nZXRTaG9wKHNob3BOYW1lLCBmdW5jdGlvbihlcnIsIHNob3BEYXRhKXtcclxuICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHZhciBkYXRhID0gYXJyMlNlbGVjdDIoUi5rZXlzKHNob3BEYXRhLmNhdGVnb3JpZXMpLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEEpKTtcclxuICAgICAgICAgICAgY2xlYXJFbChxdWVyeUVsKGNhdGVnb3J5Um9vdCArIFwiLnJlbmFtZS1lbnRpdHktc2VsZWN0XCIpKTtcclxuICAgICAgICAgICAgJChjYXRlZ29yeVJvb3QgKyBcIi5yZW5hbWUtZW50aXR5LXNlbGVjdFwiKS5zZWxlY3QyKGRhdGEpO1xyXG4gICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwoY2F0ZWdvcnlSb290ICsgXCIucmVtb3ZlLWVudGl0eS1zZWxlY3RcIikpO1xyXG4gICAgICAgICAgICAkKGNhdGVnb3J5Um9vdCArIFwiLnJlbW92ZS1lbnRpdHktc2VsZWN0XCIpLnNlbGVjdDIoZGF0YSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBkYXRhID0gYXJyMlNlbGVjdDIoUi5rZXlzKHNob3BEYXRhLmxvY2FsQXNzZXRzKS5zb3J0KENvbW1vblV0aWxzLmNoYXJPcmRBKSk7XHJcbiAgICAgICAgICAgIGNsZWFyRWwocXVlcnlFbChsb2NhbEFzc2V0Um9vdCArIFwiLnJlbmFtZS1lbnRpdHktc2VsZWN0XCIpKTtcclxuICAgICAgICAgICAgJChsb2NhbEFzc2V0Um9vdCArIFwiLnJlbmFtZS1lbnRpdHktc2VsZWN0XCIpLnNlbGVjdDIoZGF0YSk7XHJcbiAgICAgICAgICAgIGNsZWFyRWwocXVlcnlFbChsb2NhbEFzc2V0Um9vdCArIFwiLnJlbW92ZS1lbnRpdHktc2VsZWN0XCIpKTtcclxuICAgICAgICAgICAgJChsb2NhbEFzc2V0Um9vdCArIFwiLnJlbW92ZS1lbnRpdHktc2VsZWN0XCIpLnNlbGVjdDIoZGF0YSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBzdGF0ZS5jdXJyZW50Vmlldy5yZWZyZXNoKCk7XHJcbi8vICAgICAgICAgICAgREJNUy5nZXRTaG9wSW5kZXgoc2hvcE5hbWUsIGZ1bmN0aW9uKGVyciwgaW5kZXgpe1xyXG4vLyAgICAgICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4vLyAgICAgICAgICAgICAgICBhZGRFbChjbGVhckVsKHF1ZXJ5RWwocm9vdCArIFwiLnRoaXJkLXBhbmVsXCIpKSwgc2V0QXR0cihhZGRFbChtYWtlRWwoJ2gyJyksIG1ha2VUZXh0KGluZGV4KSksICdzdHlsZScsICd0ZXh0LWFsaWduOiBjZW50ZXI7JykpO1xyXG4vLyAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIGNyZWF0ZUNhdGVnb3J5ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBpbnB1dCA9IHF1ZXJ5RWwoY2F0ZWdvcnlSb290ICsgXCIuY3JlYXRlLWVudGl0eS1pbnB1dFwiKTtcclxuICAgICAgICBEQk1TLmNyZWF0ZUNhdGVnb3J5KHN0YXRlLnNob3BOYW1lLCBpbnB1dC52YWx1ZS50cmltKCksIFV0aWxzLnByb2Nlc3NFcnJvcihmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICBpbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICB9KSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgcmVuYW1lQ2F0ZWdvcnkgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIHRvSW5wdXQgPSBxdWVyeUVsKGNhdGVnb3J5Um9vdCArIFwiLnJlbmFtZS1lbnRpdHktaW5wdXRcIik7XHJcbiAgICAgICAgdmFyIGZyb21OYW1lID0gcXVlcnlFbChjYXRlZ29yeVJvb3QgKyBcIi5yZW5hbWUtZW50aXR5LXNlbGVjdFwiKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgdmFyIHRvTmFtZSA9IHRvSW5wdXQudmFsdWUudHJpbSgpO1xyXG4gICAgICAgIERCTVMucmVuYW1lQ2F0ZWdvcnkoc3RhdGUuc2hvcE5hbWUsIGZyb21OYW1lLCB0b05hbWUsIGZ1bmN0aW9uKGVycil7XHJcbiAgICAgICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XHJcbiAgICAgICAgICAgIHRvSW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgcmVtb3ZlQ2F0ZWdvcnkgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIG5hbWUgPSBxdWVyeUVsKGNhdGVnb3J5Um9vdCArIFwiLnJlbW92ZS1lbnRpdHktc2VsZWN0XCIpLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICBVdGlscy5jb25maXJtKHN0ckZvcm1hdChnZXRMMTBuKCdzaG9wLWNvbmZpcm0tY2F0ZWdvcnktcmVtb3ZlJyksIFtuYW1lXSksICgpID0+IHtcclxuICAgICAgICAgICAgREJNUy5yZW1vdmVDYXRlZ29yeShzdGF0ZS5zaG9wTmFtZSwgbmFtZSwgVXRpbHMucHJvY2Vzc0Vycm9yKGV4cG9ydHMucmVmcmVzaCkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIGNyZWF0ZUxvY2FsQXNzZXQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIGlucHV0ID0gcXVlcnlFbChsb2NhbEFzc2V0Um9vdCArIFwiLmNyZWF0ZS1lbnRpdHktaW5wdXRcIik7XHJcbiAgICAgICAgREJNUy5jcmVhdGVMb2NhbEFzc2V0KHN0YXRlLnNob3BOYW1lLCBpbnB1dC52YWx1ZS50cmltKCksIFV0aWxzLnByb2Nlc3NFcnJvcihmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICBpbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICB9KSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgcmVuYW1lTG9jYWxBc3NldCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgdG9JbnB1dCA9IHF1ZXJ5RWwobG9jYWxBc3NldFJvb3QgKyBcIi5yZW5hbWUtZW50aXR5LWlucHV0XCIpO1xyXG4gICAgICAgIHZhciBmcm9tTmFtZSA9IHF1ZXJ5RWwobG9jYWxBc3NldFJvb3QgKyBcIi5yZW5hbWUtZW50aXR5LXNlbGVjdFwiKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgdmFyIHRvTmFtZSA9IHRvSW5wdXQudmFsdWUudHJpbSgpO1xyXG4gICAgICAgIERCTVMucmVuYW1lTG9jYWxBc3NldChzdGF0ZS5zaG9wTmFtZSwgZnJvbU5hbWUsIHRvTmFtZSwgZnVuY3Rpb24oZXJyKXtcclxuICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgICAgICAgICAgdG9JbnB1dC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciByZW1vdmVMb2NhbEFzc2V0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBuYW1lID0gcXVlcnlFbChsb2NhbEFzc2V0Um9vdCArIFwiLnJlbW92ZS1lbnRpdHktc2VsZWN0XCIpLnZhbHVlLnRyaW0oKTtcclxuICAgICAgICBVdGlscy5jb25maXJtKHN0ckZvcm1hdChnZXRMMTBuKCdzaG9wLWNvbmZpcm0tbG9jYWwtYXNzZXQtcmVtb3ZlJyksIFtuYW1lXSksICgpID0+IHtcclxuICAgICAgICAgICAgREJNUy5yZW1vdmVMb2NhbEFzc2V0KHN0YXRlLnNob3BOYW1lLCBuYW1lLCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxufSk7XHJcblxyXG5TaG9wTWFuYWdlbWVudFRtcGwodGhpc1snTWFzdGVyU2hvcE1hbmFnZW1lbnQnXT17fSwgdHJ1ZSwgdHJ1ZSk7XHJcblxyXG5TaG9wTWFuYWdlbWVudFRtcGwodGhpc1snUGxheWVyU2hvcE1hbmFnZW1lbnQnXT17fSwgZmFsc2UsIGZhbHNlKTtcclxuXHJcbi8vKHRoaXNbJ1Nob3BNYW5hZ2VtZW50J109e30pOyIsIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcblwidXNlIHN0cmljdFwiO1xyXG5cclxuKGZ1bmN0aW9uKGV4cG9ydHMpe1xyXG4gICAgXHJcbiAgICB2YXIgcm9vdCA9ICcuc2hvcC1wYXNzd29yZHMtdGFiICc7XHJcbiAgICB2YXIgc3RhdGUgPSB7fTtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChyb290ICsgJy5zaG93LXBhc3N3b3Jkcy1idXR0b24nKSwgJ2NsaWNrJywgb25TaG93UGFzc3dvcmRzKTtcclxuICAgICAgICBcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgY2xlYXJFbChxdWVyeUVsKHJvb3QgKyAnLnNob3AtcGFzc3dvcmRzLXRhYmxlLWJvZHknKSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgb25TaG93UGFzc3dvcmRzID0gKCkgPT4ge1xyXG4gICAgICAgIERCTVMuZ2V0U2hvcFBhc3N3b3JkcyhmdW5jdGlvbihlcnIsIHNob3BQYXNzd29yZHMpe1xyXG4gICAgICAgICAgICBhZGRFbHMoY2xlYXJFbChxdWVyeUVsKHJvb3QgKyAnLnNob3AtcGFzc3dvcmRzLXRhYmxlLWJvZHknKSksIHNob3BQYXNzd29yZHMubWFwKG1ha2VQYXNzUm93KSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgbWFrZVBhc3NSb3cgPSAoZGF0YSkgPT4ge1xyXG4gICAgICAgIHJldHVybiBhZGRFbHMobWFrZUVsKCd0cicpLCBbYWRkRWwobWFrZUVsKCd0ZCcpLCBtYWtlVGV4dChkYXRhLm5hbWUpKSwgYWRkRWwobWFrZUVsKCd0ZCcpLCBtYWtlVGV4dChkYXRhLnBhc3N3b3JkKSldKTtcclxuICAgIH07XHJcblxyXG59KSh0aGlzWydTaG9wUGFzc3dvcmRzJ109e30pOyIsIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbi8qZ2xvYmFsXHJcbiBVdGlscywgREJNU1xyXG4gKi9cclxuXHJcblwidXNlIHN0cmljdFwiO1xyXG5cclxuKGZ1bmN0aW9uKGV4cG9ydHMpe1xyXG4gICAgXHJcbiAgICB2YXIgcm9vdCA9ICcuc2hvcC1wcm9maWxlLXRhYiAnO1xyXG4gICAgdmFyIHN0YXRlID0ge307XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwocm9vdCArICcuZW50aXR5LXNlbGVjdG9yJyksIFwiY2hhbmdlXCIsIG9uU2hvcFNlbGVjdCk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwocm9vdCArICcuY29ycC1uYW1lLWlucHV0JyksIFwiY2hhbmdlXCIsIG9uU2hvcERhdGFJbnB1dCgnLmNvcnAtbmFtZS1pbnB1dCcsICdjb3Jwb3JhdGlvbicpKTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChyb290ICsgJy5zZWxsZXItbG9naW4taW5wdXQnKSwgXCJjaGFuZ2VcIiwgb25TaG9wRGF0YUlucHV0KCcuc2VsbGVyLWxvZ2luLWlucHV0JywgJ3NlbGxlckxvZ2luJykpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKHJvb3QgKyAnLnNlbGxlci1wYXNzd29yZC1pbnB1dCcpLCBcImNoYW5nZVwiLCBvblNob3BEYXRhSW5wdXQoJy5zZWxsZXItcGFzc3dvcmQtaW5wdXQnLCAnc2VsbGVyUGFzc3dvcmQnKSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwocm9vdCArICcuY2hlY2stc2hvcC1idXR0b24nKSwgXCJjbGlja1wiLCBjaGVja1Nob3BDcmVkZW50aWFscyk7XHJcbiAgICAgICAgZXhwb3J0cy5jb250ZW50ID0gcXVlcnlFbChyb290KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydHMucmVmcmVzaCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdzaG9wJywgZmFsc2UsIGZ1bmN0aW9uKGVyciwgbmFtZXMpe1xyXG4gICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgdmFyIHNlbCA9IGNsZWFyRWwocXVlcnlFbChyb290ICsgXCIuZW50aXR5LXNlbGVjdG9yXCIpKTtcclxuICAgICAgICAgICAgZmlsbFNlbGVjdG9yKHNlbCwgbmFtZXMubWFwKHJlbWFwUHJvcHM0U2VsZWN0KSk7XHJcbiAgICAgICAgICAgIFxyXG4vLyAgICAgICAgICAgIGFwcGx5U2V0dGluZ3MoZ3JvdXBOYW1lcywgc2VsKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBvblNob3BTZWxlY3QgPSAoZXZlbnQpICA9PiB7XHJcbiAgICAgICAgdmFyIHNob3BOYW1lID0gZXZlbnQudGFyZ2V0LnNlbGVjdGVkT3B0aW9uc1swXS52YWx1ZTtcclxuICAgICAgICBjbGVhckVsKHF1ZXJ5RWwocm9vdCArIFwiLmNoZWNrLXNob3AtcmVzdWx0XCIpKTtcclxuICAgICAgICBEQk1TLmdldFNob3Aoc2hvcE5hbWUsIGZ1bmN0aW9uKGVyciwgc2hvcERhdGEpe1xyXG4gICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4gICAgICAgICAgICBxdWVyeUVsKHJvb3QgKyAnLmNvcnAtbmFtZS1pbnB1dCcpLnZhbHVlID0gc2hvcERhdGEuY29ycG9yYXRpb247XHJcbiAgICAgICAgICAgIHF1ZXJ5RWwocm9vdCArICcuc2VsbGVyLWxvZ2luLWlucHV0JykudmFsdWUgPSBzaG9wRGF0YS5zZWxsZXJMb2dpbjtcclxuICAgICAgICAgICAgcXVlcnlFbChyb290ICsgJy5zZWxsZXItcGFzc3dvcmQtaW5wdXQnKS52YWx1ZSA9IHNob3BEYXRhLnNlbGxlclBhc3N3b3JkO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIG9uU2hvcERhdGFJbnB1dCA9IChjbGF6eiwgdHlwZSkgID0+IHtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgdmFyIGlucHV0ID0gcXVlcnlFbChyb290ICsgY2xhenopO1xyXG4gICAgICAgICAgICB2YXIgdmFsdWUgPSBpbnB1dC52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgIHZhciBzaG9wU2VsZWN0b3IgPSBxdWVyeUVsKHJvb3QgKyBcIi5lbnRpdHktc2VsZWN0b3JcIik7XHJcbiAgICAgICAgICAgIGlmKHNob3BTZWxlY3Rvci5zZWxlY3RlZE9wdGlvbnMubGVuZ3RoID09PSAwKXtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KEwxMG4uZ2V0KCdzaG9wJywgJ3Nob3AtaXMtbm90LXNlbGVjdGVkJykpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBzaG9wTmFtZSA9IHNob3BTZWxlY3Rvci5zZWxlY3RlZE9wdGlvbnNbMF0udmFsdWU7XHJcbiAgICAgICAgICAgIERCTVMuc2V0U2hvcERhdGEoc2hvcE5hbWUsIHR5cGUsIHZhbHVlLCAgVXRpbHMucHJvY2Vzc0Vycm9yKGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICAgICBpbnB1dCA9ICcnO1xyXG4gICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIGNoZWNrU2hvcENyZWRlbnRpYWxzID0gKCkgPT4ge1xyXG4gICAgICAgIHZhciBvcHQgPSBxdWVyeUVsKHJvb3QgKyBcIi5lbnRpdHktc2VsZWN0b3JcIikuc2VsZWN0ZWRPcHRpb25zWzBdO1xyXG4gICAgICAgIGlmKG9wdCA9PT0gdW5kZWZpbmVkKXtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgc2hvcE5hbWUgPSBvcHQudmFsdWU7XHJcbiAgICAgICAgREJNUy5nZXRTaG9wQVBJQ2hlY2soc2hvcE5hbWUsIGZ1bmN0aW9uKGVyciwgcmVzKXtcclxuICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgICAgICAgICAgYWRkRWxzKGNsZWFyRWwocXVlcnlFbChyb290ICsgXCIuY2hlY2stc2hvcC1yZXN1bHRcIikpLCBbXHJcbiAgICAgICAgICAgICAgICBhZGRFbChtYWtlRWwoJ3NwYW4nKSwgbWFrZVRleHQocmVzLnN0YXR1c0NvZGUpICAgICAgICAgICAgICAgKSxcclxuICAgICAgICAgICAgICAgIGFkZEVsKG1ha2VFbCgnc3BhbicpLCBtYWtlVGV4dChMMTBuLmdldCgnYXBpLWNoZWNrJywgU3RyaW5nKHJlcy5zdGF0dXNDb2RlKSkpIClcclxuICAgICAgICAgICAgXSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICB9O1xyXG4gICAgXHJcblxyXG59KSh0aGlzWydTaG9wUHJvZmlsZSddPXt9KTsiLCIvKkNvcHlyaWdodCAyMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG5cInVzZSBzdHJpY3RcIjtcclxuXHJcbihmdW5jdGlvbihleHBvcnRzKXtcclxuXHJcbiAgICB2YXIgc3RhdGUgPSB7fTtcclxuICAgIHZhciByb290ID0gJy5zaG9wcy10YWIyICc7XHJcbiAgICB2YXIgY3VycmVudFNob3AgPSB1bmRlZmluZWQ7XHJcbiAgICBcclxuICAgIGV4cG9ydHMuaW5pdCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChyb290ICsgXCIuY3JlYXRlLXVzZXItYnV0dG9uXCIpLFwiY2xpY2tcIiwgY3JlYXRlU2hvcCk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwocm9vdCArIFwiLmNoYW5nZS1wYXNzd29yZC1idXR0b25cIiksXCJjbGlja1wiLCBjaGFuZ2VTaG9wUGFzc3dvcmQpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKHJvb3QgKyBcIi5yZW1vdmUtdXNlci1idXR0b25cIiksXCJjbGlja1wiLCByZW1vdmVTaG9wKTtcclxuICAgICAgICBzdGF0ZS52aWV3cyA9IHt9O1xyXG4gICAgICAgIHZhciBuYXYgPSByb290ICsgXCIuc3ViLXRhYi1uYXZpZ2F0aW9uXCI7XHJcbiAgICAgICAgdmFyIGNvbnRlbnQgPSByb290ICsgXCIuc3ViLXRhYi1jb250ZW50XCI7XHJcbiAgICAgICAgdmFyIGNvbnRhaW5lcnMgPSB7XHJcbiAgICAgICAgICAgIHJvb3Q6IHN0YXRlLFxyXG4gICAgICAgICAgICBuYXZpZ2F0aW9uOiBxdWVyeUVsKG5hdiksXHJcbiAgICAgICAgICAgIGNvbnRlbnQ6IHF1ZXJ5RWwoY29udGVudClcclxuICAgICAgICB9O1xyXG4gICAgICAgIFV0aWxzLmFkZFZpZXcoY29udGFpbmVycywgXCJzaG9wLXByb2ZpbGVcIiwgU2hvcFByb2ZpbGUse21haW5QYWdlOnRydWV9KTtcclxuICAgICAgICBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsIFwic2hvcC1wYXNzd29yZHNcIiwgU2hvcFBhc3N3b3Jkcyk7XHJcbi8vICAgICAgICBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsIFwic2hvcC12aWV3XCIsIFNob3BWaWV3KTtcclxuLy8gICAgICAgIFV0aWxzLmFkZFZpZXcoY29udGFpbmVycywgXCJzaG9wLWJpbmRpbmdcIiwgU2hvcEJpbmRpbmcpO1xyXG4vLyAgICBcclxuLy8gICAgICAgIGxpc3RlbihxdWVyeUVsKHJvb3QgKyBcIi5jcmVhdGUtZW50aXR5LWJ1dHRvblwiKSwgXCJjbGlja1wiLCBjcmVhdGVQcm9maWxlKCkpO1xyXG4vLyAgICAgICAgbGlzdGVuKHF1ZXJ5RWwocm9vdCArIFwiLnJlbmFtZS1lbnRpdHktYnV0dG9uXCIpLCBcImNsaWNrXCIsIHJlbmFtZVByb2ZpbGUoKSk7XHJcbi8vICAgICAgICBsaXN0ZW4ocXVlcnlFbChyb290ICsgXCIucmVtb3ZlLWVudGl0eS1idXR0b25cIiksIFwiY2xpY2tcIiwgcmVtb3ZlUHJvZmlsZSgpKTtcclxuLy8gICAgICAgIFxyXG4vLyAgICAgICAgJChcIiNzaG9wU2VsZWN0b3JcIikuc2VsZWN0MigpLm9uKFwiY2hhbmdlXCIsIG9uU2hvcFNlbGVjdG9yQ2hhbmdlRGVsZWdhdGUpO1xyXG5cclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5nZXRFbnRpdHlOYW1lc0FycmF5KCdzaG9wJywgdHJ1ZSwgZnVuY3Rpb24oZXJyLCBlbnRpdHlOYW1lcyl7XHJcbiAgICAgICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XHJcbiAgICAgICAgICAgIHJlYnVpbGRJbnRlcmZhY2UoZW50aXR5TmFtZXMpO1xyXG4gICAgICAgICAgICBzdGF0ZS5jdXJyZW50Vmlldy5yZWZyZXNoKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgcmVidWlsZEludGVyZmFjZSA9IGZ1bmN0aW9uIChuYW1lcykge1xyXG4gICAgICAgIHZhciBkYXRhID0gZ2V0U2VsZWN0MkRhdGEobmFtZXMpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNsZWFyRWwocXVlcnlFbChyb290ICsgXCIuY2hhbmdlLXBhc3N3b3JkLXVzZXItc2VsZWN0XCIpKTtcclxuICAgICAgICAkKHJvb3QgKyBcIi5jaGFuZ2UtcGFzc3dvcmQtdXNlci1zZWxlY3RcIikuc2VsZWN0MihkYXRhKTtcclxuICAgICAgICBcclxuICAgICAgICBjbGVhckVsKHF1ZXJ5RWwocm9vdCArIFwiLnJlbW92ZS11c2VyLXNlbGVjdFwiKSk7XHJcbiAgICAgICAgJChyb290ICsgXCIucmVtb3ZlLXVzZXItc2VsZWN0XCIpLnNlbGVjdDIoZGF0YSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgY3JlYXRlU2hvcCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgdXNlck5hbWVJbnB1dCA9IHF1ZXJ5RWwocm9vdCArIFwiLmNyZWF0ZS11c2VyLW5hbWUtaW5wdXRcIik7XHJcbiAgICAgICAgdmFyIHVzZXJQYXNzd29yZElucHV0ID0gcXVlcnlFbChyb290ICsgXCIuY3JlYXRlLXVzZXItcGFzc3dvcmQtaW5wdXRcIik7XHJcbiAgICAgICAgREJNUy5jcmVhdGVTaG9wKHVzZXJOYW1lSW5wdXQudmFsdWUudHJpbSgpLCB1c2VyUGFzc3dvcmRJbnB1dC52YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgIHVzZXJOYW1lSW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgdXNlclBhc3N3b3JkSW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgXHJcbiAgICB2YXIgY2hhbmdlU2hvcFBhc3N3b3JkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciB1c2VyTmFtZSA9IHF1ZXJ5RWwocm9vdCArIFwiLmNoYW5nZS1wYXNzd29yZC11c2VyLXNlbGVjdFwiKS52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgdmFyIHBhc3N3b3JkSW5wdXQgPSBxdWVyeUVsKHJvb3QgKyBcIi5jaGFuZ2UtcGFzc3dvcmQtcGFzc3dvcmQtaW5wdXRcIik7XHJcbiAgICAgICAgREJNUy5jaGFuZ2VTaG9wUGFzc3dvcmQodXNlck5hbWUsIHBhc3N3b3JkSW5wdXQudmFsdWUsIFV0aWxzLnByb2Nlc3NFcnJvcihmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICBxdWVyeUVsKHJvb3QgKyBcIi5jaGFuZ2UtcGFzc3dvcmQtcGFzc3dvcmQtaW5wdXRcIikudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIHJlbW92ZVNob3AgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIG5hbWUgPSBxdWVyeUVsKHJvb3QgKyBcIi5yZW1vdmUtdXNlci1zZWxlY3RcIikudmFsdWUudHJpbSgpO1xyXG4gICAgICAgIFV0aWxzLmNvbmZpcm0oc3RyRm9ybWF0KGdldEwxMG4oJ3Nob3AtY29uZmlybS1zaG9wLXJlbW92ZScpLCBbbmFtZV0pLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIERCTVMucmVtb3ZlU2hvcChuYW1lLCBVdGlscy5wcm9jZXNzRXJyb3IoZXhwb3J0cy5yZWZyZXNoKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbi8vICAgIGV4cG9ydHMuZ2V0Q3VycmVudFNob3AgPSAoKSA9PiBjdXJyZW50U2hvcDtcclxuICAgIFxyXG4vLyAgICB2YXIgb25TaG9wU2VsZWN0b3JDaGFuZ2VEZWxlZ2F0ZSA9IChldmVudCkgPT57XHJcbi8vICAgICAgICBjdXJyZW50U2hvcCA9IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuLy8gICAgICAgIHN0YXRlLmN1cnJlbnRWaWV3LnJlZnJlc2goKTtcclxuLy8vLyAgICAgICAgZXhwb3J0cy5yZWZyZXNoKCk7XHJcbi8vICAgIH07XHJcbiAgICBcclxuXHJcbi8vICAgIFxyXG4vLyAgICB2YXIgY3JlYXRlUHJvZmlsZSA9IGZ1bmN0aW9uICgpIHtcclxuLy8gICAgICAgIHJldHVybiBmdW5jdGlvbigpe1xyXG4vLyAgICAgICAgICAgIHZhciBpbnB1dCA9IHF1ZXJ5RWwocm9vdCArIFwiLmNyZWF0ZS1lbnRpdHktaW5wdXRcIik7XHJcbi8vICAgICAgICAgICAgdmFyIG5hbWUgPSBpbnB1dC52YWx1ZS50cmltKCk7XHJcbi8vICAgICAgICAgICAgXHJcbi8vICAgICAgICAgICAgREJNUy5jcmVhdGVTaG9wKG5hbWUsIGZ1bmN0aW9uKGVycil7XHJcbi8vICAgICAgICAgICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XHJcbi8vICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5yZWZyZXNoKGZ1bmN0aW9uKGVycil7XHJcbi8vICAgICAgICAgICAgICAgICAgICBpZihlcnIpIHtVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47fVxyXG4vLy8vICAgICAgICAgICAgICAgICAgICBpZihzdGF0ZS5jdXJyZW50Vmlldy51cGRhdGVTZXR0aW5ncyl7XHJcbi8vLy8gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5jdXJyZW50Vmlldy51cGRhdGVTZXR0aW5ncyhuYW1lKTtcclxuLy8vLyAgICAgICAgICAgICAgICAgICAgfVxyXG4vLyAgICAgICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSAnJztcclxuLy8gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4vLyAgICAgICAgICAgICAgICB9KTtcclxuLy8gICAgICAgICAgICB9KTtcclxuLy8gICAgICAgIH1cclxuLy8gICAgfTtcclxuLy8gICAgXHJcbi8vICAgIHZhciByZW5hbWVQcm9maWxlID0gZnVuY3Rpb24gKCkge1xyXG4vLyAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCl7XHJcbi8vICAgICAgICAgICAgdmFyIHRvSW5wdXQgPSBxdWVyeUVsKHJvb3QgKyBcIi5yZW5hbWUtZW50aXR5LWlucHV0XCIpO1xyXG4vLyAgICAgICAgICAgIHZhciBmcm9tTmFtZSA9IHF1ZXJ5RWwocm9vdCArIFwiLnJlbmFtZS1lbnRpdHktc2VsZWN0XCIpLnZhbHVlLnRyaW0oKTtcclxuLy8gICAgICAgICAgICB2YXIgdG9OYW1lID0gdG9JbnB1dC52YWx1ZS50cmltKCk7XHJcbi8vICAgICAgICBcclxuLy8gICAgICAgICAgICBEQk1TLnJlbmFtZVNob3AoZnJvbU5hbWUsIHRvTmFtZSwgZnVuY3Rpb24oZXJyKXtcclxuLy8gICAgICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuLy8gICAgICAgICAgICAgICAgUGVybWlzc2lvbkluZm9ybWVyLnJlZnJlc2goZnVuY3Rpb24oZXJyKXtcclxuLy8gICAgICAgICAgICAgICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XHJcbi8vICAgICAgICAgICAgICAgICAgICB0b0lucHV0LnZhbHVlID0gJyc7XHJcbi8vLy8gICAgICAgICAgICAgICAgICAgIGlmKHN0YXRlLmN1cnJlbnRWaWV3LnVwZGF0ZVNldHRpbmdzKXtcclxuLy8vLyAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmN1cnJlbnRWaWV3LnVwZGF0ZVNldHRpbmdzKHR5cGUsIHRvTmFtZSk7XHJcbi8vLy8gICAgICAgICAgICAgICAgICAgIH1cclxuLy8gICAgICAgICAgICAgICAgICAgIGV4cG9ydHMucmVmcmVzaCgpO1xyXG4vLyAgICAgICAgICAgICAgICB9KTtcclxuLy8gICAgICAgICAgICB9KTtcclxuLy8gICAgICAgIH1cclxuLy8gICAgfTtcclxuLy8gICAgXHJcbi8vICAgIHZhciByZW1vdmVQcm9maWxlID0gZnVuY3Rpb24gKCkge1xyXG4vLyAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCl7XHJcbi8vICAgICAgICAgICAgdmFyIG5hbWUgPSBxdWVyeUVsKHJvb3QgKyBcIi5yZW1vdmUtZW50aXR5LXNlbGVjdFwiKS52YWx1ZS50cmltKCk7XHJcbi8vICAgICAgICBcclxuLy8gICAgICAgICAgICBVdGlscy5jb25maXJtKHN0ckZvcm1hdChnZXRMMTBuKFwicHJvZmlsZXMtYXJlLXlvdS1zdXJlLWFib3V0LWNoYXJhY3Rlci1yZW1vdmluZ1wiKSxbbmFtZV0pLCAoKSA9PiB7XHJcbi8vICAgICAgICAgICAgICAgIERCTVMucmVtb3ZlU2hvcChuYW1lLCBmdW5jdGlvbihlcnIpe1xyXG4vLyAgICAgICAgICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuLy8gICAgICAgICAgICAgICAgICAgIFBlcm1pc3Npb25JbmZvcm1lci5yZWZyZXNoKGZ1bmN0aW9uKGVycil7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuLy8gICAgICAgICAgICAgICAgICAgICAgICBleHBvcnRzLnJlZnJlc2goKTtcclxuLy8gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4vLyAgICAgICAgICAgICAgICB9KTtcclxuLy8gICAgICAgICAgICB9KTtcclxuLy8gICAgICAgIH1cclxuLy8gICAgfTtcclxuXHJcbn0pKHRoaXNbJ1Nob3BzMiddPXt9KTsiLCIvKkNvcHlyaWdodCAyMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG5cInVzZSBzdHJpY3RcIjtcclxuXHJcbihmdW5jdGlvbihleHBvcnRzKXtcclxuICAgIFxyXG4gICAgdmFyIHJvb3QgPSAnLnNob3Atd2luZG93LXRhYiAnO1xyXG4gICAgdmFyIHN0YXRlID0ge307XHJcbiAgICB2YXIgbDEwbiA9IEwxMG4uZ2V0KCdzaG9wJyk7XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gZnVuY3Rpb24oKSB7XHJcbi8vICAgICAgICBsaXN0ZW4ocXVlcnlFbChyb290ICsgJy5yZWZyZXNoQnV0dG9uJyksICdjbGljaycsIGV4cG9ydHMucmVmcmVzaCk7XHJcbi8vICAgICAgICBxdWVyeUVscyhyb290ICsgJy5kaXNjb3VudC1idXR0b24nKS5tYXAobGlzdGVuKFIuX18sICdjbGljaycsIChldmVudCk9PntcclxuLy8vLyAgICAgICAgICAgIHN0YXRlLmRpc2NvdW50ID0gTnVtYmVyKGdldEF0dHIoZXZlbnQudGFyZ2V0LCAndmFsdWUnKSk7XHJcbi8vICAgICAgICAgICAgdXBkYXRlRmluYWxDb3N0KCk7XHJcbi8vICAgICAgICB9KSk7XHJcbiAgICAgICAgY2hlY2tGb3JRUigpO1xyXG4gICAgICAgIGxpc3RlbihxdWVyeUVsKHJvb3QgKyBcIi5hbW91bnQtaW5wdXRcIiksICdjaGFuZ2UnLCBvbkFtb3VudENoYW5nZSk7XHJcbiAgICAgICAgbGlzdGVuKHF1ZXJ5RWwocm9vdCArIFwiLmJ1eS1idXR0b25cIiksICdjbGljaycsIG9uQnV5KTtcclxuICAgICAgICBsaXN0ZW4ocXVlcnlFbChyb290ICsgXCIuc3RhcnQtcXItcmVhZFwiKSwgJ2NsaWNrJywgcmVhZFFSKTtcclxuICAgICAgICBcclxuICAgICAgICBleHBvcnRzLmNvbnRlbnQgPSBxdWVyeUVsKHJvb3QpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgZXhwb3J0cy5yZWZyZXNoID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgdmFyIHNob3BOYW1lID0gU2hvcE1hbmFnZW1lbnQuZ2V0Q3VycmVudFNob3BOYW1lKCk7XHJcbiAgICAgICAgREJNUy5nZXRTaG9wKHNob3BOYW1lLCBmdW5jdGlvbihlcnIsIHNob3BEYXRhKXtcclxuICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgICAgICAgICAgc3RhdGUuc2hvcERhdGEgPSBzaG9wRGF0YTtcclxuICAgICAgICAgICAgdmFyIGNhdGVnb3J5TGlzdCAgPSBSLmtleXMoc3RhdGUuc2hvcERhdGEuY2F0ZWdvcmllcykuc29ydChDb21tb25VdGlscy5jaGFyT3JkQSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB2YXIgY2F0U2VsZWN0ID0gY2xlYXJFbChxdWVyeUVsKHJvb3QgKyBcIi5jYXRlZ29yeS1zZWxlY3RcIikpO1xyXG4gICAgICAgICAgICBjbGVhckVsKHF1ZXJ5RWwocm9vdCArIFwiLmFzc2V0LXNlbGVjdFwiKSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgdmFyIGNhdEJ0bnMgPSBjYXRlZ29yeUxpc3QubWFwKCBuYW1lID0+IHtcclxuICAgICAgICAgICAgICAgIHZhciBidG4gPSBhZGRFbChtYWtlRWwoJ2J1dHRvbicpLCBtYWtlVGV4dChuYW1lKSk7XHJcbiAgICAgICAgICAgICAgICBhZGRDbGFzcyhidG4sICdzZWxlY3QtYnV0dG9uJyk7XHJcbiAgICAgICAgICAgICAgICBidG4uY2F0TmFtZSA9IG5hbWU7XHJcbiAgICAgICAgICAgICAgICBsaXN0ZW4oYnRuLCBcImNsaWNrXCIsIG9uQ2F0ZWdvcnlTZWxlY3QpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGJ0bjtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGFkZEVscyhjYXRTZWxlY3QsIGNhdEJ0bnMpO1xyXG4gICAgICAgICAgICBpZihjYXRCdG5zLmxlbmd0aCA+IDApIG9uQ2F0ZWdvcnlTZWxlY3Qoe3RhcmdldDpjYXRCdG5zWzBdfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciBtYWtlQnRuID0gUi5jdXJyeSgoY2F0TmFtZSwgZWwpID0+IHtcclxuICAgICAgICB2YXIgYnRuID0gYWRkRWwobWFrZUVsKCdidXR0b24nKSwgbWFrZVRleHQoZWwuZGlzcE5hbWUpKTtcclxuICAgICAgICBhZGRDbGFzcyhidG4sICdzZWxlY3QtYnV0dG9uJyk7XHJcbiAgICAgICAgYnRuLm5hbWUgPSBlbC5uYW1lO1xyXG4gICAgICAgIGJ0bi5jYXROYW1lID0gY2F0TmFtZTtcclxuICAgICAgICBidG4uYXNzZXRUeXBlID0gZWwudHlwZTtcclxuICAgICAgICBsaXN0ZW4oYnRuLCBcImNsaWNrXCIsIG9uQXNzZXRTZWxlY3QpO1xyXG4gICAgICAgIHJldHVybiBidG47XHJcbiAgICB9KTtcclxuICAgIFxyXG4gICAgdmFyIG9uQ2F0ZWdvcnlTZWxlY3QgPSAoZXZlbnQpID0+IHtcclxuICAgICAgICBxdWVyeUVscyhyb290ICsgXCIuY2F0ZWdvcnktc2VsZWN0ID4gYnV0dG9uXCIpLm1hcChyZW1vdmVDbGFzcyhSLl9fLCAnYWN0aXZlJykpO1xyXG4gICAgICAgIGFkZENsYXNzKGV2ZW50LnRhcmdldCwgJ2FjdGl2ZScpO1xyXG4gICAgICAgIHZhciBjYXROYW1lID0gZXZlbnQudGFyZ2V0LmNhdE5hbWU7XHJcbiAgICAgICAgdmFyIGNhdGVnb3J5ID0gc3RhdGUuc2hvcERhdGEuY2F0ZWdvcmllc1tjYXROYW1lXTtcclxuICAgICAgICBcclxuICAgICAgICBjbGVhckVsKHF1ZXJ5RWwocm9vdCArIFwiLmFzc2V0LWluZm9cIikpO1xyXG4gICAgICAgIGFkZENsYXNzKHF1ZXJ5RWwocm9vdCArIFwiLmJ1eS1jb250cm9sc1wiKSwgJ2hpZGRlbicpO1xyXG4gICAgICAgIHZhciBhc3NldFNlbGVjdCA9IGNsZWFyRWwocXVlcnlFbChyb290ICsgXCIuYXNzZXQtc2VsZWN0XCIpKTtcclxuICAgICAgICBcclxuICAgICAgICB2YXIgYXJyID0gUi5rZXlzKGNhdGVnb3J5Lmdsb2JhbHMpLm1hcChSLnBhaXIoUi5fXywgJ2dsb2JhbCcpKTtcclxuICAgICAgICBhcnIgPSBSLmNvbmNhdChhcnIsIFIua2V5cyhjYXRlZ29yeS5sb2NhbHMpLm1hcChSLnBhaXIoUi5fXywgJ2xvY2FsJykpKTtcclxuXHJcbiAgICAgICAgREJNUy5nZXRHbG9iYWxBc3NldERpc3BsYXlOYW1lcyggKGVyciwgZ2xvYmFsRGlzcGxheU5hbWVzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmKGVycikge1V0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjt9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBhcnIgPSBhcnIubWFwKGVsID0+IHtcclxuICAgICAgICAgICAgICAgIGlmKGVsWzFdID09PSAnZ2xvYmFsJyl7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGRpc3BOYW1lID0gZ2xvYmFsRGlzcGxheU5hbWVzW2VsWzBdXS5kaXNwbGF5U3RyaW5nO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZGlzcE5hbWUgPSBzdGF0ZS5zaG9wRGF0YS5sb2NhbEFzc2V0c1tlbFswXV0uZGlzcGxheVN0cmluZztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogZWxbMF0sXHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogZWxbMV0sXHJcbiAgICAgICAgICAgICAgICAgICAgZGlzcE5hbWU6IGRpc3BOYW1lLnRyaW0oKSA9PT0gJycgPyBlbFswXSA6IGRpc3BOYW1lXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pLnNvcnQoQ29tbW9uVXRpbHMuY2hhck9yZEFGYWN0b3J5KFIucHJvcCgnZGlzcE5hbWUnKSkpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgYWRkRWxzKGFzc2V0U2VsZWN0LCBhcnIubWFwKG1ha2VCdG4oY2F0TmFtZSkpKVxyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgdmFyIG9uQXNzZXRTZWxlY3QgPSAoZXZlbnQpID0+IHtcclxuICAgICAgICBxdWVyeUVscyhyb290ICsgXCIuYXNzZXQtc2VsZWN0ID4gYnV0dG9uXCIpLm1hcChyZW1vdmVDbGFzcyhSLl9fLCAnYWN0aXZlJykpO1xyXG4gICAgICAgIGFkZENsYXNzKGV2ZW50LnRhcmdldCwgJ2FjdGl2ZScpO1xyXG4gICAgICAgIHJlbW92ZUNsYXNzKHF1ZXJ5RWwocm9vdCArIFwiLmJ1eS1jb250cm9sc1wiKSwgJ2hpZGRlbicpO1xyXG4gICAgICAgIHF1ZXJ5RWwoJy5jdXN0b21lci1sb2dpbicpLnZhbHVlID0gJyc7XHJcbiAgICAgICAgcXVlcnlFbCgnLmN1c3RvbWVyLXBhc3N3b3JkJykudmFsdWUgPSAnJztcclxuICAgICAgICBzdGF0ZS5jdXJBc3NldCA9IHtcclxuICAgICAgICAgICAgbmFtZSA6IGV2ZW50LnRhcmdldC5uYW1lICxcclxuICAgICAgICAgICAgY2F0TmFtZSA6IGV2ZW50LnRhcmdldC5jYXROYW1lICxcclxuICAgICAgICAgICAgYXNzZXRUeXBlIDogZXZlbnQudGFyZ2V0LmFzc2V0VHlwZSBcclxuICAgICAgICB9O1xyXG4gICAgICAgIHNob3dBc3NldEluZm8oKTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBzaG93QXNzZXRJbmZvID0gKCkgPT4ge1xyXG4gICAgICAgIHZhciBzZXQgPSBzdGF0ZS5jdXJBc3NldC5hc3NldFR5cGUgPT09ICdsb2NhbCcgPyAnbG9jYWxzJyA6ICdnbG9iYWxzJztcclxuICAgICAgICB2YXIgY29zdCA9IHN0YXRlLnNob3BEYXRhLmNhdGVnb3JpZXNbc3RhdGUuY3VyQXNzZXQuY2F0TmFtZV1bc2V0XVtzdGF0ZS5jdXJBc3NldC5uYW1lXS5jb3N0O1xyXG4gICAgICAgIHN0YXRlLmNvc3QgPSBjb3N0O1xyXG4gICAgICAgIHF1ZXJ5RWwocm9vdCArIFwiLmZpbmFsLWNvc3QtaW5wdXRcIikudmFsdWUgPSBjb3N0O1xyXG4vLyAgICAgICAgc3RhdGUuZGlzY291bnQgPSAwO1xyXG4gICAgICAgIGlmKHN0YXRlLmN1ckFzc2V0LmFzc2V0VHlwZSA9PT0gJ2xvY2FsJyl7XHJcbiAgICAgICAgICAgIHN0YXRlLmFzc2V0RGF0YSA9IHN0YXRlLnNob3BEYXRhLmxvY2FsQXNzZXRzW3N0YXRlLmN1ckFzc2V0Lm5hbWVdO1xyXG4gICAgICAgICAgICByZW5kZXJBc3NldEluZm8oKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBEQk1TLmdldEFzc2V0KHN0YXRlLmN1ckFzc2V0Lm5hbWUsIChlcnIsIGFzc2V0RGF0YSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgICAgICAgICAgICAgIHN0YXRlLmFzc2V0RGF0YSA9IGFzc2V0RGF0YTtcclxuICAgICAgICAgICAgICAgIHJlbmRlckFzc2V0SW5mbygpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgcmVuZGVyQXNzZXRJbmZvID0gKCkgPT4ge1xyXG4gICAgICAgIHZhciBpbmZvID0gY2xlYXJFbChxdWVyeUVsKHJvb3QgKyBcIi5hc3NldC1pbmZvXCIpKTtcclxuICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSBzdGF0ZS5hc3NldERhdGEuZGlzcGxheVN0cmluZy50cmltKCkgIT09ICcnID8gc3RhdGUuYXNzZXREYXRhLmRpc3BsYXlTdHJpbmcgOiBzdGF0ZS5jdXJBc3NldC5uYW1lO1xyXG4gICAgICAgIGFkZEVsKGluZm8sIGFkZEVsKG1ha2VFbCgnaDInKSwgbWFrZVRleHQoZGlzcGxheU5hbWUpKSk7XHJcbiAgICAgICAgYWRkRWwoaW5mbywgYWRkRWwobWFrZUVsKCdzcGFuJyksIG1ha2VUZXh0KHN0YXRlLmFzc2V0RGF0YS5kZXNjcmlwdGlvbikpKTtcclxuICAgICAgICBhZGRFbChjbGVhckVsKHF1ZXJ5RWwocm9vdCArIFwiLmluaXRpYWwtY29zdC12YWx1ZVwiKSksIG1ha2VUZXh0KHN0YXRlLmNvc3QpKTtcclxuXHJcbiAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihxdWVyeUVsKHJvb3QgKyBcIi5hY3RpdmF0aW9uLWNvZGVzLWNvbnRhaW5lclwiKSwgJ2hpZGRlbicsICFzdGF0ZS5hc3NldERhdGEuaXNQaHlzaWNhbCk7XHJcbiAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihxdWVyeUVsKHJvb3QgKyBcIi5xci1yZWFkZXJcIiksICdoaWRkZW4nLCAhKHN0YXRlLmFzc2V0RGF0YS5pc1BoeXNpY2FsICYmIHN0YXRlLmlzQ2FudmFzT2spKTtcclxuICAgICAgICB2YXIgYW1vdW50ID0gY2xlYXJFbChxdWVyeUVsKHJvb3QgKyBcIi5hbW91bnQtaW5wdXRcIikpO1xyXG4gICAgICAgIGFtb3VudC52YWx1ZSA9IDE7XHJcbiAgICAgICAgaWYoc3RhdGUuYXNzZXREYXRhLmlzUGh5c2ljYWwpe1xyXG4gICAgICAgICAgICBkZWxBdHRyKGFtb3VudCwgJ2Rpc2FibGVkJyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgc2V0QXR0cihhbW91bnQsICdkaXNhYmxlZCcsICdkaXNhYmxlZCcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBvbkFtb3VudENoYW5nZSh7dGFyZ2V0OiBhbW91bnR9KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBvbkFtb3VudENoYW5nZSA9IChldmVudCkgPT4ge1xyXG4gICAgICAgIHZhciBudW0gPSBOdW1iZXIoZXZlbnQudGFyZ2V0LnZhbHVlKTtcclxuICAgICAgICB2YXIgZWwgPSBjbGVhckVsKHF1ZXJ5RWwocm9vdCArIFwiLmFjdGl2YXRpb24tY29kZXNcIikpO1xyXG4gICAgICAgIGlmKG51bSA8IDEpIG51bSA9IDE7XHJcbiAgICAgICAgaWYobnVtID4gMTApIG51bSA9IDEwO1xyXG4gICAgICAgIGFkZEVscyhlbCwgUi5yZXBlYXQoMSwgbnVtKS5tYXAodmFsID0+IHtcclxuLy8gICAgICAgICAgICByZXR1cm4gc2V0QXR0cihtYWtlRWwoJ2lucHV0JyksICd0eXBlJywgJ251bWJlcicpO1xyXG4gICAgICAgICAgICByZXR1cm4gYWRkQ2xhc3NlcyhtYWtlRWwoJ2lucHV0JyksIFsnZm9ybS1jb250cm9sJywncXItY29kZS1pbnB1dCddKTtcclxuICAgICAgICB9KSk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgb25CdXkgPSAoKSA9PiB7XHJcbiAgICAgICAgdmFyIHNob3BOYW1lID0gU2hvcE1hbmFnZW1lbnQuZ2V0Q3VycmVudFNob3BOYW1lKCk7XHJcbiAgICAgICAgdmFyIGNvc3QgPSBOdW1iZXIocXVlcnlFbChyb290ICsgXCIuZmluYWwtY29zdC1pbnB1dFwiKS52YWx1ZSk7XHJcbiAgICAgICAgdmFyIGN1c3RvbWVyTG9naW4gPSBxdWVyeUVsKCcuY3VzdG9tZXItbG9naW4nKS52YWx1ZTtcclxuICAgICAgICB2YXIgY3VzdG9tZXJQYXNzd29yZCA9IHF1ZXJ5RWwoJy5jdXN0b21lci1wYXNzd29yZCcpLnZhbHVlO1xyXG4gICAgICAgIHZhciBvcHRzID0ge1xyXG4gICAgICAgICAgICBhbW91bnQ6IE51bWJlcihxdWVyeUVsKHJvb3QgKyBcIi5hbW91bnQtaW5wdXRcIikudmFsdWUpXHJcbiAgICAgICAgfTtcclxuICAgICAgICBpZihzdGF0ZS5hc3NldERhdGEuaXNQaHlzaWNhbCl7XHJcbiAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBxdWVyeUVscyhyb290ICsgXCIuYWN0aXZhdGlvbi1jb2RlcyBpbnB1dFwiKS5tYXAoUi5jb21wb3NlKFIudHJpbSwgUi5wcm9wKCd2YWx1ZScpKSk7XHJcbiAgICAgICAgICAgIGlmKHZhbHVlcy5zb21lKFIuaXNFbXB0eSkpe1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuYWxlcnQobDEwbignbm90LWFsbC1hY3RpdmF0aW9uLWNvZGVzLWFyZS1mdWxsJykpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIG9wdHMuY29kZXMgPSB2YWx1ZXM7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIERCTVMuYnV5QXNzZXQoc2hvcE5hbWUsIHN0YXRlLmN1ckFzc2V0Lm5hbWUsIHN0YXRlLmN1ckFzc2V0LmFzc2V0VHlwZSwgY29zdCwgY3VzdG9tZXJMb2dpbiwgY3VzdG9tZXJQYXNzd29yZCwgb3B0cywgZnVuY3Rpb24oZXJyKXtcclxuICAgICAgICAgICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgICAgICAgICAgcXVlcnlFbCgnLmN1c3RvbWVyLWxvZ2luJykudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgcXVlcnlFbCgnLmN1c3RvbWVyLXBhc3N3b3JkJykudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgVXRpbHMuYWxlcnQobDEwbignb24tcHVyY2hhc2Utc3VjY2VzcycpKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciBjaGVja0ZvclFSID0gKCkgPT4ge1xyXG4gICAgICAgIGZ1bmN0aW9uIGlzQ2FudmFzU3VwcG9ydGVkKCl7XHJcbiAgICAgICAgICB2YXIgZWxlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xyXG4gICAgICAgICAgcmV0dXJuICEhKGVsZW0uZ2V0Q29udGV4dCAmJiBlbGVtLmdldENvbnRleHQoJzJkJykpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBzdGF0ZS5pc0NhbnZhc09rID0gaXNDYW52YXNTdXBwb3J0ZWQoKSAmJiB3aW5kb3cuRmlsZSAmJiB3aW5kb3cuRmlsZVJlYWRlcjtcclxuICAgIH07XHJcbiAgICBcclxuICAgIHZhciByZWFkUVIgPSAoKSA9PiB7XHJcbiAgICAgICAgcXJjb2RlLmNhbGxiYWNrID0gcmVhZDtcclxuICAgICAgICBxcmNvZGUuY3VzdG9tQ2FudmFzID0gcXVlcnlFbChyb290ICsgXCIucXItY2FudmFzXCIpO1xyXG4gICAgICAgIHZhciB2aWRlbyA9IHNldEF0dHIobWFrZUVsKCd2aWRlbycpLCAnYXV0b3BsYXknLCdhdXRvcGxheScpO1xyXG4gICAgICAgIGFkZEVsKGNsZWFyRWwocXVlcnlFbChyb290ICsgXCIudmlkZW9cIikpLCB2aWRlbyk7XHJcbiAgICAgICAgcXJjb2RlLnNldFdlYmNhbSh2aWRlbyk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICB2YXIgcmVhZCA9IChhKSA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ3JlYWQgY2FsbGVkJyk7XHJcbiAgICAgICAgY29uc29sZS5sb2coYSk7XHJcbiAgICAgICAgcXVlcnlFbChyb290ICsgXCIudmlkZW8gdmlkZW9cIikucGF1c2UoKTtcclxuICAgICAgICBjbGVhckVsKHF1ZXJ5RWwocm9vdCArIFwiLnZpZGVvXCIpKTtcclxuICAgICAgICBcclxuICAgICAgICB2YXIgcmVxdWVzdCA9ICQuYWpheCh7XHJcbi8vICAgICAgICAgICAgdXJsIDogJ2h0dHA6Ly9kZXYuYWxpY2UuZGlnaXRhbDo4MTU5L2RlY29kZT9jb250ZW50PScgKyBhLFxyXG4gICAgICAgICAgICB1cmwgOiAnaHR0cHM6Ly9hbGljZS5kaWdpdGFsL2FwcC9xci9kZWNvZGU/Y29udGVudD0nICsgYSxcclxuICAgICAgICAgICAgZGF0YVR5cGUgOiBcInRleHRcIixcclxuICAgICAgICAgICAgbWV0aG9kIDogXCJHRVRcIixcclxuICAgICAgICAgICAgY29udGVudFR5cGUgOiBcImFwcGxpY2F0aW9uL2pzb247Y2hhcnNldD11dGYtOFwiLFxyXG4gICAgICAgICAgICBjYWNoZTogZmFsc2UsXHJcbiAgICAgICAgICAgIHRpbWVvdXQ6IENvbnN0YW50cy5odHRwVGltZW91dCxcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICByZXF1ZXN0LmRvbmUoZnVuY3Rpb24oZGF0YSkge1xyXG4gICAgICAgICAgICBkYXRhID0gSlNPTi5wYXJzZShkYXRhKTtcclxuICAgICAgICAgICAgdmFyIGxlbmd0aCA9IGRhdGEucGF5bG9hZC5sZW5ndGg7XHJcbiAgICAgICAgICAgIHZhciBwYXlsb2FkID0gZGF0YS5wYXlsb2FkLnN1YnN0cmluZyhsZW5ndGgtNiwgbGVuZ3RoKTtcclxuICAgICAgICAgICAgdmFyIHZhbHVlcyA9IHF1ZXJ5RWxzKHJvb3QgKyBcIi5hY3RpdmF0aW9uLWNvZGVzIGlucHV0XCIpLm1hcChSLmNvbXBvc2UoUi50cmltLCBSLnByb3AoJ3ZhbHVlJykpKTtcclxuICAgICAgICAgICAgaWYoUi5jb250YWlucyhwYXlsb2FkLCB2YWx1ZXMpKXtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGwxMG4oJ3RoaXMtcXItY29kZS1hbHJlYWR5LXVzZWQtaW4taW5wdXRzJykpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBpbnB1dHMgPSBxdWVyeUVscyhyb290ICsgXCIuYWN0aXZhdGlvbi1jb2RlcyBpbnB1dFwiKS5maWx0ZXIoUi5jb21wb3NlKFIuaXNFbXB0eSwgUi50cmltLCBSLnByb3AoJ3ZhbHVlJykpKTtcclxuICAgICAgICAgICAgaWYoaW5wdXRzLmxlbmd0aCA+IDApe1xyXG4gICAgICAgICAgICAgICAgaW5wdXRzWzBdLnZhbHVlID0gZGF0YS5wYXlsb2FkLnN1YnN0cmluZyhsZW5ndGgtNiwgbGVuZ3RoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGwxMG4oJ2FsbC1hY3RpdmF0aW9uLWNvZGVzLWFyZS1mdWxsJykpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmVxdWVzdC5mYWlsKGZ1bmN0aW9uKGVycm9ySW5mbywgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHtcclxuICAgICAgICAgICAgVXRpbHMuYWxlcnQoZXJyb3JJbmZvLnJlc3BvbnNlVGV4dCB8fCB0ZXh0U3RhdHVzIHx8ICdlcnJvcicpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuICAgIFxyXG5cclxufSkodGhpc1snU2hvcFdpbmRvdyddPXt9KTsiLCIvKkNvcHlyaWdodCAyMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG5cInVzZSBzdHJpY3RcIjtcclxuXHJcbnZhciBBYm91dCA9IHt9O1xyXG5cclxuQWJvdXQuaW5pdCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG4gICAgQWJvdXQuY29udGVudCA9IGdldEVsKCdhYm91dERpdicpO1xyXG59O1xyXG5cclxuQWJvdXQucmVmcmVzaCA9IGZ1bmN0aW9uKCkge1xyXG59O1xyXG4iLCIvKkNvcHlyaWdodCAyMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gVXRpbHMsIERCTVNcclxuICovXHJcblxyXG5cInVzZSBzdHJpY3RcIjtcclxuXHJcbnZhciBMb2dWaWV3ZXIgPSB7fTtcclxuXHJcbkxvZ1ZpZXdlci5pbml0ID0gZnVuY3Rpb24oKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuICAgIGxpc3RlbihnZXRFbCgnbG9nUGFnZVNlbGVjdG9yJyksICdjaGFuZ2UnLCBmdW5jdGlvbihldmVudCl7XHJcbiAgICAgICAgREJNUy5nZXRMb2coTnVtYmVyKGV2ZW50LnRhcmdldC52YWx1ZSksIExvZ1ZpZXdlci5kYXRhUmVjaWV2ZWQpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgTG9nVmlld2VyLmNvbnRlbnQgPSBnZXRFbCgnbG9nVmlld2VyRGl2Jyk7XHJcbn07XHJcblxyXG5Mb2dWaWV3ZXIucmVmcmVzaCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgXCJ1c2Ugc3RyaWN0XCI7XHJcbiAgICBnZXRFbCgnbG9nUGFnZVNlbGVjdG9yJykuc2VsZWN0ZWRJbmRleCA9IDA7XHJcbiAgICBEQk1TLmdldExvZygwLCBMb2dWaWV3ZXIuZGF0YVJlY2lldmVkKTtcclxufTtcclxuXHJcbkxvZ1ZpZXdlci5kYXRhUmVjaWV2ZWQgPSBmdW5jdGlvbihlcnIsIGRhdGEpIHtcclxuICAgIFwidXNlIHN0cmljdFwiO1xyXG4gICAgaWYoZXJyKSB7VXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuO31cclxuICAgIFxyXG4gICAgdmFyIHNlbCA9IGdldEVsKCdsb2dQYWdlU2VsZWN0b3InKTtcclxuICAgIHZhciBzZWxlY3RlZEluZGV4ID0gc2VsLnNlbGVjdGVkSW5kZXg7XHJcbiAgICBjbGVhckVsKHNlbCk7XHJcblxyXG4gICAgdmFyIHNlbERhdGEgPSBbXTtcclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sb2dTaXplOyBpKyspIHtcclxuICAgICAgICBzZWxEYXRhLnB1c2goeyBuYW1lOiBpKzEsIHZhbHVlOiBTdHJpbmcoaSksIHNlbGVjdGVkOiBzZWxlY3RlZEluZGV4ID09IGkgfSk7XHJcbiAgICB9XHJcbiAgICBmaWxsU2VsZWN0b3Ioc2VsLCBzZWxEYXRhKTtcclxuICAgIFxyXG4gICAgdmFyIGNvbnRhaW5lciA9IGNsZWFyRWwoZ2V0RWwoJ2xvZ0RhdGEnKSk7XHJcbiAgICBcclxuICAgIFIuYXAoW2FkZEVsKGNvbnRhaW5lcildLCBkYXRhLnJlcXVlc3RlZExvZy5tYXAoTG9nVmlld2VyLm1ha2VSb3cpKTtcclxufTtcclxuXHJcbkxvZ1ZpZXdlci5tYWtlUm93ID0gZnVuY3Rpb24ocm93RGF0YSl7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuICAgIHZhciB0ciA9IG1ha2VFbCgndHInKTtcclxuICAgIHZhciBhZGRUZXh0ID0gZnVuY3Rpb24odGV4dCl7XHJcbiAgICAgICAgYWRkRWwodHIsIGFkZEVsKG1ha2VFbCgndGQnKSwgYWRkRWwobWFrZUVsKCdzcGFuJyksbWFrZVRleHQodGV4dCkpKSk7XHJcbiAgICB9XHJcbiAgICBhZGRUZXh0KHJvd0RhdGFbMF0pO1xyXG4gICAgYWRkVGV4dChuZXcgRGF0ZShyb3dEYXRhWzJdKS5mb3JtYXQoXCJ5eXl5L21tL2RkIEhIOk1NOnNzXCIpKTtcclxuICAgIGFkZFRleHQocm93RGF0YVsxXSk7XHJcbiAgICBhZGRUZXh0KHJvd0RhdGFbM10pO1xyXG4gICAgYWRkVGV4dChyb3dEYXRhWzRdKTtcclxuICAgIHJldHVybiB0cjtcclxufTsiLCIvKkNvcHlyaWdodCAyMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4vKmdsb2JhbFxyXG4gKi9cclxuXHJcblwidXNlIHN0cmljdFwiO1xyXG5cclxudmFyIExvZ1ZpZXdlcjIgPSB7fTtcclxuXHJcbkxvZ1ZpZXdlcjIuaW5pdCA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciByb290ID0gTG9nVmlld2VyMjtcclxuICAgIHJvb3Qudmlld3MgPSB7fTtcclxuICAgIHZhciBuYXYgPSBcIi5sb2ctdmlld2VyMi10YWIgLnN1Yi10YWItbmF2aWdhdGlvblwiO1xyXG4gICAgdmFyIGNvbnRlbnQgPSBcIi5sb2ctdmlld2VyMi10YWIgLnN1Yi10YWItY29udGVudFwiO1xyXG4gICAgdmFyIGNvbnRhaW5lcnMgPSB7XHJcbiAgICAgICAgcm9vdDogcm9vdCxcclxuICAgICAgICBuYXZpZ2F0aW9uOiBxdWVyeUVsKG5hdiksXHJcbiAgICAgICAgY29udGVudDogcXVlcnlFbChjb250ZW50KVxyXG4gICAgfTtcclxuICAgIFV0aWxzLmFkZFZpZXcoY29udGFpbmVycywgXCJsb2dWaWV3ZXJcIiwgTG9nVmlld2VyLHttYWluUGFnZTp0cnVlfSk7XHJcbiAgICBVdGlscy5hZGRWaWV3KGNvbnRhaW5lcnMsIFwiYWJvdXRcIiwgQWJvdXQpO1xyXG5cclxuICAgIExvZ1ZpZXdlcjIuY29udGVudCA9IHF1ZXJ5RWwoXCIubG9nLXZpZXdlcjItdGFiXCIpO1xyXG59O1xyXG5cclxuTG9nVmlld2VyMi5yZWZyZXNoID0gZnVuY3Rpb24gKCkge1xyXG4gICAgTG9nVmlld2VyMi5jdXJyZW50Vmlldy5yZWZyZXNoKCk7XHJcbn07Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
